<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monkey Task Tracker üêí D&D</title>
    <style>
        /* --- Root Variables (Same) --- */
        :root {
            --primary-bg: #fdf8e1; --secondary-bg: #ffffff; --text-color: #4d4030;
            --accent-color: #ffb400; --accent-darker: #e8a200; --border-color: #e0d4b9;
            --completed-color: #9e8a70; --delete-color: #e74c3c; --delete-hover-color: #c0392b;
            --add-class-color: #2ecc71; --add-class-hover: #27ae60; --input-bg: #fff;
            --light-text: #ffffff; --dark-text: #1a1a1a; --calendar-header-bg: #fff8e1;
            --calendar-day-border: #eee; --calendar-today-bg: #fffde7; --calendar-other-month: #f5f5f5;
            --drag-placeholder-color: #e0e0e0; /* Color for drop placeholder */
        }

        /* --- Base Styles (Mostly Same) --- */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; padding: 20px; background-color: var(--primary-bg); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 850px; margin: 20px auto; background-color: var(--secondary-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: var(--accent-color); text-align: center; margin-bottom: 25px; font-weight: 600; }
        h1 { font-size: 2em; }
        h2 { font-size: 1.6rem; margin-top: 35px; color: var(--text-color); border-bottom: 2px solid var(--secondary-bg); }

        /* --- Class Management (Same) --- */
        .class-management { margin-bottom: 35px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color); }
        .class-management h2 { text-align: left; margin-bottom: 20px; font-size: 1.4rem; border-bottom: none; }
        .add-class-form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
        .add-class-form input[type="text"] { flex: 1 1 200px; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; background-color: var(--input-bg); }
        .add-class-form input[type="color"] { padding: 0; border: 1px solid var(--border-color); border-radius: 4px; width: 40px; height: 40px; cursor: pointer; background-color: transparent; vertical-align: middle; }
        .add-class-form input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
        .add-class-form input[type="color"]::-webkit-color-swatch { border: none; border-radius: 3px; }
        .add-class-form button { padding: 10px 15px; background-color: var(--add-class-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.2s ease; flex-shrink: 0; height: 40px; }
        .add-class-form button:hover { background-color: var(--add-class-hover); }
        .class-list-display ul { list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto; background-color: #fcfcfc; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; }
        .class-list-display li { padding: 5px 8px; color: var(--text-color); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed var(--border-color); }
        .class-list-display li:last-child { border-bottom: none; }
        .class-list-display .class-info { display: flex; align-items: center; gap: 8px; }
        .class-list-display .color-swatch { display: inline-block; width: 16px; height: 16px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.2); vertical-align: middle; }
        .class-list-display .delete-class-btn { background: none; border: none; color: var(--delete-color); cursor: pointer; font-size: 1.2em; padding: 0 5px; opacity: 0.6; transition: opacity 0.2s ease; }
        .class-list-display .delete-class-btn:hover { opacity: 1; color: var(--delete-hover-color); }
        .class-list-display p { font-style: italic; color: #888; margin-top: 8px; font-size: 0.9em; }

        /* --- Assignment Input Form (Same) --- */
        .input-form { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 35px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color); }
        .input-form input[type="text"], .input-form input[type="date"], .input-form select { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; flex-grow: 1; background-color: var(--input-bg); min-width: 140px; height: 40px; }
        .input-form input[type="text"]#assignment-text { flex-basis: 300px; }
        .input-form select { cursor: pointer; }
        .input-form button { padding: 0 20px; background-color: var(--accent-color); color: var(--dark-text); border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.2s ease; flex-shrink: 0; height: 40px; font-weight: 500; }
        .input-form button:hover { background-color: var(--accent-darker); }

        /* --- View Toggle (Same) --- */
        .view-toggle { text-align: center; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .view-toggle button { background-color: #f0f0f0; color: var(--text-color); border: 1px solid var(--border-color); padding: 8px 15px; margin: 0 5px; border-radius: 6px; cursor: pointer; font-size: 0.95em; opacity: 0.7; }
        .view-toggle button.active { background-color: var(--accent-color); color: var(--dark-text); border-color: var(--accent-darker); opacity: 1; font-weight: 500; }
        .view-toggle button:hover:not(.active) { background-color: #e0e0e0; }

        /* --- Assignment Display Area (List View) --- */
        #assignment-list-view { margin-top: 25px; }
        #calendar-view { display: none; } /* Hide calendar by default */

        #assignment-list-view h2 { text-align: left; font-size: 1.4rem; margin-bottom: 15px; border-bottom: none;}
        .class-group {
            margin-bottom: 25px; border: none; border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            /* Added for drag-over indication */
            transition: border 0.2s ease;
            border: 2px dashed transparent; /* Placeholder for drop indicator */
        }
        .class-group.drag-over-class {
             border-color: var(--accent-color); /* Indicate valid drop zone for class */
             background-color: #fffaf0;
        }

        .class-group h3 {
             padding: 12px 18px; margin: 0; font-size: 1.25rem; font-weight: 600;
             transition: background-color 0.3s ease, color 0.3s ease;
             cursor: grab; /* Indicate draggable */
         }
        .class-group h3:active { cursor: grabbing; } /* Feedback during drag */

        .assignment-list { list-style: none; padding: 0; margin: 0; background-color: var(--secondary-bg); }
        .assignment-item {
            display: flex; align-items: center; padding: 12px 18px; border-bottom: 1px solid #eee;
            gap: 12px; flex-wrap: nowrap; overflow: hidden;
            cursor: grab; /* Indicate draggable items */
            transition: background-color 0.2s ease, opacity 0.2s ease;
            background-color: var(--secondary-bg); /* Default bg */
        }
         .assignment-item:active { cursor: grabbing; }
        .assignment-item:last-child { border-bottom: none; }
        .assignment-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; accent-color: var(--accent-color); }
        .assignment-item .assignment-details { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .assignment-item .assignment-text { font-size: 1rem; word-break: break-word; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color); }
        .assignment-item .assignment-due-date { font-size: 0.85rem; color: #777; margin-top: 3px; }
        .assignment-item.completed { /* Styles applied when completed */ }
        .assignment-item.completed .assignment-text, .assignment-item.completed .assignment-due-date { text-decoration: line-through; color: var(--completed-color); opacity: 0.8; }
        .assignment-item .delete-btn { background-color: transparent; color: var(--delete-color); border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.3rem; cursor: pointer; margin-left: auto; transition: background-color 0.2s ease, color 0.2s ease; flex-shrink: 0; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; }
        .assignment-item .delete-btn:hover { background-color: #ffeeee; color: var(--delete-hover-color); }
        .empty-message { text-align: center; color: #999; padding: 30px; background-color: #f9f9f9; border: 1px dashed var(--border-color); border-radius: 6px; margin-top: 20px; font-size: 1.1em; }

        /* --- Drag & Drop Styles --- */
        .dragging {
             opacity: 0.5; /* Make dragged item semi-transparent */
             border: 2px dashed var(--accent-color);
         }
         .drag-over-item {
             /* Visual cue for dropping ABOVE this item */
             border-top: 3px solid var(--accent-darker) !important; /* Use !important cautiously */
             background-color: #fff8e1 !important; /* Light yellow highlight */
         }
         /* Style for the class header when dragging an assignment over it (optional) */
         .class-group h3.drag-over-header {
              background-color: #e3f2fd !important; /* Light blue highlight */
         }


        /* --- Calendar View Styles (Same as previous) --- */
        #calendar-view { margin-top: 25px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--calendar-header-bg); border-bottom: 1px solid var(--border-color); border-radius: 6px 6px 0 0; }
        .calendar-header button { background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-color); padding: 5px 10px; }
        .calendar-header button:hover { color: var(--accent-color); }
        .calendar-header h2 { margin: 0; font-size: 1.3em; color: var(--text-color); border-bottom: none; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); background-color: #f8f8f8; text-align: center; font-weight: 500; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9em; color: #555; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 6px 6px; }
        .calendar-day { min-height: 100px; padding: 8px; border-right: 1px solid var(--calendar-day-border); border-top: 1px solid var(--calendar-day-border); position: relative; background-color: var(--secondary-bg); display: flex; flex-direction: column; }
        .calendar-day:nth-child(7n) { border-right: none; }
        .calendar-day:nth-child(n+8) { border-top: 1px solid var(--calendar-day-border); }
        .calendar-day:nth-child(-n+7) { border-top: none; }
        .calendar-day.other-month .date-number { opacity: 0.4; color: #999; }
        .calendar-day.today { background-color: var(--calendar-today-bg); font-weight: bold; }
        .date-number { font-size: 0.9em; margin-bottom: 5px; text-align: right; color: #333; }
        .today .date-number { color: var(--accent-color); font-weight: bold; }
        .calendar-assignments { list-style: none; padding: 0; margin: 0; font-size: 0.75em; flex-grow: 1; overflow-y: auto; max-height: 70px; }
        .calendar-assignments li { padding: 2px 4px; margin-bottom: 3px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: default; border-left: 3px solid; }
        .calendar-assignments li.completed { text-decoration: line-through; opacity: 0.7; }

        /* Responsive (Mostly Same) */
        @media (max-width: 700px) { /* ... */ }
        @media (max-width: 480px) { /* ... */ }

    </style>
</head>
<body>

    <div class="container">
        <h1>üêí Monkey Task Tracker</h1>

        <!-- Class Management (Same HTML) -->
        <div class="class-management">
            <h2>Manage Classes</h2>
            <div class="add-class-form">
                <input type="text" id="new-class-name" placeholder="New class name..." required>
                <input type="color" id="new-class-color" value="#a8d8ea" title="Choose class color">
                <button id="add-class-btn">Add Class</button>
            </div>
            <div class="class-list-display">
                 <p>Your Classes (Click üóëÔ∏è to remove):</p>
                 <ul id="class-list"></ul>
            </div>
        </div>

        <!-- Add Assignment (Same HTML) -->
        <h2>Add Assignment</h2>
        <div class="input-form">
            <input type="text" id="assignment-text" placeholder="Assignment description..." required>
            <select id="assignment-class-select" required>
                <option value="" disabled selected>-- Select Class --</option>
            </select>
            <input type="date" id="assignment-due-date" title="Due Date">
            <button id="add-assignment-btn">Add Task</button>
        </div>

        <!-- View Toggle (Same HTML) -->
        <h2>View Assignments</h2>
        <div class="view-toggle">
            <button id="view-list-btn" class="active">List View</button>
            <button id="view-calendar-btn">Calendar View</button>
        </div>

        <!-- Assignment Display Area (List View) - container for class groups -->
        <div id="assignment-list-view">
            <!-- Groups added here by JS -->
            <p class="empty-message">Woohoo! No tasks left. Time for a banana break! üçåüêí</p>
        </div>

        <!-- Calendar Display Area (Same HTML) -->
        <div id="calendar-view">
            <div class="calendar-header">
                <button id="prev-month-btn"><</button>
                <h2 id="calendar-month-year">Month Year</h2>
                 <span>üêí</span>
                <button id="next-month-btn">></button>
            </div>
            <div class="calendar-weekdays">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        // (Existing elements...)
        const newClassNameInput = document.getElementById('new-class-name');
        const newClassColorInput = document.getElementById('new-class-color');
        const addClassBtn = document.getElementById('add-class-btn');
        const classListUl = document.getElementById('class-list');
        const assignmentTextInput = document.getElementById('assignment-text');
        const assignmentClassSelect = document.getElementById('assignment-class-select');
        const assignmentDueDateInput = document.getElementById('assignment-due-date');
        const addAssignmentBtn = document.getElementById('add-assignment-btn');
        const viewListBtn = document.getElementById('view-list-btn');
        const viewCalendarBtn = document.getElementById('view-calendar-btn');
        const assignmentListView = document.getElementById('assignment-list-view'); // Container for list view
        const calendarView = document.getElementById('calendar-view');
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');

        // --- State ---
        // Classes: { id: number, name: string, color: string, order: number }
        // Assignments: { id: number, text: string, class: string, dueDate: string|null, completed: boolean, order: number|null }
        let classes = [];
        let assignments = [];
        let currentView = 'list';
        let calendarDate = new Date();
        let draggedElement = null; // Track the element being dragged

        // --- Constants ---
        const CLASSES_STORAGE_KEY = 'monkeyHomeworkClasses_v3'; // Updated key for order property
        const ASSIGNMENTS_STORAGE_KEY = 'monkeyHomeworkAssignments_v2'; // Updated key for order property
        const DEFAULT_CLASS_COLOR = '#a8d8ea';
        const MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- Utility Functions ---
        function getTextColorForBackground(hexcolor) { /* ... (same) ... */ if (!hexcolor || hexcolor.length < 4) return '--dark-text'; if (hexcolor.length === 4) hexcolor = '#' + hexcolor[1].repeat(2) + hexcolor[2].repeat(2) + hexcolor[3].repeat(2); try { const r = parseInt(hexcolor.substring(1, 3), 16); const g = parseInt(hexcolor.substring(3, 5), 16); const b = parseInt(hexcolor.substring(5, 7), 16); const lum = (0.299*r + 0.587*g + 0.114*b) / 255; return lum > 0.5 ? '--dark-text' : '--light-text'; } catch (e) { return '--dark-text'; } }
         // Helper to get the element to drop *before* during assignment drag
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.assignment-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
                } else {
                return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
         }
          // Helper to get the element to drop *before* during class drag
         function getDragAfterClassElement(container, y) {
             const draggableElements = [...container.querySelectorAll('.class-group:not(.dragging-class-group)')]; // Use a specific class
             return draggableElements.reduce((closest, child) => {
                 const box = child.getBoundingClientRect();
                 const offset = y - box.top - box.height / 2;
                 if (offset < 0 && offset > closest.offset) {
                     return { offset: offset, element: child };
                 } else {
                     return closest;
                 }
             }, { offset: Number.NEGATIVE_INFINITY }).element;
         }


        // --- Class Management ---
        function loadClasses() {
             const storedClasses = localStorage.getItem(CLASSES_STORAGE_KEY);
             let parsedClasses = [];
             if (storedClasses) { try { parsedClasses = JSON.parse(storedClasses); if (!Array.isArray(parsedClasses)) parsedClasses = []; else { let maxOrder = -1; parsedClasses = parsedClasses.map((c, index) => { const order = (c.order !== undefined && c.order !== null) ? c.order : index; if(order > maxOrder) maxOrder = order; return { id: c.id || Date.now() + Math.random(), name: c.name || 'Unnamed', color: c.color || DEFAULT_CLASS_COLOR, order: order }; }); /* Ensure subsequent items get unique order if needed */ } } catch(e) { parsedClasses = []; } }
             classes = parsedClasses;
             // Ensure orders are sequential if loaded data is messy (optional but good)
             normalizeClassOrder();
        }
         function normalizeClassOrder() {
             classes.sort((a, b) => (a.order ?? Infinity) - (b.order ?? Infinity) || a.name.localeCompare(b.name));
             classes.forEach((c, index) => c.order = index);
             saveClasses();
         }
        function saveClasses() { localStorage.setItem(CLASSES_STORAGE_KEY, JSON.stringify(classes)); }
        function renderClassList() { /* ... (same as previous) ... */
             classListUl.innerHTML = '';
            if (classes.length === 0) { classListUl.innerHTML = '<li style="font-style: italic; color: #888;">No classes added yet.</li>'; return; }
            [...classes].sort((a, b) => a.name.localeCompare(b.name)).forEach(classObj => {
                const li = document.createElement('li');
                const classInfoSpan = document.createElement('span'); classInfoSpan.className = 'class-info';
                const swatch = document.createElement('span'); swatch.className = 'color-swatch'; swatch.style.backgroundColor = classObj.color; classInfoSpan.appendChild(swatch);
                const nameSpan = document.createElement('span'); nameSpan.textContent = classObj.name; classInfoSpan.appendChild(nameSpan);
                const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-class-btn'; deleteBtn.innerHTML = 'üóëÔ∏è'; deleteBtn.title = `Delete class "${classObj.name}"`; deleteBtn.onclick = () => deleteClass(classObj.id);
                li.appendChild(classInfoSpan); li.appendChild(deleteBtn); classListUl.appendChild(li);
            });
        }
        function populateClassDropdown() { /* ... (same) ... */
             const currentSelection = assignmentClassSelect.value; assignmentClassSelect.innerHTML = '';
            const defaultOption = document.createElement('option'); defaultOption.value = ""; defaultOption.textContent = "-- Select Class --"; defaultOption.disabled = true; defaultOption.selected = true; assignmentClassSelect.appendChild(defaultOption);
            [...classes].sort((a, b) => a.name.localeCompare(b.name)).forEach(classObj => { const option = document.createElement('option'); option.value = classObj.name; option.textContent = classObj.name; if (classObj.name === currentSelection) { option.selected = true; defaultOption.selected = false; } assignmentClassSelect.appendChild(option); });
        }
        function addNewClass() {
             const className = newClassNameInput.value.trim(); const classColor = newClassColorInput.value;
             if (className === '') { alert('Please enter a class name.'); newClassNameInput.focus(); return; }
             if (classes.some(c => c.name.toLowerCase() === className.toLowerCase())) { alert(`Class "${className}" already exists.`); return; }
             const newClass = { id: Date.now(), name: className, color: classColor, order: classes.length }; // Assign next order
             classes.push(newClass); saveClasses(); renderClassList(); populateClassDropdown();
             newClassNameInput.value = ''; newClassColorInput.value = DEFAULT_CLASS_COLOR; newClassNameInput.focus();
             render(); // Update main view if needed
        }
         function deleteClass(id) { /* ... (same, calls main render) ... */
             const classToDelete = classes.find(c => c.id === id); if (!classToDelete) return;
             const assignmentsUsingClass = assignments.filter(a => a.class === classToDelete.name).length;
             let confirmMsg = `Are you sure you want to delete class "${classToDelete.name}"?`; if (assignmentsUsingClass > 0) confirmMsg += `\n${assignmentsUsingClass} assignment(s) use this class.`;
             if (!confirm(confirmMsg)) return;
             classes = classes.filter(c => c.id !== id); normalizeClassOrder(); /* Re-normalize order after deletion */ saveClasses(); renderClassList(); populateClassDropdown(); render();
         }

        // --- Assignment Management ---
        function loadAssignments() {
            const storedAssignments = localStorage.getItem(ASSIGNMENTS_STORAGE_KEY);
            assignments = storedAssignments ? JSON.parse(storedAssignments) : [];
            if (!Array.isArray(assignments)) assignments = [];
             // Initialize order if missing (null indicates default sort)
             assignments.forEach(a => {
                 if (a.order === undefined) {
                     a.order = null;
                 }
             });
        }
        function saveAssignments() { localStorage.setItem(ASSIGNMENTS_STORAGE_KEY, JSON.stringify(assignments)); }
        function formatDate(dateString) { /* ... (same) ... */ if (!dateString) return 'N/A'; try { const date = new Date(Date.parse(dateString + 'T00:00:00')); if (isNaN(date.getTime())) throw new Error('Invalid date'); return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); } catch (e) { return dateString; } }
        function addAssignment() {
             const text = assignmentTextInput.value.trim(); const selectedClass = assignmentClassSelect.value; const dueDate = assignmentDueDateInput.value;
             if (text === '') { alert('Need description.'); assignmentTextInput.focus(); return; } if (selectedClass === '') { alert('Need class.'); assignmentClassSelect.focus(); return; }
             const newAssignment = { id: Date.now(), text: text, class: selectedClass, dueDate: dueDate || null, completed: false, order: null }; // New assignments use default order
             assignments.push(newAssignment); saveAssignments(); render();
             assignmentTextInput.value = ''; assignmentClassSelect.selectedIndex = 0; assignmentDueDateInput.value = ''; assignmentTextInput.focus();
        }
        function toggleComplete(id) { /* ... (same) ... */ const assignmentIndex = assignments.findIndex(a => a.id === id); if (assignmentIndex > -1) { assignments[assignmentIndex].completed = !assignments[assignmentIndex].completed; saveAssignments(); render(); } }
        function deleteAssignment(id) { /* ... (same) ... */ if (confirm('Delete this assignment?')) { assignments = assignments.filter(a => a.id !== id); saveAssignments(); render(); } }

        // --- List View Rendering with Drag & Drop ---
        function renderAssignmentsList() {
            assignmentListView.innerHTML = ''; // Clear list view

            if (assignments.length === 0 && classes.length === 0) { // Check if both are empty
                 assignmentListView.innerHTML = '<p class="empty-message">Add a class and then some tasks! üêí</p>';
                 return;
            } else if (assignments.length === 0) {
                 assignmentListView.innerHTML = '<p class="empty-message">No assignments yet for your classes. Go bananas! üçå</p>';
                 // Still show empty class groups if needed, handled below
             }

            // 1. Group assignments by class name
            const groupedAssignments = assignments.reduce((acc, assignment) => {
                const className = assignment.class || 'Uncategorized';
                if (!acc[className]) acc[className] = [];
                acc[className].push(assignment);
                return acc;
            }, {});

            // 2. Get all class names (including those with no assignments) and sort them by stored order
            const allClassNames = [...new Set([...classes.map(c => c.name), ...Object.keys(groupedAssignments)])];
             const sortedClassNames = allClassNames.sort((nameA, nameB) => {
                 const classA = classes.find(c => c.name === nameA);
                 const classB = classes.find(c => c.name === nameB);
                 const orderA = classA ? classA.order : Infinity; // Put uncategorized/deleted last
                 const orderB = classB ? classB.order : Infinity;
                 return orderA - orderB || nameA.localeCompare(nameB); // Sort by order, then name
             });


            // 3. Create HTML for each group in the determined order
            sortedClassNames.forEach(className => {
                const classGroupDiv = document.createElement('div');
                classGroupDiv.className = 'class-group';
                 classGroupDiv.dataset.className = className; // Identifier for class drag/drop

                // Find class object for styling
                const classObj = classes.find(c => c.name === className);
                const bgColor = classObj ? classObj.color : '#e0e0e0';
                const textColorVar = getTextColorForBackground(bgColor);

                const classHeader = document.createElement('h3');
                classHeader.textContent = className;
                classHeader.style.backgroundColor = bgColor;
                classHeader.style.color = `var(${textColorVar})`;
                 classHeader.draggable = true; // Make header draggable
                 classHeader.addEventListener('dragstart', handleClassDragStart);
                 classHeader.addEventListener('dragend', handleClassDragEnd);
                 // Add dragover listener to header as well, for dropping assignments onto it (optional)
                 // classHeader.addEventListener('dragover', handleAssignmentDragOverHeader);
                 // classHeader.addEventListener('dragleave', handleAssignmentDragLeaveHeader);

                classGroupDiv.appendChild(classHeader);

                const assignmentListUl = document.createElement('ul');
                assignmentListUl.className = 'assignment-list';
                 // Add listeners to UL for dropping assignments
                 assignmentListUl.addEventListener('dragover', handleAssignmentDragOver);
                 assignmentListUl.addEventListener('dragleave', handleAssignmentDragLeave);
                 assignmentListUl.addEventListener('drop', handleAssignmentDrop);


                const assignmentsInGroup = groupedAssignments[className] || [];

                // 4. Sort assignments within the group: Custom Order first, then Due Date
                 assignmentsInGroup.sort((a, b) => {
                     // Prioritize custom order if both have it
                     if (a.order !== null && b.order !== null) {
                         return a.order - b.order;
                     }
                     // Put items with custom order before those without
                     if (a.order !== null) return -1;
                     if (b.order !== null) return 1;

                     // Fallback to due date sort (same as before)
                     const dateA = a.dueDate ? new Date(a.dueDate) : null;
                     const dateB = b.dueDate ? new Date(b.dueDate) : null;
                     if (dateA === null && dateB === null) return 0; // Keep relative order if no dates
                     if (dateA === null) return 1; // No date goes last
                     if (dateB === null) return -1;
                     return dateA - dateB; // Earliest date first
                 });

                // 5. Create list items for assignments
                if (assignmentsInGroup.length > 0) {
                    assignmentsInGroup.forEach(assignment => {
                        const listItem = document.createElement('li');
                        listItem.className = 'assignment-item';
                        listItem.dataset.assignmentId = assignment.id; // ID for drag/drop
                        listItem.draggable = true; // Make assignment draggable
                        if (assignment.completed) listItem.classList.add('completed');

                        // Add drag listeners for assignments
                        listItem.addEventListener('dragstart', handleAssignmentDragStart);
                        listItem.addEventListener('dragend', handleAssignmentDragEnd);

                        // (Checkbox, Details, Delete Button - same HTML structure)
                        const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.checked = assignment.completed; checkbox.addEventListener('change', () => toggleComplete(assignment.id));
                        const detailsDiv = document.createElement('div'); detailsDiv.className = 'assignment-details';
                        const textSpan = document.createElement('span'); textSpan.className = 'assignment-text'; textSpan.textContent = assignment.text; detailsDiv.appendChild(textSpan);
                        const dueDateSpan = document.createElement('span'); dueDateSpan.className = 'assignment-due-date'; dueDateSpan.textContent = assignment.dueDate ? `Due: ${formatDate(assignment.dueDate)}` : 'No due date'; detailsDiv.appendChild(dueDateSpan);
                        const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = 'Ôóë'; deleteBtn.title = 'Delete assignment'; deleteBtn.addEventListener('click', () => deleteAssignment(assignment.id));

                        listItem.appendChild(checkbox); listItem.appendChild(detailsDiv); listItem.appendChild(deleteBtn);
                        assignmentListUl.appendChild(listItem);
                    });
                } else {
                     // Optionally add a message if a class exists but has no assignments
                     // assignmentListUl.innerHTML = '<li style="padding: 10px; font-style: italic; color: #888;">No assignments for this class.</li>';
                 }

                classGroupDiv.appendChild(assignmentListUl);
                assignmentListView.appendChild(classGroupDiv);
            });

             // Add drag listeners to the main container for class dropping
            assignmentListView.addEventListener('dragover', handleClassDragOver);
            assignmentListView.addEventListener('drop', handleClassDrop);
            // assignmentListView.addEventListener('dragleave', handleClassDragLeave); // Might not be needed on main container

        }

        // --- Calendar View Rendering (Same as previous) ---
        function renderCalendar() { /* ... (same) ... */
             calendarGrid.innerHTML = '';
             const year = calendarDate.getFullYear(); const month = calendarDate.getMonth();
             calendarMonthYear.textContent = `${MONTH_NAMES[month]} ${year}`;
             const firstDayOfMonth = new Date(year, month, 1); const lastDayOfMonth = new Date(year, month + 1, 0);
             const daysInMonth = lastDayOfMonth.getDate(); const startDayOfWeek = firstDayOfMonth.getDay();
             const today = new Date(); const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
             const assignmentsByDate = assignments.reduce((acc, assign) => { if (assign.dueDate) { if (!acc[assign.dueDate]) acc[assign.dueDate] = []; acc[assign.dueDate].push(assign); } return acc; }, {});
             for (let i = 0; i < startDayOfWeek; i++) { const padCell = document.createElement('div'); padCell.classList.add('calendar-day', 'other-month'); calendarGrid.appendChild(padCell); }
             for (let day = 1; day <= daysInMonth; day++) {
                 const dayCell = document.createElement('div'); dayCell.classList.add('calendar-day');
                 const dateNum = document.createElement('div'); dateNum.classList.add('date-number'); dateNum.textContent = day; dayCell.appendChild(dateNum);
                 const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                 if (dateString === todayString) dayCell.classList.add('today');
                 if (assignmentsByDate[dateString]) {
                     const assignmentsList = document.createElement('ul'); assignmentsList.classList.add('calendar-assignments');
                     assignmentsByDate[dateString].forEach(assign => { const li = document.createElement('li'); const classObj = classes.find(c => c.name === assign.class); li.textContent = assign.text; li.style.borderLeftColor = classObj ? classObj.color : '#ccc'; li.title = `${assign.class}: ${assign.text}`; if (assign.completed) li.classList.add('completed'); assignmentsList.appendChild(li); });
                     dayCell.appendChild(assignmentsList);
                 }
                 calendarGrid.appendChild(dayCell);
             }
            const totalCells = startDayOfWeek + daysInMonth; const remainingCells = (7 - (totalCells % 7)) % 7;
             for (let i = 0; i < remainingCells; i++) { const padCell = document.createElement('div'); padCell.classList.add('calendar-day', 'other-month'); calendarGrid.appendChild(padCell); }
        }

        // --- Main Rendering Function ---
        function render() { /* ... (same logic, calls renderAssignmentsList or renderCalendar) ... */
             renderClassList(); populateClassDropdown();
             if (currentView === 'list') { assignmentListView.style.display = 'block'; calendarView.style.display = 'none'; viewListBtn.classList.add('active'); viewCalendarBtn.classList.remove('active'); renderAssignmentsList(); }
             else { assignmentListView.style.display = 'none'; calendarView.style.display = 'block'; viewListBtn.classList.remove('active'); viewCalendarBtn.classList.add('active'); renderCalendar(); }
        }

         // --- Drag and Drop Handlers ---

         // == Class Dragging ==
         function handleClassDragStart(e) {
             draggedElement = e.target.closest('.class-group'); // Get the whole group
             if (!draggedElement) return;
             e.dataTransfer.setData('text/plain', draggedElement.dataset.className);
             e.dataTransfer.effectAllowed = 'move';
             // Use setTimeout to allow the browser to render the drag image before applying class
             setTimeout(() => {
                 draggedElement.classList.add('dragging');
                 draggedElement.classList.add('dragging-class-group'); // Specific class marker
             }, 0);
              console.log("Class drag start:", draggedElement.dataset.className);
         }

         function handleClassDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'move';

             const container = assignmentListView; // Drop zone for classes
             const afterElement = getDragAfterClassElement(container, e.clientY);
             const draggingGroup = document.querySelector('.dragging-class-group'); // Find the element being dragged

            // Remove existing placeholders/highlights
            container.querySelectorAll('.class-group').forEach(group => group.classList.remove('drag-over-class'));

             if (afterElement) {
                // Don't highlight if dropping before itself
                 if (draggingGroup !== afterElement) {
                    afterElement.classList.add('drag-over-class'); // Highlight element being dropped *before*
                 }
            } else {
                 // If no element after, means dropping at the end, maybe highlight container?
                 // Or highlight the last element if dragging downwards? Needs refinement.
             }
         }

         // function handleClassDragLeave(e) { } // Optional: remove highlight if leaving container

         function handleClassDrop(e) {
            e.preventDefault();
            const draggedClassName = e.dataTransfer.getData('text/plain');
            const container = assignmentListView;
            container.querySelectorAll('.class-group').forEach(group => group.classList.remove('drag-over-class')); // Clean up highlight

            const afterElement = getDragAfterClassElement(container, e.clientY);
            const targetClassName = afterElement ? afterElement.dataset.className : null; // Class to insert before

             console.log(`Class drop: Dragged ${draggedClassName}, Target Before: ${targetClassName}`);

             if (draggedClassName) {
                 updateClassOrder(draggedClassName, targetClassName);
             }
             draggedElement = null; // Clear dragged element ref
         }

         function handleClassDragEnd(e) {
             // Use querySelectorAll in case the element reference was lost
             document.querySelectorAll('.class-group').forEach(el => {
                el.classList.remove('dragging');
                 el.classList.remove('dragging-class-group');
                 el.classList.remove('drag-over-class');
             });
              draggedElement = null;
              console.log("Class drag end");
         }

         function updateClassOrder(draggedName, targetName) {
            const draggedIndex = classes.findIndex(c => c.name === draggedName);
             if (draggedIndex === -1) return; // Should not happen

             const draggedClass = classes.splice(draggedIndex, 1)[0]; // Remove dragged item

             if (targetName === null) {
                 // Dropped at the end
                 classes.push(draggedClass);
             } else {
                 // Dropped before target
                 const targetIndex = classes.findIndex(c => c.name === targetName);
                 if (targetIndex !== -1) {
                     classes.splice(targetIndex, 0, draggedClass); // Insert at target index
                 } else {
                      classes.push(draggedClass); // Fallback: add to end if target not found
                 }
             }

             // Re-assign sequential order numbers
             classes.forEach((c, index) => c.order = index);

             saveClasses();
             render(); // Re-render the list view
         }


         // == Assignment Dragging ==
         function handleAssignmentDragStart(e) {
             draggedElement = e.target.closest('.assignment-item');
             if(!draggedElement) return;
             e.dataTransfer.setData('text/plain', draggedElement.dataset.assignmentId);
             e.dataTransfer.effectAllowed = 'move';
              setTimeout(() => draggedElement.classList.add('dragging'), 0); // Style dragging item
              console.log("Assign drag start:", draggedElement.dataset.assignmentId);
         }

         function handleAssignmentDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const container = e.target.closest('.assignment-list');
            if (!container) return;

             const afterElement = getDragAfterElement(container, e.clientY);

            // Clear previous indicators
            container.querySelectorAll('.assignment-item').forEach(item => item.classList.remove('drag-over-item'));

            if (afterElement) {
                afterElement.classList.add('drag-over-item'); // Highlight item being dropped before
            } else {
                 // Optionally indicate dropping at the end (e.g., border on container)
                 // container.style.borderBottom = '3px solid var(--accent-darker)';
            }
         }

         function handleAssignmentDragLeave(e) {
            const container = e.target.closest('.assignment-list');
            if(container) {
                 container.querySelectorAll('.assignment-item').forEach(item => item.classList.remove('drag-over-item'));
                 // container.style.borderBottom = ''; // Clear end-drop indicator if used
             }
         }

        function handleAssignmentDrop(e) {
             e.preventDefault();
             const container = e.target.closest('.assignment-list');
             const classGroupElement = container ? container.closest('.class-group') : null;
             if (!container || !classGroupElement) { if(draggedElement) handleAssignmentDragEnd(); return; } // Invalid drop target

             container.querySelectorAll('.assignment-item').forEach(item => item.classList.remove('drag-over-item')); // Clear indicator
             // container.style.borderBottom = '';

             const draggedId = parseInt(e.dataTransfer.getData('text/plain'));
             const afterElement = getDragAfterElement(container, e.clientY);
             const targetId = afterElement ? parseInt(afterElement.dataset.assignmentId) : null; // ID to insert before
             const targetClassName = classGroupElement.dataset.className;

             console.log(`Assign drop: Dragged ${draggedId}, Target Before: ${targetId} in Class: ${targetClassName}`);


             if (!isNaN(draggedId)) {
                 updateAssignmentOrder(draggedId, targetId, targetClassName);
             }
              draggedElement = null;
         }

         function handleAssignmentDragEnd(e) {
             // Use querySelectorAll as draggedElement might be nullified
             document.querySelectorAll('.assignment-item').forEach(el => el.classList.remove('dragging', 'drag-over-item'));
             draggedElement = null; // Ensure cleanup
              console.log("Assign drag end");
         }

        function updateAssignmentOrder(draggedId, targetId, targetClassName) {
             const draggedAssignment = assignments.find(a => a.id === draggedId);
             if (!draggedAssignment) return;

             // Filter assignments for the target class
             const assignmentsInClass = assignments.filter(a => (a.class || 'Uncategorized') === targetClassName);

             // Remove the dragged item temporarily
             const draggedItemIndexInClass = assignmentsInClass.findIndex(a => a.id === draggedId);
             if (draggedItemIndexInClass > -1) {
                 assignmentsInClass.splice(draggedItemIndexInClass, 1);
             } else {
                  // Item dragged from another class? For now, we only allow reorder within the same class.
                  // If we wanted to allow moving classes, we'd update draggedAssignment.class here.
                  console.warn("Dragged assignment not found in target class list - reorder within class only.");
                  render(); // Just re-render to reset state
                  return;
             }


             if (targetId === null) {
                 // Dropped at the end of the list
                 assignmentsInClass.push(draggedAssignment);
             } else {
                 // Dropped before the target item
                 const targetIndexInClass = assignmentsInClass.findIndex(a => a.id === targetId);
                 if (targetIndexInClass !== -1) {
                     assignmentsInClass.splice(targetIndexInClass, 0, draggedAssignment);
                 } else {
                     assignmentsInClass.push(draggedAssignment); // Fallback add to end
                 }
             }

             // Re-assign sequential order *within this class group*, nullifying others
             let currentOrder = 0;
             assignments.forEach(a => {
                 if ((a.class || 'Uncategorized') === targetClassName) {
                     const indexInSorted = assignmentsInClass.findIndex(item => item.id === a.id);
                     if (indexInSorted > -1) {
                        a.order = indexInSorted; // Assign new order based on visual position
                     } else {
                          a.order = null; // Should not happen if logic is correct
                     }
                 }
                 // Ensure assignments NOT in this class retain their potential custom order or null
             });


             saveAssignments();
             render(); // Re-render list view
         }


        // --- Event Listeners ---
        // (Class/Assignment Add/Toggle/Delete listeners - same as before)
        addClassBtn.addEventListener('click', addNewClass); newClassNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewClass(); }); newClassColorInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewClass(); });
        addAssignmentBtn.addEventListener('click', addAssignment); [assignmentTextInput, assignmentDueDateInput].forEach(input => { input.addEventListener('keypress', (e) => { if (e.key === 'Enter') { if (assignmentTextInput.value.trim() !== '' && assignmentClassSelect.value !== '') addAssignment(); else if (assignmentTextInput.value.trim() === '') { alert('Need description'); assignmentTextInput.focus();} else { alert('Need class'); assignmentClassSelect.focus();} } }); });
        // Note: Toggle/Delete listeners are added dynamically during render

        // View Toggle Listeners (same)
        viewListBtn.addEventListener('click', () => { currentView = 'list'; render(); });
        viewCalendarBtn.addEventListener('click', () => { currentView = 'calendar'; render(); });

        // Calendar Navigation Listeners (same)
        prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadClasses();
            loadAssignments();
            render(); // Initial render
        });

    </script>

</body>
</html>