<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêí Monkey Planner</title>
    <script src="https://unpkg.com/@heroicons/core"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-bg: #fdf8e1;
            --secondary-bg: #ffffff;
            --text-color: #4d4030;
            --accent-color: #ffb400;
            --accent-darker: #e8a200;
            --border-color: #e0d4b9;
            --completed-color: #9e8a70;
            --delete-color: #e74c3c;
            --delete-hover-color: #c0392b;
            --add-class-color: #2ecc71;
            --add-class-hover: #27ae60;
            --input-bg: #fff;
            --light-text: #ffffff;
            --dark-text: #1a1a1a;
            --calendar-header-bg: #fff8e1;
            --calendar-day-border: #eee;
            --calendar-today-bg: #fffde7;
            --calendar-other-month: #f5f5f5;
            --drag-placeholder-color: #e0e0e0;

            --priority-high: #e74c3c;
            --priority-medium: #f1c40f;
            --priority-low: #3498db;
            --status-todo: #3498db;
            --status-inprogress: #f39e12;
            --status-completed: #2ecc71;
            --course-status-planned: #6c757d;
            --course-status-inprogress: #007bff;
            --course-status-completed: #28a745;


            --input-focus-border: var(--accent-color);
            --subtle-shadow: 0 2px 5px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.08);
            --body-overlay-color: rgba(0,0,0,0.1);

            --custom-primary-bg: var(--primary-bg);
            --custom-secondary-bg: var(--secondary-bg);
            --custom-accent-color: var(--accent-color);
            --custom-text-color: var(--text-color);
            --custom-font-family: 'Inter', sans-serif;
        }

        body.dark {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2c2c2c;
            --text-color: #e0e0e0;
            --accent-color: #ffb400;
            --accent-darker: #e8a200;
            --border-color: #555555;
            --completed-color: #9e8a70;
            --delete-color: #e74c3c;
            --delete-hover-color: #c0392b;
            --add-class-color: #2ecc71;
            --add-class-hover: #27ae60;
            --input-bg: #3a3a3a;
            --calendar-header-bg: #3a3a3a;
            --calendar-day-border: #555555;
            --calendar-today-bg: #4a4a4a;
            --calendar-other-month: #222222;
            --input-focus-border: var(--accent-color);
            --subtle-shadow: 0 2px 5px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.15);
            --body-overlay-color: rgba(0,0,0,0.3);

            --course-status-planned: #a6a6a6;
            --course-status-inprogress: #6fa8dc;
            --course-status-completed: #6aa84f;

            --custom-primary-bg: var(--primary-bg);
            --custom-secondary-bg: var(--secondary-bg);
            --custom-accent-color: var(--accent-color);
            --custom-text-color: var(--text-color);
        }

        body {
            font-family: var(--custom-font-family);
            margin: 0;
            padding: 0;
            background-color: var(--custom-primary-bg);
            color: var(--custom-text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease, font-family 0.3s ease;
        }

        .layout { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: var(--custom-secondary-bg); padding: 20px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: space-between; transition: width 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; box-sizing: border-box; }
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; transition: padding 0.3s ease; box-sizing: border-box;}

        /* --- Layout Density Modifiers --- */
        body.compact .sidebar { padding: 10px; }
        body.compact .sidebar li { padding: 8px 12px; }
        body.compact .main-content { padding: 15px; }
        body.compact h2 { margin-bottom: 15px; margin-top: 25px; font-size: 1.5rem; }
        body.compact .class-list-display li { padding: 6px 10px; }
        body.compact .assignment-item { padding: 8px 12px; gap: 8px; }
        body.compact .modal-content { padding: 20px; }
        body.compact .planner-tabs button, body.compact .settings-tabs button, body.compact .gpa-selector-tab button { padding: 8px 15px; font-size: 0.9em; }
        body.compact .add-planner-course-form { gap: 10px; margin-bottom: 20px; padding-bottom: 15px; }
        body.compact .year-section h3 { padding: 10px 15px; font-size: 1.4em; }
        body.compact .semester-section { padding: 10px 15px; }
        body.compact .planner-course-item { padding: 8px 0;}
        body.compact .input-form, body.compact .quick-add-section { margin-bottom: 25px; padding-bottom: 15px;}
        body.compact .filter-sort-bar { margin-bottom: 15px; padding-bottom: 8px; }
        body.compact .sidebar h1 { font-size: 1.6em; }

        body.spacious .sidebar { padding: 30px; }
        body.spacious .sidebar li { padding: 12px 18px; }
        body.spacious .main-content { padding: 40px; }
        body.spacious h2 { margin-bottom: 35px; margin-top: 45px; font-size: 1.8rem;}
        body.spacious .class-list-display li { padding: 10px 15px; }
        body.spacious .assignment-item { padding: 15px 20px; gap: 15px; }
        body.spacious .modal-content { padding: 35px; }
        body.spacious .planner-tabs button, body.spacious .settings-tabs button, body.spacious .gpa-selector-tab button { padding: 12px 25px; font-size: 1.05em; }
        body.spacious .add-planner-course-form { gap: 20px; margin-bottom: 40px; padding-bottom: 30px; }
        body.spacious .year-section h3 { padding: 20px 25px; font-size: 1.7em; }
        body.spacious .semester-section { padding: 20px 25px; }
        body.spacious .planner-course-item { padding: 12px 0;}
        body.spacious .input-form, body.spacious .quick-add-section { margin-bottom: 45px; padding-bottom: 35px;}
        body.spacious .filter-sort-bar { margin-bottom: 30px; padding-bottom: 20px; }
        body.spacious .sidebar h1 { font-size: 2.2em; }

        /* --- Sidebar Navigation --- */
        .sidebar h1 { color: var(--custom-accent-color); font-weight: 700; margin-bottom: 1.5rem; text-align: center; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar li {
            padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; border-radius: 6px;
            transition: background-color 0.2s ease, color 0.2s ease, font-weight 0.2s ease;
            color: var(--custom-text-color);
            font-weight: 500;
        }
        .sidebar li:hover { background-color: color-mix(in srgb, var(--border-color) 80%, transparent); }
        .sidebar li.active { background-color: var(--custom-accent-color); color: var(--dark-text); font-weight: 600; }
        .sidebar li svg { width: 20px; height: 20px; fill: currentColor; }

        /* Theme Toggle */
        .theme-toggle { margin-top: auto; display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px 15px; margin: 0 -15px; border-radius: 6px; transition: background-color 0.2s ease, color 0.2s ease; color: var(--custom-text-color); }
        .theme-toggle:hover { background-color: color-mix(in srgb, var(--border-color) 80%, transparent); }
        .theme-toggle svg { width: 20px; height: 20px; fill: currentColor; }
        .dark-icon { display: none; }
        body.dark .dark-icon { display: block; }
        body.dark .light-icon { display: none; }

        /* --- Headers --- */
        h1, h2 { color: var(--custom-accent-color); text-align: center; margin-bottom: 25px; font-weight: 600; transition: color 0.3s ease; }
        h1 { font-size: 2em; }
        h2 { font-size: 1.6rem; margin-top: 35px; color: var(--custom-text-color); border-bottom: 2px solid var(--border-color); padding-bottom: 5px; text-align: left; transition: color 0.3s ease, border-color 0.3s ease; }

        /* --- Class Management --- */
        .class-management { margin-bottom: 35px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s ease; }
        .class-management h2 { margin-bottom: 20px; font-size: 1.4rem; border-bottom: none; }
        .add-class-form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
        .add-class-form input[type="text"], .add-class-form textarea,
        .input-form input[type="text"], .input-form input[type="date"], .input-form select, .input-form textarea,
        .modal-form-group input:not([type="color"]):not([type="checkbox"]):not([type="radio"]),
        .modal-form-group select, .modal-form-group textarea,
        .quick-add-section input,
        .filter-sort-bar input:not([type="checkbox"]), .filter-sort-bar select,
        .add-planner-course-form input:not([type="checkbox"]):not([type="radio"]), .add-planner-course-form select,
        .final-predictor-form input:not([type="checkbox"]):not([type="radio"]),
        .customization-option input:not([type="color"]):not([type="checkbox"]):not([type="radio"]),
        .customization-option select,
        .grading-policy-setting-group input:not([type="checkbox"]):not([type="radio"]) {
            flex: 1 1 200px; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px;
            font-size: 1rem; background-color: var(--input-bg); transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
            color: var(--custom-text-color);
            box-sizing: border-box;
            height: 40px; /* Standardize input height */
        }
        .add-class-form textarea, .modal-form-group textarea, .details-notes { height: auto; min-height: 40px; }


        .add-class-form input[type="text"]:focus, .add-class-form textarea:focus,
        .input-form input:focus, .input-form select:focus,
        .modal-form-group input:focus, .modal-form-group select:focus, .modal-form-group textarea:focus,
        .quick-add-section input:focus,
        .filter-sort-bar input:focus, .filter-sort-bar select:focus,
        .planner-course-details-form input:focus, .planner-course-details-form select:focus,
        .planner-grade-inputs input:focus, .planner-grade-inputs select:focus,
        .final-predictor-form input:focus,
        .customization-option input:focus, .customization-option select:focus,
        .grading-policy-setting-group input:focus {
             outline: none; border-color: var(--input-focus-border); box-shadow: 0 0 0 3px color-mix(in srgb, var(--input-focus-border) 20%, transparent);
         }

        .add-class-form input[type="color"] { padding: 0; border: 1px solid var(--border-color); border-radius: 4px; width: 40px; height: 40px; cursor: pointer; background-color: transparent; vertical-align: middle; transition: border-color 0.2s ease; }
        .add-class-form input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
        .add-class-form input[type="color"]::-webkit-color-swatch { border: none; border-radius: 3px; }
        .add-class-form button,
        .input-form button,
        .bg-upload-label, .data-settings button, .planner-course-grades-modal .modal-buttons .save-btn { padding: 10px 15px; background-color: var(--add-class-color); color: var(--light-text); border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.2s ease; flex-shrink: 0; height: 40px; font-weight: 500; }
        .add-class-form button:hover,
        .input-form button:hover,
        .bg-upload-label:hover, .data-settings button:hover, .planner-course-grades-modal .modal-buttons .save-btn:hover { background-color: var(--add-class-hover); }
        .planner-course-grades-modal .modal-buttons .cancel-btn { background-color: #ccc; color: var(--dark-text); }


        .class-list-display ul { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; background-color: var(--custom-secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--subtle-shadow); transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; }
        .class-list-display li { padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--calendar-day-border); transition: background-color 0.2s ease, border-color 0.2s ease; }
        .class-list-display li:hover { background-color: var(--primary-bg); }
        .class-list-display li:last-child { border-bottom: none; }
        .class-list-display .class-info { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px 0; flex-grow: 1; color: var(--custom-text-color); }
        .class-list-display .color-swatch { display: inline-block; width: 16px; height: 16px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.2); vertical-align: middle; }
        .class-list-display .class-actions { display: flex; gap: 5px; }
        .class-list-display .class-action-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0 5px; opacity: 0.6; transition: opacity 0.2s ease, color 0.2s ease; }
        .class-list-display .delete-class-btn { color: var(--delete-color); }
        .class-list-display .edit-class-btn { color: var(--custom-accent-color); }
        .class-list-display .archive-class-btn { color: var(--completed-color); }
        .class-list-display .class-action-btn:hover { opacity: 1; }
        .class-list-display .delete-class-btn:hover { background-color: color-mix(in srgb, var(--delete-color) 15%, transparent); }
        .class-list-display .edit-class-btn:hover { background-color: color-mix(in srgb, var(--custom-accent-color) 15%, transparent); }
        .class-list-display p { font-style: italic; color: var(--completed-color); margin-top: 8px; font-size: 0.9em; transition: color 0.3s ease; }

        .input-form { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 35px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s ease; }
        .input-form input[type="text"]#assignment-text { flex-basis: 300px; }
        .input-form select { cursor: pointer; }
        .input-form button { background-color: var(--custom-accent-color); color: var(--dark-text); }
        .input-form button:hover { background-color: var(--accent-darker); }

        .view-toggle { text-align: center; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; transition: border-color 0.3s ease; }
        .view-toggle button { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 8px 15px; margin: 0 5px; border-radius: 6px; cursor: pointer; font-size: 0.95em; opacity: 0.8; transition: all 0.2s ease; }
        .view-toggle button.active { background-color: var(--custom-accent-color); color: var(--dark-text); border-color: var(--accent-darker); opacity: 1; font-weight: 500; }
        .view-toggle button:hover:not(.active) { background-color: color-mix(in srgb, var(--border-color) 80%, transparent); opacity: 0.9; }

        .filter-sort-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s ease; }
        .filter-sort-bar select, .filter-sort-bar input[type="text"] { flex-grow: 1; min-width: 120px; max-width: 200px; height: 38px; }
        .filter-sort-bar label { white-space: nowrap; margin-left: 10px; color: var(--custom-text-color); font-size: 0.9em; }
        .filter-sort-bar input[type="checkbox"] {
            margin-right: 5px;
            transform: scale(1.1);
            accent-color: var(--custom-accent-color);
            width: 16px; height: 16px;
            vertical-align: middle;
            flex-shrink: 0;
        }

        .quick-add-section { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s ease; }
        .quick-add-section input { flex-grow: 1; }
        .quick-add-section button { flex-shrink: 0; }


        #assignment-list-view, #archived-view, #academic-planner-view { margin-top: 25px; }
        #calendar-view, #settings-view, #archived-view, #quick-add-container, #academic-planner-view { display: none; }

        #assignment-list-view h2 { margin-bottom: 15px; border-bottom: none;}
        .class-group {
            margin-bottom: 25px; border: none; border-radius: 8px; overflow: hidden;
            box-shadow: var(--subtle-shadow);
            transition: border 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
            border: 2px dashed transparent;
        }
        .class-group.drag-over-class {
             border-color: var(--custom-accent-color);
             background-color: color-mix(in srgb, var(--custom-primary-bg) 50%, transparent);
        }
        .class-group.drag-over-end {
             border-bottom: 3px solid var(--custom-accent-color);
        }


        .class-group h3 {
             padding: 12px 18px; margin: 0; font-size: 1.25rem; font-weight: 600;
             transition: background-color 0.3s ease, color 0.3s ease;
             cursor: grab;
             display: flex; justify-content: space-between; align-items: center;
             user-select: none;
         }
        .class-group h3:active { cursor: grabbing; }

        .assignment-list { list-style: none; padding: 0; margin: 0; background-color: var(--custom-secondary-bg); transition: background-color 0.3s ease; }
        .assignment-item {
            display: flex; align-items: center; padding: 12px 18px; border-bottom: 1px solid var(--calendar-day-border);
            gap: 12px; flex-wrap: nowrap; overflow: hidden;
            cursor: grab;
            transition: background-color 0.2s ease, opacity 0.2s ease, border-color 0.2s ease;
            background-color: var(--custom-secondary-bg);
            position: relative;
        }
        .assignment-item:active { cursor: grabbing; }
        .assignment-item:last-child { border-bottom: none; }
        .assignment-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; accent-color: var(--custom-accent-color); }
        .assignment-item .assignment-details { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; cursor: pointer; }
        .assignment-item .assignment-text { font-size: 1rem; word-break: break-word; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--custom-text-color); }
        .assignment-item .assignment-sub-info { display: flex; align-items: center; margin-top: 3px; gap: 5px; flex-wrap: wrap; }
        .assignment-item .assignment-due-date { font-size: 0.85rem; color: #777; transition: color 0.3s ease; }
        .assignment-item .assignment-due-date span.overdue { color: var(--delete-color); font-weight: bold; }

        .assignment-item .assignment-priority, .assignment-item .assignment-status, .assignment-item .assignment-type {
            font-size: 0.75rem; font-weight: 600; padding: 2px 6px; border-radius: 4px;
            color: var(--light-text); display: inline-block; white-space: nowrap;
        }
        .assignment-item .assignment-priority[data-priority="High"] { background-color: var(--priority-high); }
        .assignment-item .assignment-priority[data-priority="Medium"] { background-color: var(--priority-medium); }
        .assignment-item .assignment-priority[data-priority="Low"] { background-color: var(--priority-low); }

        .assignment-item .assignment-status[data-status="To Do"] { background-color: var(--status-todo); }
        .assignment-item .assignment-status[data-status="In Progress"] { background-color: var(--status-inprogress); }
        .assignment-item .assignment-status[data-status="Completed"] { background-color: var(--status-completed); }

        .assignment-item .assignment-type { background-color: #5b5b5b; }
        body.dark .assignment-item .assignment-type { background-color: #a0a0a0; color: var(--dark-text); }


        .assignment-item.completed { opacity: 0.7; }
        .assignment-item.completed .assignment-text, .assignment-item.completed .assignment-due-date,
        .assignment-item.completed .assignment-type, .assignment-item.completed .assignment-priority,
        .assignment-item.completed .assignment-status { text-decoration: line-through; color: var(--completed-color); opacity: 0.8; }
        .assignment-item.completed .assignment-type, .assignment-item.completed .assignment-priority, .assignment-item.completed .assignment-status { background-color: var(--completed-color); }
        .assignment-item .actions-container { display: flex; align-items: center; gap: 5px; }
        .assignment-item .task-action-btn { background-color: transparent; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.3rem; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; flex-shrink: 0; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; opacity: 0.7;}
        .assignment-item .task-action-btn:hover { opacity: 1; }
        .assignment-item .delete-btn { color: var(--delete-color); }
        .assignment-item .delete-btn:hover { background-color: color-mix(in srgb, var(--delete-color) 15%, transparent); }
        .assignment-item .edit-btn { color: var(--custom-accent-color); }
        .assignment-item .edit-btn:hover { background-color: color-mix(in srgb, var(--custom-accent-color) 15%, transparent); }

        .dragging {
             opacity: 0.5;
             border: 2px dashed var(--custom-accent-color);
         }
         .drag-over-item {
             border-top: 3px solid var(--accent-darker) !important;
             background-color: color-mix(in srgb, var(--primary-bg) 70%, transparent) !important;
         }
         .drag-over-item-end {
             border-bottom: 3px solid var(--accent-darker) !important;
             background-color: color-mix(in srgb, var(--primary-bg) 70%, transparent) !important;
         }
         .class-group h3.drag-over-header {
              background-color: color-mix(in srgb, var(--custom-accent-color) 20%, transparent) !important;
         }


        #calendar-view { margin-top: 25px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--calendar-header-bg); border-bottom: 1px solid var(--border-color); border-radius: 8px 8px 0 0; box-shadow: var(--subtle-shadow); transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; }
        .calendar-header button { background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--custom-text-color); padding: 5px 10px; transition: color 0.2s ease; }
        .calendar-header button:hover { color: var(--custom-accent-color); }
        .calendar-header h2 { margin: 0; font-size: 1.3em; color: var(--custom-text-color); border-bottom: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; box-shadow: var(--subtle-shadow); transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); background-color: color-mix(in srgb, var(--calendar-header-bg) 80%, var(--secondary-bg)); text-align: center; font-weight: 500; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9em; color: var(--text-color); transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }
        .calendar-day { min-height: 100px; padding: 8px; border-right: 1px solid var(--calendar-day-border); border-top: 1px solid var(--calendar-day-border); position: relative; background-color: var(--custom-secondary-bg); display: flex; flex-direction: column; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .calendar-day:nth-child(7n) { border-right: none; }
        .calendar-day:nth-child(n+8) { border-top: 1px solid var(--calendar-day-border); }
        .calendar-day:nth-child(-n+7) { border-top: none; }
        .calendar-day.other-month { background-color: var(--calendar-other-month); opacity: 0.6; }
        .calendar-day.other-month .date-number { color: #999; }
        .calendar-day.today { background-color: var(--calendar-today-bg); font-weight: bold; }
        .date-number { font-size: 0.9em; margin-bottom: 5px; text-align: right; color: var(--text-color); transition: color 0.3s ease; }
        .today .date-number { color: var(--custom-accent-color); font-weight: bold; }
        .calendar-assignments { list-style: none; padding: 0; margin: 0; font-size: 0.75em; flex-grow: 1; overflow-y: auto; max-height: 70px; }
        .calendar-assignments li { padding: 2px 4px; margin-bottom: 3px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; border-left: 3px solid; transition: background-color 0.2s ease; color: var(--custom-text-color); }
        .calendar-assignments li:hover { background-color: color-mix(in srgb, var(--border-color) 80%, transparent); }
        .calendar-assignments li.completed { text-decoration: line-through; opacity: 0.7; }


        .background-settings { margin-bottom: 35px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s ease; }
        .background-settings h2, .stats-section h2, .data-settings h2, .customization-section h3, .grading-settings h3 { text-align: left; margin-bottom: 20px; font-size: 1.4rem; border-bottom: none; }
        .bg-options { display: none; }
        .bg-upload input[type="file"] { display: none; }
        .bg-upload-label { display: inline-block; padding: 10px 15px; background-color: var(--add-class-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.2s ease; }
        .bg-upload-label:hover { background-color: var(--add-class-hover); }
        body.has-background {
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: transparent;
        }
        body.has-background::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--body-overlay-color);
            z-index: -1;
            transition: background-color 0.3s ease;
        }
        body.has-background .main-content {
            background-color: color-mix(in srgb, var(--custom-secondary-bg) 95%, transparent);
            border-radius: 8px;
            padding: 30px;
            transition: background-color 0.3s ease;
        }

        .settings-tabs {
            display: flex; justify-content: center; margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-tabs button {
            background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color);
            border-bottom: none; padding: 10px 20px; margin: 0 2px; border-radius: 8px 8px 0 0;
            cursor: pointer; font-size: 0.95em; opacity: 0.8; transition: all 0.2s ease;
        }
        .settings-tabs button.active {
            background-color: var(--custom-secondary-bg); color: var(--custom-accent-color);
            border-color: var(--accent-darker); opacity: 1; font-weight: 500;
        }
        .settings-tabs button:hover:not(.active) { background-color: color-mix(in srgb, var(--border-color) 80%, transparent); opacity: 0.9; }
        .settings-content-area {
            background-color: var(--custom-secondary-bg); padding: 25px; border-radius: 8px;
            box-shadow: var(--subtle-shadow);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .settings-section-divider { border-bottom: 1px dashed var(--border-color); padding-bottom: 20px; margin-bottom: 20px; transition: border-color 0.3s ease; }


        .data-settings { margin-bottom: 35px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color); }
        .data-settings button { background-color: var(--custom-accent-color); color: var(--dark-text); margin-right: 10px;}
        .data-settings button:hover { background-color: var(--accent-darker); }

        .customization-option { margin-bottom: 20px; }
        .customization-option label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--custom-text-color); }
        .customization-option input[type="color"] { width: 80px; height: 35px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; vertical-align: middle; }
        .customization-option input[type="radio"], .customization-option input[type="checkbox"] { margin-right: 5px; transform: scale(1.1); accent-color: var(--custom-accent-color); width: 16px; height: 16px; }
        .customization-option .color-picker-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: center;}
        .customization-option .color-picker-group label { display: inline-block; margin-bottom: 0; font-weight: normal; font-size: 0.9em; }

        .grading-policy-setting-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;}
        .grading-policy-setting-group > div { flex: 1 1 calc(50% - 10px); min-width: 120px;}
        .grading-policy-setting-group input { width: 100%;}
        .grading-settings .button-group { margin-top: 15px;}
        .grading-settings .button-group button { background-color: var(--custom-accent-color); color: var(--dark-text); }


        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--custom-secondary-bg);
            padding: 25px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto;
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }
        .modal-close-btn {
            position: absolute; top: 10px; right: 10px;
            background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--custom-text-color);
            transition: color 0.2s ease;
        }
        .modal-close-btn:hover { color: var(--delete-color); }
        .modal-content h3 { font-size: 1.4em; color: var(--custom-accent-color); margin-bottom: 20px; }
        .modal-form-group { margin-bottom: 15px; }
        .modal-form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--custom-text-color); }
        .modal-buttons { text-align: right; margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 1rem; }
        .modal-buttons .save-btn { background-color: var(--custom-accent-color); color: var(--dark-text); }
        .modal-buttons .cancel-btn { background-color: #ccc; color: var(--dark-text); }
        .modal-buttons .save-btn:hover { background-color: var(--accent-darker); }
        .modal-buttons .cancel-btn:hover { background-color: #bbb; }

        .subtasks-list { list-style: none; padding: 0; margin: 10px 0 0; }
        .subtasks-list li { display: flex; align-items: center; gap: 8px; padding: 5px 0; border-bottom: 1px dashed var(--border-color); }
        .subtasks-list li:last-child { border-bottom: none; }
        .subtasks-list li input[type="checkbox"] { flex-shrink: 0; }
        .subtasks-list li input[type="text"] { flex-grow: 1; border: none; background: transparent; padding: 5px; color: var(--custom-text-color); }
        .subtasks-list li input[type="text"]:focus { outline: none; border-bottom: 1px solid var(--accent-color); }
        .subtasks-list li button { background: none; border: none; color: var(--delete-color); cursor: pointer; font-size: 1.2em; opacity: 0.6; }
        .subtasks-list li button:hover { opacity: 1; }
        .add-subtask-form { display: flex; gap: 10px; margin-top: 10px; }
        .add-subtask-form input { flex-grow: 1; height: 38px !important; }
        .add-subtask-form button { height: 38px !important; }

        #toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 1100;
            display: flex; flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: var(--dark-text); color: var(--light-text);
            padding: 12px 20px; border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0; transform: translateX(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            min-width: 250px;
            max-width: 350px;
            display: flex; align-items: center; gap: 10px;
            word-break: break-word;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: var(--add-class-color); }
        .toast.error { background-color: var(--delete-color); }
        .toast.info { background-color: #3498db; }
        .toast svg { width: 20px; height: 20px; flex-shrink: 0; fill: currentColor; }


        .planner-tabs {
            display: flex; justify-content: center; margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .planner-tabs button {
            background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color);
            border-bottom: none; padding: 10px 20px; margin: 0 2px; border-radius: 8px 8px 0 0;
            cursor: pointer; font-size: 0.95em; opacity: 0.8; transition: all 0.2s ease;
        }
        .planner-tabs button.active {
            background-color: var(--custom-secondary-bg); color: var(--custom-accent-color);
            border-color: var(--accent-darker); opacity: 1; font-weight: 500;
        }
        .planner-tabs button:hover:not(.active) { background-color: color-mix(in srgb, var(--border-color) 80%, transparent); opacity: 0.9; }
        .planner-content-area {
            background-color: var(--custom-secondary-bg); padding: 25px; border-radius: 8px;
            box-shadow: var(--subtle-shadow);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .add-planner-course-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s ease; }
        .add-planner-course-form label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.95em; color: var(--custom-text-color); }
        .add-planner-course-form button { grid-column: 1 / -1; width: auto; justify-self: center; padding: 10px 30px; background-color: var(--add-class-color); color: var(--light-text); border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease; }
        .add-planner-course-form button:hover { background-color: var(--add-class-hover); }

        .year-section { margin-bottom: 30px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; box-shadow: var(--subtle-shadow); transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .year-section h3 { background-color: var(--calendar-header-bg); padding: 15px 20px; margin: 0; font-size: 1.5em; color: var(--custom-accent-color); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .year-section .year-gpa { font-size: 0.8em; font-weight: normal; margin-left: 10px; color: var(--custom-text-color); opacity: 0.8;}
        .semester-section { margin: 0; padding: 15px 20px; background-color: var(--custom-secondary-bg); border-top: 1px dashed var(--calendar-day-border); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .semester-section:first-of-type { border-top: none; }
        .semester-section h4 { font-size: 1.1em; color: var(--custom-text-color); margin: 0 0 10px 0; border-bottom: 1px solid var(--calendar-day-border); padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; transition: color 0.3s ease, border-color 0.3s ease; }
        .semester-section .semester-gpa { font-size: 0.9em; font-weight: normal; margin-left: 10px; opacity: 0.8;}

        .planner-course-list { list-style: none; padding: 0; margin: 0; }
        .planner-course-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--calendar-day-border); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease;}
        .planner-course-item:hover { background-color: var(--primary-bg); }
        .planner-course-item:last-child { border-bottom: none; }
        .planner-course-item .course-info { display: flex; flex-direction: column; flex-grow: 1; }
        .planner-course-item .course-name { font-weight: 600; color: var(--custom-text-color); }
        .planner-course-item .course-details { font-size: 0.85em; color: #777; display: flex; gap: 8px; flex-wrap: wrap; }
        .planner-course-item .course-level { background-color: var(--custom-accent-color); color: var(--dark-text); padding: 2px 6px; border-radius: 3px; font-size: 0.7em; white-space: nowrap; }
        .planner-course-item .course-grade { font-weight: bold; font-size: 1.1em; margin-left: 10px; color: var(--custom-text-color); }
        .planner-course-item .course-status { background-color: var(--course-status-planned); color: var(--light-text); padding: 2px 6px; border-radius: 3px; font-size: 0.7em; white-space: nowrap;}
        .planner-course-item .course-status[data-status="Planned"] { background-color: var(--course-status-planned); }
        .planner-course-item .course-status[data-status="In Progress"] { background-color: var(--course-status-inprogress); }
        .planner-course-item .course-status[data-status="Completed"] { background-color: var(--course-status-completed); }


        .planner-course-item .course-actions button { background: none; border: none; font-size: 1em; cursor: pointer; opacity: 0.6; transition: opacity 0.2s ease; color: var(--custom-text-color); }
        .planner-course-item .course-actions button:hover { opacity: 1; }
        .planner-course-item .delete-course-btn { color: var(--delete-color); }


        .planner-course-grades-modal .modal-content { max-width: 600px; }
        .grade-format-selector { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: center;}
        .grade-format-selector label { font-weight: 500; color: var(--custom-text-color);}
        .grade-format-selector input[type="radio"] { margin-right: 5px;}
        .planner-grade-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .planner-grade-inputs label { font-size: 0.9em; }
        .grade-component { display: flex; flex-direction: column; }
        .grade-component .grade-override-toggle { margin-top: 10px; }
        .planner-calculated-grade { margin-top: 20px; padding: 10px; background-color: var(--calendar-today-bg); border-radius: 6px; font-weight: bold; color: var(--custom-text-color); transition: background-color 0.3s ease, color 0.3s ease; }
        .grade-info-overlay {
            font-size: 0.85em; color: #777; margin-top: 5px; background-color: color-mix(in srgb, var(--calendar-day-border) 50%, transparent); padding: 5px 8px; border-radius: 4px; transition: background-color 0.3s ease, color 0.3s ease;
        }

        .planner-gpa-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .gpa-card { background-color: var(--custom-secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; box-shadow: var(--subtle-shadow); text-align: center; transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; }
        .gpa-card h4 { margin-top: 0; color: var(--custom-accent-color); font-size: 1.2em; }
        .gpa-card p { margin: 5px 0; font-size: 0.9em; color: var(--custom-text-color); }
        .gpa-card .gpa-value { font-size: 2.5em; font-weight: bold; color: var(--custom-accent-color); line-height: 1; }
        .gpa-selector-tab {
            display: flex; justify-content: center; margin-bottom: 20px;
        }
        .gpa-selector-tab button {
            background-color: var(--input-bg); color: var(--custom-text-color); border: 1px solid var(--border-color);
            padding: 8px 15px; margin: 0 5px; border-radius: 6px; cursor: pointer; font-size: 0.95em;
            opacity: 0.8; transition: all 0.2s ease;
        }
        .gpa-selector-tab button.active {
            background-color: var(--custom-accent-color); color: var(--dark-text);
            border-color: var(--accent-darker); opacity: 1; font-weight: 500;
        }
        .gpa-selector-tab button:hover:not(.active) { background-color: color-mix(in srgb, var(--border-color) 80%, transparent); opacity: 0.9; }

        .final-predictor-form { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .final-predictor-form input { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--custom-text-color); }
        .final-predictor-result { margin-top: 20px; padding: 15px; background-color: var(--calendar-today-bg); border-radius: 8px; font-size: 1.1em; font-weight: bold; color: var(--custom-text-color); transition: background-color 0.3s ease, color 0.3s ease; }
        .final-predictor-result span { color: var(--custom-accent-color); }

        .empty-message { text-align: center; margin: 40px auto; color: var(--completed-color); font-style: italic;}

        #loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.5em;
            flex-direction: column;
            gap: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #loading-overlay.show {
            opacity: 1;
            display: flex;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 700px) {
            .layout { flex-direction: column; }
            .sidebar {
                width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); flex-direction: row; justify-content: space-around; padding: 10px; height: auto;
                position: fixed;
                bottom: 0;
                left: 0;
                box-shadow: var(--subtle-shadow);
                z-index: 500;
                border-top: 1px solid var(--border-color);
                border-radius: 8px 8px 0 0;
            }
            .sidebar ul { display: flex; justify-content: space-around; width: 100%; flex-wrap: wrap; }
            .sidebar li { flex-direction: column; text-align: center; padding: 5px; font-size: 0.8em; min-width: 60px;}
            .sidebar li svg { width: 18px; height: 18px; }
            .sidebar h1 { display: none; }
            .theme-toggle { margin-top: 0; padding: 5px; margin: 0; display: none;}
            .main-content { padding: 20px; padding-bottom: 70px; }
            .filter-sort-bar { flex-direction: column; align-items: flex-start; }
            .filter-sort-bar select, .filter-sort-bar input:not([type="checkbox"]),
            .filter-sort-bar label {
                 width: 100%; max-width: 100%; margin-left: 0;
            }
             .filter-sort-bar label:not([for="hide-completed"]) { margin-top: 10px; }
             .filter-sort-bar #hide-completed + label { display: block; margin-top: 10px;}
            .add-planner-course-form { grid-template-columns: 1fr; }
            .planner-grade-inputs { grid-template-columns: 1fr; }
            .quick-add-section { flex-direction: column; }
            .quick-add-section input, .quick-add-section button { width: 100%; flex-shrink: 1; }

            .input-form { flex-direction: column; }
            .input-form input, .input-form select, .input-form button { width: 100%; min-width: unset; flex-basis: auto; }
            .input-form input[type="text"]#assignment-text { flex-basis: auto; }
            .grade-format-selector { flex-direction: column; align-items: flex-start; }
            .grade-format-selector label { margin-bottom: 0; margin-left: 0;}
            .customization-option .color-picker-group { flex-direction: column; align-items: flex-start;}
            .grading-policy-setting-group { flex-direction: column;}
            .settings-tabs { flex-wrap: wrap; }
            .settings-tabs button { flex: 1 1 45%; margin: 2px; }

            #toast-container { top: unset; bottom: 80px; left: 10px; right: 10px; flex-direction: column; max-width: unset; width: calc(100% - 20px);}
            .toast { width: 100%; }
        }
        @media (max-width: 480px) {
             .sidebar ul { flex-wrap: wrap; }
             .sidebar li { flex-basis: 30%; text-align: center; padding: 10px; }
             .add-class-form { flex-direction: column; }
             .add-class-form input, .add-class-form button { width: 100%; flex-basis: auto; }
        }

    </style>
</head>
<body>

    <div id="loading-overlay" class="loading-overlay" role="status" aria-live="polite">
        <div class="spinner"></div>
        <span>Loading...</span>
    </div>

    <div class="layout">
        <div class="sidebar">
            <div>
                <h1 class="text-xl font-bold mb-6">üêí Monkey Planner</h1>
                <ul>
                    <li id="nav-list" class="active" tabindex="0" role="link" aria-label="Tasks">
                        <heroicons-ui/check-list class="icon"/>
                        Tasks
                    </li>
                    <li id="nav-calendar" tabindex="0" role="link" aria-label="Calendar">
                        <heroicons-ui/calendar class="icon"/>
                        Calendar
                    </li>
                    <li id="nav-classes" tabindex="0" role="link" aria-label="Classes">
                        <heroicons-ui/tag class="icon"/>
                        Classes
                    </li>
                    <li id="nav-planner" tabindex="0" role="link" aria-label="Academic Planner">
                        <heroicons-ui/academic-cap class="icon"/>
                        Academic
                    </li>
                    <li id="nav-archived" tabindex="0" role="link" aria-label="Archived Items">
                        <heroicons-ui/archive class="icon"/>
                        Archived
                    </li>
                     <li id="nav-settings" tabindex="0" role="link" aria-label="Settings">
                        <heroicons-ui/cog class="icon"/>
                        Settings
                    </li>
                </ul>
            </div>
            <div id="theme-toggle" class="theme-toggle" role="button" aria-label="Toggle dark mode">
                <heroicons-ui/sun class="icon light-icon"/>
                <heroicons-ui/moon class="icon dark-icon"/>
                <span>Dark Mode</span>
            </div>
        </div>

        <div class="main-content">

            <div id="classes-view" class="class-management">
                <h2>Manage Classes</h2>
                <div class="add-class-form">
                    <input type="text" id="new-class-name" placeholder="New class name..." required aria-label="New class name">
                    <input type="color" id="new-class-color" value="#a8d8ea" title="Choose class color" aria-label="Choose class color">
                    <button id="add-class-btn" aria-label="Add class">Add Class</button>
                </div>
                <div class="class-list-display">
                     <p>Your Classes (Click class name to edit, or actions):</p>
                     <ul id="class-list" role="list"></ul>
                </div>
            </div>

            <div id="quick-add-container">
                 <h2>Quick Add Task</h2>
                 <div class="quick-add-section">
                     <input type="text" id="quick-add-text" placeholder="Quick task description..." aria-label="Quick task description">
                     <button id="quick-add-btn">Add</button>
                 </div>
            </div>


            <div id="add-assignment-form-container">
                <h2>Add New Assignment</h2>
                <div class="input-form">
                    <input type="text" id="assignment-text" placeholder="Assignment description..." required aria-label="Assignment description">
                    <select id="assignment-class-select" required aria-label="Select class">
                        <option value="" disabled selected>-- Select Class --</option>
                    </select>
                    <input type="date" id="assignment-due-date" title="Due Date" aria-label="Due Date">
                    <select id="assignment-priority-select" aria-label="Assignment priority">
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                        <option value="Low">Low</option>
                    </select>
                    <select id="assignment-status-select" aria-label="Assignment status">
                        <option value="To Do" selected>To Do</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                    </select>
                    <select id="assignment-type-select" aria-label="Assignment type">
                        <option value="Homework" selected>Homework</option>
                        <option value="Test">Test</option>
                        <option value="Project">Project</option>
                        <option value="Other">Other</option>
                    </select>
                    <button id="add-assignment-btn" aria-label="Add task">Add Task</button>
                </div>
            </div>

            <h2>View Assignments</h2>
            <div class="view-toggle">
                <button id="view-list-btn" class="active" aria-controls="assignment-list-view">List View</button>
                <button id="view-calendar-btn" aria-controls="calendar-view">Calendar View</button>
            </div>

            <div id="filter-sort-bar" class="filter-sort-bar">
                <input type="text" id="search-input" placeholder="Search tasks..." aria-label="Search tasks">

                <label for="sort-by">Sort By:</label>
                <select id="sort-by" aria-label="Sort assignments by">
                    <option value="priorityDueDate">Priority & Due Date</option>
                    <option value="custom">Custom Order</option>
                    <option value="dueDate">Due Date</option>
                    <option value="priority">Priority</option>
                    <option value="text">Text (A-Z)</option>
                    <option value="status">Status</option>
                    <option value="type">Type</option>
                </select>

                <label for="filter-status">Status:</label>
                <select id="filter-status" aria-label="Filter assignments by status">
                    <option value="all">All</option>
                    <option value="To Do">To Do</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                </select>

                <label for="filter-priority">Priority:</label>
                <select id="filter-priority" aria-label="Filter assignments by priority">
                    <option value="all">All</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>

                <label for="filter-type">Type:</label>
                <select id="filter-type" aria-label="Filter assignments by type">
                    <option value="all">All</option>
                    <option value="Homework">Homework</option>
                    <option value="Test">Test</option>
                    <option value="Project">Project</option>
                    <option value="Other">Other</option>
                </select>

                <input type="checkbox" id="hide-completed" aria-label="Hide completed tasks">
                <label for="hide-completed">Hide Completed</label>
            </div>


            <div id="assignment-list-view">
                <p class="empty-message">No tasks yet! Add a class and then some tasks, or simply add a quick task! üçå</p>
            </div>

            <div id="calendar-view">
                <div class="calendar-header">
                    <button id="prev-month-btn" aria-label="Previous month"><</button>
                    <h2 id="calendar-month-year">Month Year</h2>
                     <span>üêí</span>
                    <button id="next-month-btn" aria-label="Next month">></button>
                </div>
                <div class="calendar-weekdays">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-grid" id="calendar-grid" role="grid" aria-label="Monthly Calendar"></div>
            </div>

            <div id="academic-planner-view">
                <h2>Academic Planner</h2>
                <div class="planner-tabs" role="tablist">
                    <button id="planner-tab-plan" class="active" role="tab" aria-controls="planner-content-plan" aria-selected="true">4-Year Plan</button>
                    <button id="planner-tab-gpa" role="tab" aria-controls="planner-content-gpa" aria-selected="false">GPA Calculator</button>
                    <button id="planner-tab-predictor" role="tab" aria-controls="planner-content-predictor" aria-selected="false">Final Predictor</button>
                </div>

                <div id="planner-content-plan" class="planner-content-area" role="tabpanel" aria-labelledby="planner-tab-plan">
                    <h3>Add Course</h3>
                    <div class="add-planner-course-form">
                        <div>
                            <label for="new-course-name">Course Name:</label>
                            <input type="text" id="new-course-name" placeholder="e.g. Algebra I" required aria-label="Course Name">
                        </div>
                        <div>
                            <label for="new-course-year">Year:</label>
                            <select id="new-course-year" required aria-label="Academic Year">
                                <option value="" disabled selected>-- Select Year --</option>
                                <option value="9th Grade">9th Grade</option>
                                <option value="10th Grade">10th Grade</option>
                                <option value="11th Grade">11th Grade</option>
                                <option value="12th Grade">12th Grade</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-course-semester">Semester:</label>
                            <select id="new-course-semester" required aria-label="Semester">
                                <option value="" disabled selected>-- Select Semester --</option>
                                <option value="Fall">Fall</option>
                                <option value="Spring">Spring</option>
                                <option value="Full-Year">Full-Year</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-course-level">Level:</label>
                            <select id="new-course-level" required aria-label="Course Level">
                                <option value="Standard">Standard</option>
                                <option value="Honors">Honors</option>
                                <option value="AP">AP</option>
                                <option value="DE">DE</option>
                                <option value="IB">IB</option>
                            </select>
                        </div>
                         <div>
                            <label for="new-course-credits">Credits:</label>
                            <select id="new-course-credits" required aria-label="Course Credits">
                                <option value="1.0">1.0</option>
                                <option value="0.5">0.5</option>
                                <option value="0.25">0.25</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-course-subject">Subject Area:</label>
                            <input type="text" id="new-course-subject" placeholder="e.g. Math, English" required aria-label="Subject Area">
                        </div>
                        <button id="add-planner-course-btn" aria-label="Add course to plan">Add Course</button>
                    </div>

                    <h3>My 4-Year Plan</h3>
                    <div id="course-planner-display">
                         <p class="empty-message">No courses planned yet. Add one above! üéì</p>
                    </div>
                </div>

                <div id="planner-content-gpa" class="planner-content-area" style="display:none;" role="tabpanel" aria-labelledby="planner-tab-gpa">
                    <h3>Cumulative GPA</h3>
                    <div class="gpa-selector-tab" role="tablist">
                        <button id="gpa-type-unweighted" class="active" role="tab" aria-controls="gpa-metrics" aria-selected="true">Unweighted</button>
                        <button id="gpa-type-weighted" role="tab" aria-controls="gpa-metrics" aria-selected="false">Weighted (FCPS)</button>
                    </div>
                    <div class="gpa-card" id="gpa-metrics">
                        <h4>Total GPA</h4>
                        <p class="gpa-value" id="overall-gpa-display">0.00</p>
                        <p>Total Credits Earned: <span id="total-credits-display">0.00</span></p>
                    </div>
                    <h3 style="margin-top: 30px;">GPA By Year & Semester</h3>
                    <div id="gpa-by-year-semester-display">
                        <p class="empty-message">Add courses and grades to see your GPA here!</p>
                    </div>
                </div>

                <div id="planner-content-predictor" class="planner-content-area" style="display:none;" role="tabpanel" aria-labelledby="planner-tab-predictor">
                    <h3>Final Grade Predictor</h3>
                    <p>Calculate the score you need on your final exam.</p>
                    <div class="final-predictor-form">
                        <label for="current-average">Current Grade Average (e.g., 85 for Q1/Q2 avg):</label>
                        <input type="number" id="current-average" min="0" max="100" step="0.1" placeholder="Current Grade (%)" aria-label="Current grade percentage">

                        <label for="final-weight-percentage">Final Exam Weight (% of overall grade):</label>
                        <input type="number" id="final-weight-percentage" min="0" max="100" step="1" value="20" aria-label="Final exam weight percentage">

                        <label for="target-final-grade">Target Overall Grade (%):</label>
                        <input type="number" id="target-final-grade" min="0" max="100" step="0.1" value="90" aria-label="Target overall grade percentage">

                        <button id="calculate-final-btn" class="add-planner-course-btn" style="background-color: var(--custom-accent-color); color: var(--dark-text); justify-self: stretch;">Calculate Needed Final Score</button>
                    </div>
                    <div id="final-predictor-result" class="final-predictor-result" style="display:none;" role="status">
                        You need a <span>--</span> on your final exam to reach your target grade.
                    </div>
                </div>
            </div>

            <div id="archived-view">
                <h2>Archived Items</h2>
                <div id="archived-list">
                    <p class="empty-message">No archived classes or assignments.</p>
                </div>
            </div>

             <div id="settings-view" style="display: none;">
                 <h2>Settings</h2>

                 <div class="settings-tabs" role="tablist">
                    <button id="settings-tab-appearance" class="active" role="tab" aria-controls="settings-content-appearance" aria-selected="true">Appearance</button>
                    <button id="settings-tab-behavior" role="tab" aria-controls="settings-content-behavior" aria-selected="false">Behavior</button>
                    <button id="settings-tab-grading" role="tab" aria-controls="settings-content-grading" aria-selected="false">Grading Policies</button>
                    <button id="settings-tab-data" role="tab" aria-controls="settings-content-data" aria-selected="false">Data Management</button>
                 </div>

                 <div id="settings-content-appearance" class="settings-content-area" role="tabpanel" aria-labelledby="settings-tab-appearance">
                    <h3>Visuals & Appearance</h3>
                     <div class="customization-option">
                        <label for="theme-preset-select">Color Theme Presets:</label>
                        <select id="theme-preset-select" aria-label="Color Theme Presets">
                            <option value="default">Default</option>
                            <option value="monochrome">Monochrome</option>
                            <option value="ocean">Ocean Breeze</option>
                            <option value="forest">Forest Green</option>
                            <option value="sunset">Sunset Vibes</option>
                            <option value="candy">Candy Land</option>
                            <option value="cool_mint">Cool Mint</option>
                            <option value="warm_autumn">Warm Autumn</option>
                        </select>
                     </div>
                     <div class="customization-option">
                        <label>Or Customize Colors:</label>
                        <div class="color-picker-group">
                            <label for="setting-accent-color">Accent:</label>
                            <input type="color" id="setting-accent-color" value="#ffb400" aria-label="Accent color picker">
                            <label for="setting-primary-bg">Primary Bg:</label>
                            <input type="color" id="setting-primary-bg" value="#fdf8e1" aria-label="Primary background color picker">
                            <label for="setting-secondary-bg">Secondary Bg:</label>
                            <input type="color" id="setting-secondary-bg" value="#ffffff" aria-label="Secondary background color picker">
                            <label for="setting-text-color">Text Color:</label>
                            <input type="color" id="setting-text-color" value="#4d4030" aria-label="Text color picker">
                            <button id="reset-colors-btn" class="bg-upload-label" style="background-color: #777;" aria-label="Reset colors to default">Reset to Default</button>
                        </div>
                     </div>
                     <div class="settings-section-divider"></div>
                     <div class="customization-option">
                         <label for="setting-font-family">Font Family:</label>
                         <select id="setting-font-family" aria-label="Select font family">
                            <option value="Inter">Inter</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Lato">Lato</option>
                            <option value="Montserrat">Montserrat</option>
                            <option value="Lora">Lora (Serif)</option>
                            <option value="PT Serif">PT Serif (Serif)</option>
                            <option value="Playfair Display">Playfair Display (Serif)</option>
                         </select>
                     </div>
                     <div class="customization-option" role="group" aria-labelledby="layout-density-label">
                         <label id="layout-density-label">Layout Density:</label>
                         <div>
                            <input type="radio" id="density-compact" name="layout-density" value="compact">
                            <label for="density-compact">Compact</label>
                            <input type="radio" id="density-normal" name="layout-density" value="normal" checked>
                            <label for="density-normal">Normal</label>
                            <input type="radio" id="density-spacious" name="layout-density" value="spacious">
                            <label for="density-spacious">Spacious</label>
                         </div>
                     </div>
                     <div class="settings-section-divider"></div>
                     <div class="background-settings" style="border-bottom: none; padding-bottom: 0;">
                        <h3>Background Image</h3>
                        <p>Upload a custom image. A slight overlay is applied for readability. Click remove to reset to the subtle default.</p>
                         <div class="bg-upload">
                             <label for="bg-upload-file" class="bg-upload-label" tabindex="0" role="button" aria-label="Upload custom background image">Upload Custom Background</label>
                             <input type="file" id="bg-upload-file" accept="image/*" aria-hidden="true">
                            <button id="remove-bg-btn" class="bg-upload-label" style="background-color: #777;" aria-label="Remove background image">Remove Background</button>
                         </div>
                     </div>
                 </div>

                 <div id="settings-content-behavior" class="settings-content-area" style="display: none;" role="tabpanel" aria-labelledby="settings-tab-behavior">
                    <h3>Application Behavior</h3>
                    <div class="customization-option">
                        <label for="setting-default-view">Default View on Startup:</label>
                        <select id="setting-default-view" aria-label="Default view on application startup">
                            <option value="list">Tasks List</option>
                            <option value="calendar">Calendar</option>
                            <option value="classes">Classes</option>
                            <option value="planner">Academic Planner</option>
                            <option value="archived">Archived</option>
                            <option value="settings">Settings</option>
                        </select>
                    </div>
                    <div class="customization-option">
                         <input type="checkbox" id="setting-enable-toasts" checked aria-label="Enable Toast Notifications">
                         <label for="setting-enable-toasts">Enable Toast Notifications</label>
                     </div>
                    <div class="customization-option">
                         <input type="checkbox" id="setting-confirm-delete" checked aria-label="Confirm deletions">
                         <label for="setting-confirm-delete">Confirm Deletions (Tasks, Classes, Courses)</label>
                     </div>
                    <div class="customization-option">
                         <label for="setting-date-format">Date Format:</label>
                         <select id="setting-date-format" aria-label="Date format preference">
                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                         </select>
                    </div>
                    <div class="customization-option">
                         <input type="checkbox" id="setting-show-uncategorized" checked aria-label="Show Uncategorized Class even if empty">
                         <label for="setting-show-uncategorized">Show "Uncategorized" Class (even if empty)</label>
                     </div>
                     <div class="settings-section-divider"></div>
                     <h3>Statistics & Reporting</h3>
                     <div class="stats-section" style="padding-bottom: 0; border-bottom: none;">
                     <p>Total Assignments: <span id="total-assignments">0</span></p>
                     <p>Completed Assignments: <span id="completed-assignments">0</span></p>
                     <p>Pending Assignments: <span id="pending-assignments">0</span></p>
                     <p>Overdue Assignments: <span id="overdue-assignments">0</span></p>
                     <h4>Most Frequent Classes:</h4>
                     <ul id="frequent-classes-list"></ul>
                     </div>
                 </div>

                 <div id="settings-content-grading" class="settings-content-area" style="display: none;" role="tabpanel" aria-labelledby="settings-tab-grading">
                    <h3>Grading Policies</h3>
                     <div class="customization-option" role="group" aria-labelledby="gpa-scale-label">
                         <label id="gpa-scale-label">GPA Calculation Scale:</label>
                         <div>
                            <input type="radio" id="gpa-scale-fcps" name="gpa-scale" value="fcps" checked aria-labelledby="gpa-scale-fcps">
                            <label for="gpa-scale-fcps">FCPS Standard (Weighted)</label>
                            <input type="radio" id="gpa-scale-custom" name="gpa-scale" value="custom" aria-labelledby="gpa-scale-custom">
                            <label for="gpa-scale-custom">Custom 4.0 Scale</label>
                         </div>
                     </div>
                     <div id="custom-gpa-scale-editor" class="customization-option" style="display: none;">
                         <label>Custom GPA Points (on a 4.0 scale):</label>
                         <div class="grading-policy-setting-group">
                             <div><label for="custom-gpa-A">A (93-100):</label><input type="number" id="custom-gpa-A" step="0.1" value="4.0" aria-label="GPA points for A grade"></div>
                             <div><label for="custom-gpa-Am">A- (90-92.9):</label><input type="number" id="custom-gpa-Am" step="0.1" value="3.7" aria-label="GPA points for A- grade"></div>
                             <div><label for="custom-gpa-Bp">B+ (87-89.9):</label><input type="number" id="custom-gpa-Bp" step="0.1" value="3.3" aria-label="GPA points for B+ grade"></div>
                             <div><label for="custom-gpa-B">B (83-86.9):</label><input type="number" id="custom-gpa-B" step="0.1" value="3.0" aria-label="GPA points for B grade"></div>
                             <div><label for="custom-gpa-Bm">B- (80-82.9):</label><input type="number" id="custom-gpa-Bm" step="0.1" value="2.7" aria-label="GPA points for B- grade"></div>
                             <div><label for="custom-gpa-Cp">C+ (77-79.9):</label><input type="number" id="custom-gpa-Cp" step="0.1" value="2.3" aria-label="GPA points for C+ grade"></div>
                             <div><label for="custom-gpa-C">C (73-76.9):</label><input type="number" id="custom-gpa-C" step="0.1" value="2.0" aria-label="GPA points for C grade"></div>
                             <div><label for="custom-gpa-Cm">C- (70-72.9):</label><input type="number" id="custom-gpa-Cm" step="0.1" value="1.7" aria-label="GPA points for C- grade"></div>
                             <div><label for="custom-gpa-Dp">D+ (67-69.9):</label><input type="number" id="custom-gpa-Dp" step="0.1" value="1.3" aria-label="GPA points for D+ grade"></div>
                             <div><label for="custom-gpa-D">D (63-66.9):</label><input type="number" id="custom-gpa-D" step="0.1" value="1.0" aria-label="GPA points for D grade"></div>
                             <div><label for="custom-gpa-Dm">D- (60-62.9):</label><input type="number" id="custom-gpa-Dm" step="0.1" value="0.7" aria-label="GPA points for D- grade"></div>
                             <div><label for="custom-gpa-F">F (&lt;60):</label><input type="number" id="custom-gpa-F" step="0.1" value="0.0" aria-label="GPA points for F grade"></div>
                         </div>
                     </div>

                     <div class="customization-option">
                         <label>Default Grade Component Weights (for semester average):</label>
                         <p class="text-sm text-gray-600 mb-2">Total should ideally sum to 100%. Missing components will be ignored. These are global defaults.</p>
                         <div class="grading-policy-setting-group">
                             <div><label for="default-weight-q1">Q1 (%):</label><input type="number" id="default-weight-q1" min="0" max="100" step="1" value="20" aria-label="Default weight for Quarter 1"></div>
                             <div><label for="default-weight-q2">Q2 (%):</label><input type="number" id="default-weight-q2" min="0" max="100" step="1" value="20" aria-label="Default weight for Quarter 2"></div>
                             <div><label for="default-weight-q3">Q3 (%):</label><input type="number" id="default-weight-q3" min="0" max="100" step="1" value="20" aria-label="Default weight for Quarter 3"></div>
                             <div><label for="default-weight-q4">Q4 (%):</label><input type="number" id="default-weight-q4" min="0" max="100" step="1" value="20" aria-label="Default weight for Quarter 4"></div>
                             <div><label for="default-weight-midterm">Midterm (%):</label><input type="number" id="default-weight-midterm" min="0" max="100" step="1" value="10" aria-label="Default weight for Midterm exam"></div>
                             <div><label for="default-weight-final">Final (%):</label><input type="number" id="default-weight-final" min="0" max="100" step="1" value="10" aria-label="Default weight for Final exam"></div>
                         </div>
                         <div class="button-group" style="text-align: left; margin-top: 10px;">
                             <button id="auto-allocate-weights" class="bg-upload-label" style="background-color: var(--custom-accent-color);" aria-label="Auto-allocate weights evenly">Auto-allocate (evenly)</button>
                             <button id="reset-weights-btn" class="bg-upload-label" style="background-color: #777;" aria-label="Reset weights to application defaults">Reset to Defaults</button>
                         </div>
                     </div>
                 </div>


                 <div id="settings-content-data" class="settings-content-area" style="display: none;" role="tabpanel" aria-labelledby="settings-tab-data">
                    <h3>Data Management</h3>
                    <p class="text-sm text-gray-600 mb-4">Export your data to a JSON file for backup. Import a JSON file to restore your saved information. Importing will overwrite existing data.</p>
                    <button id="export-data-btn" aria-label="Export all data">Export Data</button>
                    <label for="import-data-file" class="bg-upload-label" style="background-color: var(--status-todo);" tabindex="0" role="button" aria-label="Import data from file">Import Data</label>
                    <input type="file" id="import-data-file" accept="application/json" style="display: none;" aria-hidden="true">
                 </div>
            </div>

        </div>
    </div>

    <div id="class-edit-modal" class="modal-overlay" style="display:none;" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="class-edit-modal-title">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close dialog">‚úñ</button>
            <h3 id="class-edit-modal-title">Edit Class</h3>
            <div class="modal-form-group">
                <label for="edit-class-name">Class Name:</label>
                <input type="text" id="edit-class-name" required aria-label="Edit class name">
            </div>
            <div class="modal-form-group">
                <label for="edit-class-color">Class Color:</label>
                <input type="color" id="edit-class-color" aria-label="Edit class color">
            </div>
            <div class="modal-form-group">
                <label for="edit-class-description">Description (Optional):</label>
                <textarea id="edit-class-description" rows="2" class="details-notes" aria-label="Class description"></textarea>
            </div>
            <div class="modal-form-group">
                <label for="edit-class-instructor">Instructor (Optional):</label>
                <input type="text" id="edit-class-instructor" aria-label="Class instructor">
            </div>
            <div class="modal-form-group">
                <label for="edit-class-schedule">Schedule (Optional):</label>
                <input type="text" id="edit-class-schedule" aria-label="Class schedule">
            </div>
            <div class="modal-form-group">
                <label for="edit-class-location">Location (Optional):</label>
                <input type="text" id="edit-class-location" aria-label="Class location">
            </div>
            <div class="modal-buttons">
                <button class="save-btn" id="save-class-edit-btn" aria-label="Save class changes">Save Changes</button>
                <button class="cancel-btn" aria-label="Cancel">Cancel</button>
            </div>
        </div>
    </div>

    <div id="assignment-details-modal" class="modal-overlay" style="display:none;" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="assignment-details-modal-title">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close dialog">‚úñ</button>
            <h3 id="assignment-details-modal-title">Task Details</h3>
            <input type="hidden" id="details-assignment-id">
            <div class="modal-form-group">
                <label for="details-assignment-text">Description:</label>
                <input type="text" id="details-assignment-text" required aria-label="Task description">
            </div>
            <div class="modal-form-group">
                <label for="details-assignment-class-select">Class:</label>
                <select id="details-assignment-class-select" required aria-label="Assigned class"></select>
            </div>
            <div class="modal-form-group">
                <label for="details-assignment-due-date">Due Date:</label>
                <input type="date" id="details-assignment-due-date" aria-label="Due date">
            </div>
            <div class="modal-form-group">
                <label for="details-assignment-priority-select">Priority:</label>
                <select id="details-assignment-priority-select" aria-label="Task priority">
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="modal-form-group">
                <label for="details-assignment-status-select">Status:</label>
                <select id="details-assignment-status-select" aria-label="Task status">
                    <option value="To Do">To Do</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
            <div class="modal-form-group">
                <label for="details-assignment-type-select">Type:</label>
                <select id="details-assignment-type-select" aria-label="Task type">
                    <option value="Homework">Homework</option>
                    <option value="Test">Test</option>
                    <option value="Project">Project</option>
                    <option value="Other">Other</option>
                </select>
            </div>
             <div class="modal-form-group">
                <label for="details-assignment-notes">Notes:</label>
                <textarea id="details-assignment-notes" rows="3" class="details-notes" aria-label="Task notes"></textarea>
            </div>
             <div class="modal-form-group">
                 <label>Subtasks:</label>
                 <ul id="details-subtasks-list" class="subtasks-list" role="list"></ul>
                 <div class="add-subtask-form">
                     <input type="text" id="new-subtask-text" placeholder="Add a new subtask..." aria-label="New subtask text">
                     <button id="add-subtask-btn" aria-label="Add subtask">Add</button>
                 </div>
             </div>

            <div class="modal-buttons">
                <button class="save-btn" id="save-assignment-details-btn" aria-label="Save task details">Save Changes</button>
                <button class="cancel-btn" aria-label="Cancel">Cancel</button>
            </div>
        </div>
    </div>

    <div id="planner-course-grades-modal" class="modal-overlay" style="display:none;" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="planner-course-grades-modal-title">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close dialog">‚úñ</button>
            <h3 id="planner-course-grades-modal-title">Enter Grades for: <span id="current-course-name"></span></h3>
            <input type="hidden" id="current-course-id">
            <div class="modal-form-group">
                <label for="planner-course-status">Course Status:</label>
                <select id="planner-course-status" aria-label="Course status">
                    <option value="Planned">Planned</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
            <div class="grade-format-selector" role="group" aria-labelledby="grade-format-label">
                <span id="grade-format-label" style="display: none;">Grade Format:</span>
                <input type="radio" id="grade-format-percent" name="gradeFormat" value="percent" checked aria-labelledby="grade-format-label">
                <label for="grade-format-percent">Percentage</label>
                <input type="radio" id="grade-format-letter" name="gradeFormat" value="letter" aria-labelledby="grade-format-label">
                <label for="grade-format-letter">Letter Grade</label>
            </div>
            <div class="modal-form-group">
                <label for="manual-semester-average">Manual Semester Average (%):</label>
                <input type="number" id="manual-semester-average" min="0" max="100" step="0.1" placeholder="Leave empty for calculated" aria-label="Manual semester average override">
                <div class="grade-component">
                    <input type="checkbox" id="grade-override-toggle" class="grade-override-toggle" aria-label="Override calculated average with manual input">
                    <label for="grade-override-toggle">Override calculated average with manual input</label>
                </div>
            </div>
            <div class="planner-grade-inputs" id="grade-inputs-container">
                <div class="grade-component">
                    <label for="grade-q1-input">Q1 Grade:</label>
                    <input type="number" id="grade-q1-input" class="grade-input" min="0" max="100" step="0.1">
                </div>
                <div class="grade-component">
                    <label for="grade-q2-input">Q2 Grade:</label>
                    <input type="number" id="grade-q2-input" class="grade-input" min="0" max="100" step="0.1">
                </div>
                <div class="grade-component">
                    <label for="grade-q3-input">Q3 Grade:</label>
                    <input type="number" id="grade-q3-input" class="grade-input" min="0" max="100" step="0.1">
                </div>
                 <div class="grade-component">
                    <label for="grade-q4-input">Q4 Grade:</label>
                    <input type="number" id="grade-q4-input" class="grade-input" min="0" max="100" step="0.1">
                </div>
                <div class="grade-component">
                    <label for="grade-midterm-input">Midterm Grade:</label>
                    <input type="number" id="grade-midterm-input" class="grade-input" min="0" max="100" step="0.1">
                </div>
                <div class="grade-component">
                    <label for="grade-final-exam-input">Final Exam Grade:</label>
                    <input type="number" id="grade-final-exam-input" class="grade-input" min="0" max="100" step="0.1">
                </div>
            </div>
            <div id="calculated-average-display" class="planner-calculated-grade" style="margin-top: 20px;">
                Calculated Grade: N/A
            </div>
             <div class="grade-info-overlay">
                Calculated using custom weights from settings:
                Q1(<span id="display-weight-q1">0</span>%), Q2(<span id="display-weight-q2">0</span>%), Q3(<span id="display-weight-q3">0</span>%), Q4(<span id="display-weight-q4">0</span>%), Midterm(<span id="display-weight-midterm">0</span>%), Final(<span id="display-weight-final">0</span>%)
            </div>
            <div class="modal-buttons">
                <button class="save-btn" id="save-planner-grades-btn" aria-label="Save grades">Save Grades</button>
                <button class="cancel-btn" aria-label="Cancel">Cancel</button>
            </div>
        </div>
    </div>


    <div id="toast-container" aria-live="polite" aria-atomic="true">
    </div>


    <script>
        const D = {
            layout: document.querySelector('.layout'),
            mainContent: document.querySelector('.main-content'),
            sidebar: document.querySelector('.sidebar'),
            navList: document.getElementById('nav-list'),
            navCalendar: document.getElementById('nav-calendar'),
            navClasses: document.getElementById('nav-classes'),
            navPlanner: document.getElementById('nav-planner'),
            navArchived: document.getElementById('nav-archived'),
            navSettings: document.getElementById('nav-settings'),
            themeToggle: document.getElementById('theme-toggle'),

            classesView: document.getElementById('classes-view'),
            quickAddContainer: document.getElementById('quick-add-container'),
            addAssignmentFormContainer: document.getElementById('add-assignment-form-container'),
            assignmentListView: document.getElementById('assignment-list-view'),
            calendarView: document.getElementById('calendar-view'),
            academicPlannerView: document.getElementById('academic-planner-view'),
            archivedView: document.getElementById('archived-view'),
            archivedList: document.getElementById('archived-list'),
            settingsView: document.getElementById('settings-view'),

            newClassNameInput: document.getElementById('new-class-name'),
            newClassColorInput: document.getElementById('new-class-color'),
            addClassBtn: document.getElementById('add-class-btn'),
            classListUl: document.getElementById('class-list'),

            quickAddTextInput: document.getElementById('quick-add-text'),
            quickAddBtn: document.getElementById('quick-add-btn'),

            assignmentTextInput: document.getElementById('assignment-text'),
            assignmentClassSelect: document.getElementById('assignment-class-select'),
            assignmentDueDateInput: document.getElementById('assignment-due-date'),
            assignmentPrioritySelect: document.getElementById('assignment-priority-select'),
            assignmentStatusSelect: document.getElementById('assignment-status-select'),
            assignmentTypeSelect: document.getElementById('assignment-type-select'),
            addAssignmentBtn: document.getElementById('add-assignment-btn'),

            viewListBtn: document.getElementById('view-list-btn'),
            viewCalendarBtn: document.getElementById('view-calendar-btn'),

            searchInput: document.getElementById('search-input'),
            sortBySelect: document.getElementById('sort-by'),
            filterStatusSelect: document.getElementById('filter-status'),
            filterPrioritySelect: document.getElementById('filter-priority'),
            filterTypeSelect: document.getElementById('filter-type'),
            hideCompletedCheckbox: document.getElementById('hide-completed'),
            filterSortBar: document.getElementById('filter-sort-bar'),

            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            calendarMonthYear: document.getElementById('calendar-month-year'),
            calendarGrid: document.getElementById('calendar-grid'),

            totalAssignmentsSpan: document.getElementById('total-assignments'),
            completedAssignmentsSpan: document.getElementById('completed-assignments'),
            pendingAssignmentsSpan: document.getElementById('pending-assignments'),
            overdueAssignmentsSpan: document.getElementById('overdue-assignments'),
            frequentClassesList: document.getElementById('frequent-classes-list'),
            bgUploadInput: document.getElementById('bg-upload-file'),
            removeBgBtn: document.getElementById('remove-bg-btn'),
            exportDataBtn: document.getElementById('export-data-btn'),
            importDataFile: document.getElementById('import-data-file'),

            modals: document.querySelectorAll('.modal-overlay'),
            modalCloseBtns: document.querySelectorAll('.modal-close-btn'),
            modalCancelBtns: document.querySelectorAll('.modal-buttons .cancel-btn'),
            toastContainer: document.getElementById('toast-container'),
            loadingOverlay: document.getElementById('loading-overlay'),

            classEditModal: document.getElementById('class-edit-modal'),
            editClassNameInput: document.getElementById('edit-class-name'),
            editClassColorInput: document.getElementById('edit-class-color'),
            editClassDescription: document.getElementById('edit-class-description'),
            editClassInstructor: document.getElementById('edit-class-instructor'),
            editClassSchedule: document.getElementById('edit-class-schedule'),
            editClassLocation: document.getElementById('edit-class-location'),
            saveClassEditBtn: document.getElementById('save-class-edit-btn'),

            assignmentDetailsModal: document.getElementById('assignment-details-modal'),
            detailsAssignmentId: document.getElementById('details-assignment-id'),
            detailsAssignmentText: document.getElementById('details-assignment-text'),
            detailsAssignmentClassSelect: document.getElementById('details-assignment-class-select'),
            detailsAssignmentDueDate: document.getElementById('details-assignment-due-date'),
            detailsAssignmentPrioritySelect: document.getElementById('details-assignment-priority-select'),
            detailsAssignmentStatusSelect: document.getElementById('details-assignment-status-select'),
            detailsAssignmentTypeSelect: document.getElementById('details-assignment-type-select'),
            detailsAssignmentNotes: document.getElementById('details-assignment-notes'),
            detailsSubtasksList: document.getElementById('details-subtasks-list'),
            newSubtaskText: document.getElementById('new-subtask-text'),
            addSubtaskBtn: document.getElementById('add-subtask-btn'),
            saveAssignmentDetailsBtn: document.getElementById('save-assignment-details-btn'),

            plannerTabPlan: document.getElementById('planner-tab-plan'),
            plannerTabGpa: document.getElementById('planner-tab-gpa'),
            plannerTabPredictor: document.getElementById('planner-tab-predictor'),
            plannerContentPlan: document.getElementById('planner-content-plan'),
            plannerContentGpa: document.getElementById('planner-content-gpa'),
            plannerContentPredictor: document.getElementById('planner-content-predictor'),

            newCourseNameInput: document.getElementById('new-course-name'),
            newCourseYearSelect: document.getElementById('new-course-year'),
            newCourseSemesterSelect: document.getElementById('new-course-semester'),
            newCourseLevelSelect: document.getElementById('new-course-level'),
            newCourseCreditsSelect: document.getElementById('new-course-credits'),
            newCourseSubjectInput: document.getElementById('new-course-subject'),
            addPlannerCourseBtn: document.getElementById('add-planner-course-btn'),
            coursePlannerDisplay: document.getElementById('course-planner-display'),

            plannerCourseGradesModal: document.getElementById('planner-course-grades-modal'),
            currentCourseNameSpan: document.getElementById('current-course-name'),
            currentCourseIdInput: document.getElementById('current-course-id'),
            plannerCourseStatusSelect: document.getElementById('planner-course-status'),
            manualSemesterAverageInput: document.getElementById('manual-semester-average'),
            gradeOverrideToggle: document.getElementById('grade-override-toggle'),
            gradeFormatPercent: document.getElementById('grade-format-percent'),
            gradeFormatLetter: document.getElementById('grade-format-letter'),
            gradeInputsContainer: document.getElementById('grade-inputs-container'),
            calculatedAverageDisplay: document.getElementById('calculated-average-display'),
            savePlannerGradesBtn: document.getElementById('save-planner-grades-btn'),

            gradeQ1Input: null, gradeQ2Input: null, gradeQ3Input: null, gradeQ4Input: null,
            gradeMidtermInput: null, gradeFinalExamInput: null,

            gpaTypeUnweightedBtn: document.getElementById('gpa-type-unweighted'),
            gpaTypeWeightedBtn: document.getElementById('gpa-type-weighted'),
            overallGpaDisplay: document.getElementById('overall-gpa-display'),
            totalCreditsDisplay: document.getElementById('total-credits-display'),
            gpaByYearSemesterDisplay: document.getElementById('gpa-by-year-semester-display'),

            currentAverageInput: document.getElementById('current-average'),
            finalWeightPercentageInput: document.getElementById('final-weight-percentage'),
            targetFinalGradeInput: document.getElementById('target-final-grade'),
            calculateFinalBtn: document.getElementById('calculate-final-btn'),
            finalPredictorResult: document.getElementById('final-predictor-result'),

            settingsTabAppearance: document.getElementById('settings-tab-appearance'),
            settingsTabBehavior: document.getElementById('settings-tab-behavior'),
            settingsTabGrading: document.getElementById('settings-tab-grading'),
            settingsTabData: document.getElementById('settings-tab-data'),
            settingsContentAppearance: document.getElementById('settings-content-appearance'),
            settingsContentBehavior: document.getElementById('settings-content-behavior'),
            settingsContentGrading: document.getElementById('settings-content-grading'),
            settingsContentData: document.getElementById('settings-content-data'),

            settingAccentColor: document.getElementById('setting-accent-color'),
            settingPrimaryBg: document.getElementById('setting-primary-bg'),
            settingSecondaryBg: document.getElementById('setting-secondary-bg'),
            settingTextColor: document.getElementById('setting-text-color'),
            resetColorsBtn: document.getElementById('reset-colors-btn'),
            settingFontFamily: document.getElementById('setting-font-family'),
            densityCompact: document.getElementById('density-compact'),
            densityNormal: document.getElementById('density-normal'),
            densitySpacious: document.getElementById('density-spacious'),
            settingDefaultView: document.getElementById('setting-default-view'),
            settingEnableToasts: document.getElementById('setting-enable-toasts'),
            settingConfirmDelete: document.getElementById('setting-confirm-delete'),
            settingDateFormat: document.getElementById('setting-date-format'),
            settingShowUncategorized: document.getElementById('setting-show-uncategorized'),
            gpaScaleFcps: document.getElementById('gpa-scale-fcps'),
            gpaScaleCustom: document.getElementById('gpa-scale-custom'),
            customGpaScaleEditor: document.getElementById('custom-gpa-scale-editor'),
            customGpaA: document.getElementById('custom-gpa-A'), customGpaAm: document.getElementById('custom-gpa-Am'),
            customGpaBp: document.getElementById('custom-gpa-Bp'), customGpaB: document.getElementById('custom-gpa-B'), customGpaBm: document.getElementById('custom-gpa-Bm'),
            customGpaCp: document.getElementById('custom-gpa-Cp'), customGpaC: document.getElementById('custom-gpa-C'), customGpaCm: document.getElementById('custom-gpa-Cm'),
            customGpaDp: document.getElementById('custom-gpa-Dp'), customGpaD: document.getElementById('custom-gpa-D'), customGpaDm: document.getElementById('custom-gpa-Dm'),
            customGpaF: document.getElementById('custom-gpa-F'),
            defaultWeightQ1: document.getElementById('default-weight-q1'),
            defaultWeightQ2: document.getElementById('default-weight-q2'),
            defaultWeightQ3: document.getElementById('default-weight-q3'),
            defaultWeightQ4: document.getElementById('default-weight-q4'),
            defaultWeightMidterm: document.getElementById('default-weight-midterm'),
            defaultWeightFinal: document.getElementById('default-weight-final'),
            autoAllocateWeightsBtn: document.getElementById('auto-allocate-weights'),
            resetWeightsBtn: document.getElementById('reset-weights-btn'),

            displayWeightQ1: document.getElementById('display-weight-q1'),
            displayWeightQ2: document.getElementById('display-weight-q2'),
            displayWeightQ3: document.getElementById('display-weight-q3'),
            displayWeightQ4: document.getElementById('display-weight-q4'),
            displayWeightMidterm: document.getElementById('display-weight-midterm'),
            displayWeightFinal: document.getElementById('display-weight-final'),

            themePresetSelect: document.getElementById('theme-preset-select')
        };

        let classes = [];
        let assignments = [];
        let plannerCourses = [];
        let currentView = 'list';
        let currentPlannerTab = 'plan';
        let currentGPAType = 'unweighted';
        let currentSettingsTab = 'appearance';
        let calendarDate = new Date();
        let draggedItem = null;
        let currentGradeFormat = 'percent';

        const STORAGE_PREFIX = 'monkeyPlanner';
        const CLASSES_STORAGE_KEY = `${STORAGE_PREFIX}_classes_v7`;
        const ASSIGNMENTS_STORAGE_KEY = `${STORAGE_PREFIX}_assignments_v6`;
        const PLANNER_COURSES_STORAGE_KEY = `${STORAGE_PREFIX}_planner_courses_v3`;
        const SETTINGS_STORAGE_KEY = `${STORAGE_PREFIX}_settings_v3`;
        const BACKGROUND_STORAGE_KEY = `${STORAGE_PREFIX}_background_v1`;
        const THEME_STORAGE_KEY = `${STORAGE_PREFIX}_theme_v1`;
        const DEFAULT_CLASS_COLOR = '#a8d8ea';
        const MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const PRIORITIES = { 'High': 2, 'Medium': 1, 'Low': 0 };
        const UNCAT_CLASS_NAME = 'Uncategorized';
        const DEFAULT_BG_URL = "https://images.unsplash.com/photo-1510253457169-b57007e997a3?auto=format&fit=crop&q=80&w=1920&h=1080";

        const DEFAULT_SETTINGS = {
            customColors: {
                accent: '#ffb400',
                primaryBg: '#fdf8e1',
                secondaryBg: '#ffffff',
                textColor: '#4d4030'
            },
            fontFamily: 'Inter',
            layoutDensity: 'normal',
            defaultView: 'list',
            enableToasts: true,
            confirmDelete: true,
            dateFormat: 'MM/DD/YYYY',
            showUncategorized: true,
            gpaScale: 'fcps',
            customGpaPoints: {
                'A': 4.0, 'A-': 3.7, 'B+': 3.3, 'B': 3.0, 'B-': 2.7,
                'C+': 2.3, 'C': 2.0, 'C-': 1.7, 'D+': 1.3, 'D': 1.0,
                'D-': 0.7, 'F': 0.0
            },
            defaultGradeWeights: {
                q1: 20, q2: 20, q3: 20, q4: 20, midterm: 10, final: 10
            }
        };

        const THEME_PRESETS = {
            default: {
                 accent: '#ffb400', primaryBg: '#fdf8e1', secondaryBg: '#ffffff', textColor: '#4d4030'
            },
            monochrome: {
                 accent: '#808080', primaryBg: '#f0f0f0', secondaryBg: '#ffffff', textColor: '#333333'
            },
            ocean: {
                 accent: '#1e88e5', primaryBg: '#e3f2fd', secondaryBg: '#ffffff', textColor: '#263238'
            },
            forest: {
                 accent: '#43a047', primaryBg: '#e8f5e9', secondaryBg: '#ffffff', textColor: '#2e7d32'
            },
            sunset: {
                 accent: '#ff7043', primaryBg: '#fff3e0', secondaryBg: '#ffe0b2', textColor: '#d84315'
            },
            candy: {
                accent: '#ff4081', primaryBg: '#fce4ec', secondaryBg: '#f8bbd0', textColor: '#c2185b'
            },
            cool_mint: {
                accent: '#00d481', primaryBg: '#f0fff4', secondaryBg: '#ffffff', textColor: '#0e704e'
            },
            warm_autumn: {
                accent: '#d95a2d', primaryBg: '#fcf8f0', secondaryBg: '#fffbe5', textColor: '#5b2f20'
            }
        };

        let appSettings = {};

        const FCPS_GRADE_MAP = {
            A: { range: [93, 100], gpa: 4.0, percent: 96.5 },
            'A-': { range: [90, 92.9], gpa: 3.7, percent: 91.5 },
            'B+': { range: [87, 89.9], gpa: 3.3, percent: 88.5 },
            B: { range: [83, 86.9], gpa: 3.0, percent: 84.5 },
            'B-': { range: [80, 82.9], gpa: 2.7, percent: 81.5 },
            'C+': { range: [77, 79.9], gpa: 2.3, percent: 78.5 },
            C: { range: [73, 76.9], gpa: 2.0, percent: 74.5 },
            'C-': { range: [70, 72.9], gpa: 1.7, percent: 71.5 },
            'D+': { range: [67, 69.9], gpa: 1.3, percent: 68.5 },
            D: { range: [63, 66.9], gpa: 1.0, percent: 64.5 },
            'D-': { range: [60, 62.9], gpa: 0.7, percent: 61.5 },
            F: { range: [0, 59.9], gpa: 0.0, percent: 29.95 }
        };

        const FCPS_WEIGHTED_MULTIPLIER = {
            Standard: 0,
            Honors: 0.5,
            AP: 1.0,
            DE: 1.0,
            IB: 1.0
        };

        const AppStorage = {
            load: (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error(`Error loading data from localStorage for key "${key}":`, e);
                    return null;
                }
            },
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error(`Error saving data to localStorage for key "${key}":`, e);
                }
            }
        };

        function showLoadingOverlay() {
            D.loadingOverlay.classList.add('show');
        }

        function hideLoadingOverlay() {
            D.loadingOverlay.classList.remove('show');
        }

        function showToast(message, type = 'info', duration = 3000) {
            if (!appSettings.enableToasts) return;
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            let icon = '';
            if (type === 'success') icon = '<heroicons-ui/check-circle class="icon"/>';
            if (type === 'error') icon = '<heroicons-ui/x-circle class="icon"/>';
            if (type === 'info') icon = '<heroicons-ui/information-circle class="icon"/>';
            toast.innerHTML = `${icon}<span>${message}</span>`;
            D.toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        function getTextColorForBackground(hexcolor) {
            if (!hexcolor || hexcolor.length < 4) return '--dark-text';
            if (hexcolor.length === 4) hexcolor = '#' + hexcolor[1].repeat(2) + hexcolor[2].repeat(2) + hexcolor[3].repeat(2);
            try {
                const r = parseInt(hexcolor.substring(1, 3), 16);
                const g = parseInt(hexcolor.substring(3, 5), 16);
                const b = parseInt(hexcolor.substring(5, 7), 16);
                const lum = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return lum > 0.5 ? '--dark-text' : '--light-text';
            } catch (e) { return '--dark-text'; }
        }

        function openModal(modalEl) {
            modalEl.style.display = 'flex';
            modalEl.setAttribute('aria-hidden', 'false');
            setTimeout(() => {
                const focusableElements = modalEl.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])');
                if (focusableElements.length > 0) {
                    focusableElements[0].focus();
                    const firstFocusableEl = focusableElements[0];
                    const lastFocusableEl = focusableElements[focusableElements.length - 1];

                    function handleKeydown(e) {
                        if (e.key === 'Tab') {
                            if (e.shiftKey) {
                                if (document.activeElement === firstFocusableEl) {
                                    lastFocusableEl.focus();
                                    e.preventDefault();
                                }
                            } else {
                                if (document.activeElement === lastFocusableEl) {
                                    firstFocusableEl.focus();
                                    e.preventDefault();
                                }
                            }
                        }
                        if (e.key === 'Escape') {
                            closeModal(modalEl);
                        }
                    }
                    modalEl.addEventListener('keydown', handleKeydown);
                    modalEl.dataset.keydownHandler = handleKeydown;
                } else {
                    modalEl.focus();
                }
            }, 50);
        }

        function closeModal(modalEl) {
            modalEl.style.display = 'none';
            modalEl.setAttribute('aria-hidden', 'true');
            if (modalEl.dataset.keydownHandler) {
                modalEl.removeEventListener('keydown', modalEl.dataset.keydownHandler);
                delete modalEl.dataset.keydownHandler;
            }
        }

        D.modalCloseBtns.forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-overlay'))));
        D.modalCancelBtns.forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-overlay'))));
        D.modals.forEach(modal => modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal(modal);
            }
        }));

        function loadClasses() {
            classes = AppStorage.load(CLASSES_STORAGE_KEY) || [];
            classes = classes.map(c => ({
                id: c.id || Date.now() + Math.random(),
                name: c.name || 'Unnamed Class',
                color: c.color || DEFAULT_CLASS_COLOR,
                order: c.order === undefined || c.order === null ? classes.length : c.order,
                archived: c.archived || false,
                description: c.description || '',
                instructor: c.instructor || '',
                schedule: c.schedule || '',
                location: c.location || ''
            }));
            normalizeClassOrder();
            if (!classes.some(c => c.id === 'uncategorized' && !c.archived)) {
                classes.push({ id: 'uncategorized', name: UNCAT_CLASS_NAME, color: '#cccccc', order: classes.length, archived: false, description: 'Tasks that are not assigned to a specific class.', instructor: '', schedule: '', location: '' });
                normalizeClassOrder();
            }
            saveClasses();
        }

        function normalizeClassOrder() {
            classes.sort((a, b) => (a.order ?? Infinity) - (b.order ?? Infinity) || a.name.localeCompare(b.name));
            classes.forEach((c, index) => c.order = index);
        }

        function saveClasses() {
            AppStorage.save(CLASSES_STORAGE_KEY, classes);
        }

        function renderClassList() {
            D.classListUl.innerHTML = '';
            const activeClasses = classes.filter(c => !c.archived).sort((a, b) => (a.order ?? Infinity) - (b.order ?? Infinity) || a.name.localeCompare(b.name));

            if (activeClasses.length === 0) {
                D.classListUl.innerHTML = '<li class="empty-message" style="margin-top:0;">No classes added yet.</li>';
                return;
            }

            activeClasses.forEach(classObj => {
                const li = document.createElement('li');
                const classInfoSpan = document.createElement('span');
                classInfoSpan.className = 'class-info';
                classInfoSpan.role = 'button';
                classInfoSpan.tabIndex = 0;
                classInfoSpan.setAttribute('aria-label', `Edit class ${classObj.name}`);
                classInfoSpan.addEventListener('click', () => editClass(classObj.id));

                const swatch = document.createElement('span');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = classObj.color;
                swatch.setAttribute('aria-hidden', 'true');
                classInfoSpan.appendChild(swatch);

                const nameSpan = document.createElement('span');
                nameSpan.textContent = classObj.name;
                classInfoSpan.appendChild(nameSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'class-actions';

                const editBtn = document.createElement('button');
                editBtn.className = 'class-action-btn edit-class-btn';
                editBtn.innerHTML = '‚úèÔ∏è';
                editBtn.title = `Edit class "${classObj.name}"`;
                editBtn.setAttribute('aria-label', `Edit class ${classObj.name}`);
                editBtn.onclick = (e) => { e.stopPropagation(); editClass(classObj.id); };
                actionsDiv.appendChild(editBtn);

                if (classObj.name !== UNCAT_CLASS_NAME) {
                    const archiveBtn = document.createElement('button');
                    archiveBtn.className = 'class-action-btn archive-class-btn';
                    archiveBtn.innerHTML = 'üóÑÔ∏è';
                    archiveBtn.title = `Archive class "${classObj.name}"`;
                    archiveBtn.setAttribute('aria-label', `Archive class ${classObj.name}`);
                    archiveBtn.onclick = (e) => { e.stopPropagation(); archiveClass(classObj.id, true); };
                    actionsDiv.appendChild(archiveBtn);
                }

                const assignmentsInClass = assignments.filter(a => a.class === classObj.name && !a.archived).length;
                if (classObj.name !== UNCAT_CLASS_NAME && (assignmentsInClass === 0 || !appSettings.confirmDelete)) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'class-action-btn delete-class-btn';
                    deleteBtn.innerHTML = 'üóëÔ∏è';
                    deleteBtn.title = `Delete class "${classObj.name}"`;
                    deleteBtn.setAttribute('aria-label', `Delete class ${classObj.name}`);
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteClass(classObj.id); };
                    actionsDiv.appendChild(deleteBtn);
                }

                li.appendChild(classInfoSpan);
                li.appendChild(actionsDiv);
                D.classListUl.appendChild(li);
            });
        }

        function populateClassDropdown(dropdownElement, includeArchived = false, excludeUncategorized = false) {
            const currentSelection = dropdownElement.value;
            dropdownElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "-- Select Class --";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            dropdownElement.appendChild(defaultOption);

            let classesToPopulate = classes;
            if (!includeArchived) {
                classesToPopulate = classesToPopulate.filter(c => !c.archived);
            }
            if (excludeUncategorized) {
                classesToPopulate = classesToPopulate.filter(c => c.name !== UNCAT_CLASS_NAME);
            }

            classesToPopulate.sort((a, b) => a.name.localeCompare(b.name)).forEach(classObj => {
                const option = document.createElement('option');
                option.value = classObj.name;
                option.textContent = classObj.name;
                if (classObj.name === currentSelection) {
                    option.selected = true;
                    defaultOption.selected = false;
                }
                dropdownElement.appendChild(option);
            });
            if (dropdownElement.selectedOptions.length === 0) {
                 defaultOption.selected = true;
            }
        }

        function addNewClass() {
            const className = D.newClassNameInput.value.trim();
            const classColor = D.newClassColorInput.value;
            if (className === '') {
                showToast('Please enter a class name.', 'error');
                D.newClassNameInput.focus();
                return;
            }
            if (classes.some(c => c.name.toLowerCase() === className.toLowerCase() && !c.archived)) {
                showToast(`Class "${className}" already exists (or is archived).`, 'error');
                return;
            }
            const newClass = {
                id: Date.now(),
                name: className,
                color: classColor,
                order: classes.length,
                archived: false,
                description: '',
                instructor: '',
                schedule: '',
                location: ''
            };
            classes.push(newClass);
            normalizeClassOrder();
            saveClasses();
            renderClassList();
            populateClassDropdown(D.assignmentClassSelect);
            D.newClassNameInput.value = '';
            D.newClassColorInput.value = DEFAULT_CLASS_COLOR;
            D.newClassNameInput.focus();
            showToast('Class added successfully!', 'success');
            navigate(currentView);
        }

        let currentEditingClassId = null;
        function editClass(id) {
            currentEditingClassId = id;
            const classObj = classes.find(c => c.id === id);
            if (!classObj) return;

            D.editClassNameInput.value = classObj.name;
            D.editClassColorInput.value = classObj.color;
            D.editClassDescription.value = classObj.description;
            D.editClassInstructor.value = classObj.instructor;
            D.editClassSchedule.value = classObj.schedule;
            D.editClassLocation.value = classObj.location;
            D.editClassNameInput.disabled = (classObj.name === UNCAT_CLASS_NAME);
            D.editClassColorInput.disabled = (classObj.name === UNCAT_CLASS_NAME);

            openModal(D.classEditModal);
            D.editClassNameInput.focus();
        }

        function saveClassChanges() {
            const classObj = classes.find(c => c.id === currentEditingClassId);
            if (!classObj) return;

            const newName = D.editClassNameInput.value.trim();
            if (newName === '') {
                showToast('Class name cannot be empty.', 'error');
                D.editClassNameInput.focus();
                return;
            }
            if (classObj.name === UNCAT_CLASS_NAME && newName !== UNCAT_CLASS_NAME) {
                D.editClassNameInput.value = UNCAT_CLASS_NAME;
                return;
            }

            if (newName !== classObj.name && classes.some(c => c.name.toLowerCase() === newName.toLowerCase() && !c.archived)) {
                showToast(`Class "${newName}" already exists (or is archived).`, 'error');
                D.editClassNameInput.focus();
                return;
            }

            const oldClassName = classObj.name;
            classObj.name = newName;
            classObj.color = D.editClassColorInput.value;
            classObj.description = D.editClassDescription.value;
            classObj.instructor = D.editClassInstructor.value;
            classObj.schedule = D.editClassSchedule.value;
            classObj.location = D.editClassLocation.value;

            if (oldClassName !== newName) {
                assignments.forEach(a => {
                    if (a.class === oldClassName) {
                        a.class = newName;
                    }
                });
                saveAssignments();
            }

            saveClasses();
            renderClassList();
            populateClassDropdown(D.assignmentClassSelect);
            populateClassDropdown(D.detailsAssignmentClassSelect, true, false);
            closeModal(D.classEditModal);
            showToast('Class updated successfully!', 'success');
            navigate(currentView);
        }
        D.saveClassEditBtn.addEventListener('click', saveClassChanges);


        function archiveClass(id, shouldArchive = true) {
            const classToModify = classes.find(c => c.id === id);
            if (!classToModify || classToModify.id === 'uncategorized') {
                showToast('Cannot archive this class.', 'error');
                return;
            }

            const actionVerb = shouldArchive ? "archive" : "unarchive";
            let confirmProceed = true;
            if (appSettings.confirmDelete) confirmProceed = confirm(`Are you sure you want to ${actionVerb} class "${classToModify.name}"?`);

            if (!confirmProceed) return;

            classToModify.archived = shouldArchive;
            if (shouldArchive) {
                assignments.forEach(a => {
                    if (a.class === classToModify.name && !a.archived) {
                        a.class = UNCAT_CLASS_NAME;
                        a.order = null;
                    }
                });
                saveAssignments();
                showToast(`Class "${classToModify.name}" archived and its active assignments moved to '${UNCAT_CLASS_NAME}'.`, 'success');
            } else {
                 showToast(`Class "${classToModify.name}" unarchived.`, 'success');
            }
            classToModify.archiveDate = shouldArchive ? new Date().toISOString() : null;
            saveClasses();
            renderClassList();
            populateClassDropdown(D.assignmentClassSelect);
            populateClassDropdown(D.detailsAssignmentClassSelect, true, false);
            navigate(currentView);
        }

        function deleteClass(id) {
            const classToDelete = classes.find(c => c.id === id);
            if (!classToDelete) return;

            if (classToDelete.id === 'uncategorized') {
                showToast(`Cannot delete the '${UNCAT_CLASS_NAME}' class.`, 'error');
                return;
            }

            let confirmProceed = true;
            if (appSettings.confirmDelete) confirmProceed = confirm(`Are you sure you want to delete class: "${classToDelete.name}"? This action cannot be undone.`);

            if (!confirmProceed) return;

            const activeAssignmentsUsingClass = assignments.filter(a => a.class === classToDelete.name && !a.archived);

            if (activeAssignmentsUsingClass.length > 0) {
                const availableClasses = classes.filter(c => !c.archived && c.id !== id);
                if (availableClasses.length === 0) {
                    showToast('Cannot delete this class: it has active assignments, and there are no other active classes to re-assign them to. Please add another class first or delete/archive all assignments.', 'error');
                    return;
                }

                const newClassName = prompt(`Class "${classToDelete.name}" has ${activeAssignmentsUsingClass.length} active assignment(s). Please enter the name of an existing active class to re-assign them to (e.g., '${UNCAT_CLASS_NAME}'):\nAvailable: ${availableClasses.map(c => c.name).join(', ')}`);

                if (newClassName === null) return;

                const targetClass = classes.find(c => c.name.toLowerCase() === newClassName.trim().toLowerCase() && !c.archived);
                if (!targetClass) {
                    showToast(`Invalid class name "${newClassName.trim()}". Please enter an existing ACTIVE class name.`, 'error');
                    return;
                }

                activeAssignmentsUsingClass.forEach(a => {
                    a.class = targetClass.name;
                    a.order = null;
                });
                saveAssignments();
                showToast(`Assignments from "${classToDelete.name}" reassigned to "${targetClass.name}".`, 'success');
            }

            classes = classes.filter(c => c.id !== id);
            normalizeClassOrder();
            saveClasses();
            renderClassList();
            populateClassDropdown(D.assignmentClassSelect);
            populateClassDropdown(D.detailsAssignmentClassSelect, true, false);
            showToast(`Class "${classToDelete.name}" deleted.`, 'success');
            navigate(currentView);
        }


        function loadAssignments() {
            assignments = AppStorage.load(ASSIGNMENTS_STORAGE_KEY) || [];
            assignments.forEach(a => {
                a.id = a.id || Date.now() + Math.random();
                a.text = a.text || 'Untitled Task';
                a.class = a.class || UNCAT_CLASS_NAME;
                a.dueDate = a.dueDate || null;
                a.completed = a.completed || false;
                a.archived = a.archived || false;
                a.order = a.order === undefined ? null : a.order;
                a.priority = a.priority || 'Medium';
                a.status = a.status || 'To Do';
                a.type = a.type || 'Homework';
                a.notes = a.notes || '';
                a.subtasks = a.subtasks || [];
                a.subtasks = a.subtasks.map(sub => ({
                    id: sub.id || Date.now() + Math.random(),
                    text: sub.text || 'New Subtask',
                    completed: sub.completed || false
                }));
            });
            saveAssignments();
        }

        function saveAssignments() {
            AppStorage.save(ASSIGNMENTS_STORAGE_KEY, assignments);
        }

        function formatDate(dateString) {
            if (!dateString) return 'No due date';
            try {
                const date = new Date(Date.parse(dateString + 'T00:00:00'));
                if (isNaN(date.getTime())) throw new Error('Invalid date');

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);

                let formattedDate;
                switch(appSettings.dateFormat) {
                    case 'DD/MM/YYYY': formattedDate = date.toLocaleDateString(undefined, { day: '2-digit', month: '2-digit', year: 'numeric' }); break;
                    case 'YYYY-MM-DD': formattedDate = date.toISOString().slice(0, 10); break;
                    case 'MM/DD/YYYY':
                    default: formattedDate = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }); break;
                }
                
                if (date.getTime() === today.getTime()) {
                    return 'Due Today';
                } else if (date.getTime() === tomorrow.getTime()) {
                    return 'Due Tomorrow';
                } else if (date < today) {
                    return `<span class="overdue">Overdue: ${formattedDate}</span>`;
                }

                return `Due: ${formattedDate}`;
            } catch (e) {
                return dateString;
            }
        }

        function addAssignment(text, selectedClass, dueDate, priority, status, type) {
            if (!text || text.trim() === '') { showToast('Assignment description cannot be empty.', 'error'); D.assignmentTextInput.focus(); return; }
            if (!selectedClass || selectedClass.trim() === '') { showToast('Please select a class.', 'error'); D.assignmentClassSelect.focus(); return; }

            const newAssignment = {
                id: Date.now(),
                text: text.trim(),
                class: selectedClass.trim(),
                dueDate: dueDate || null,
                completed: false,
                archived: false,
                order: null,
                priority: priority || 'Medium',
                status: status || 'To Do',
                type: type || 'Homework',
                notes: '',
                subtasks: []
            };
            assignments.push(newAssignment);
            saveAssignments();
            showToast('Assignment added successfully!', 'success');
            navigate(currentView);

            if (event.target === D.addAssignmentBtn) {
                 D.assignmentTextInput.value = '';
                 D.assignmentClassSelect.selectedIndex = 0;
                 D.assignmentDueDateInput.value = '';
                 D.assignmentPrioritySelect.value = 'Medium';
                 D.assignmentStatusSelect.value = 'To Do';
                 D.assignmentTypeSelect.value = 'Homework';
                 D.assignmentTextInput.focus();
            } else if (event.target === D.quickAddBtn) {
                 D.quickAddTextInput.value = '';
                 D.quickAddTextInput.focus();
            }
        }

        function toggleComplete(id) {
            const assignment = assignments.find(a => a.id === id);
            if (assignment) {
                assignment.completed = !assignment.completed;
                saveAssignments();
                showToast(`Task "${assignment.text}" ${assignment.completed ? 'completed' : 'uncompleted'}.`, 'info', 1500);
                if (D.hideCompletedCheckbox.checked && assignment.completed && currentView === 'list') {
                     renderAssignmentsList();
                } else {
                     navigate(currentView);
                }
            }
        }

        function archiveAssignment(id, shouldArchive = true) {
            const assignment = assignments.find(a => a.id === id);
            if (!assignment) return;
            let confirmProceed = true;
            if (appSettings.confirmDelete) confirmProceed = confirm(`Are you sure you want to ${shouldArchive ? 'archive' : 'unarchive'} assignment: "${assignment.text}"?`);

            if (!confirmProceed) return;

            const action = shouldArchive ? 'Archived' : 'Unarchived';
            assignment.archived = shouldArchive;
            assignment.archiveDate = shouldArchive ? new Date().toISOString() : null;
            saveAssignments();
            showToast(`Task "${assignment.text}" ${action}.`, 'info');
            closeModal(D.assignmentDetailsModal);
            navigate(currentView);
        }

        function deleteAssignment(id) {
            const assignmentToDelete = assignments.find(a => a.id === id);
            if (!assignmentToDelete) return;
            let confirmProceed = true;
            if (appSettings.confirmDelete) confirmProceed = confirm(`Are you sure you want to delete assignment: "${assignmentToDelete.text}"? This action cannot be undone.`);
            
            if (!confirmProceed) return;

            assignments = assignments.filter(a => a.id !== id);
            saveAssignments();
            showToast('Assignment deleted.', 'success');
            closeModal(D.assignmentDetailsModal);
            navigate(currentView);
        }

        let currentEditingAssignmentId = null;

        function openAssignmentDetails(id) {
            currentEditingAssignmentId = id;
            const assignment = assignments.find(a => a.id === id);
            if (!assignment) {
                showToast('Assignment not found.', 'error');
                return;
            }

            D.detailsAssignmentId.value = assignment.id;
            D.detailsAssignmentText.value = assignment.text;
            populateClassDropdown(D.detailsAssignmentClassSelect, true, false);
            D.detailsAssignmentClassSelect.value = assignment.class;
            D.detailsAssignmentDueDate.value = assignment.dueDate;
            D.detailsAssignmentPrioritySelect.value = assignment.priority;
            D.detailsAssignmentStatusSelect.value = assignment.status;
            D.detailsAssignmentTypeSelect.value = assignment.type;
            D.detailsAssignmentNotes.value = assignment.notes;
            renderSubtasks(assignment.subtasks);

            openModal(D.assignmentDetailsModal);
            D.detailsAssignmentText.focus();
        }

        function saveAssignmentDetails() {
            const assignment = assignments.find(a => a.id === currentEditingAssignmentId);
            if (!assignment) return;

            const newText = D.detailsAssignmentText.value.trim();
            if (newText === '') {
                showToast('Description cannot be empty.', 'error');
                D.detailsAssignmentText.focus();
                return;
            }

            assignment.text = newText;
            assignment.class = D.detailsAssignmentClassSelect.value;
            assignment.dueDate = D.detailsAssignmentDueDate.value || null;
            assignment.priority = D.detailsAssignmentPrioritySelect.value;
            assignment.status = D.detailsAssignmentStatusSelect.value;
            assignment.type = D.detailsAssignmentTypeSelect.value;
            assignment.notes = D.detailsAssignmentNotes.value;

            saveAssignments();
            showToast('Assignment details updated.', 'success');
            closeModal(D.assignmentDetailsModal);
            navigate(currentView);
        }
        D.saveAssignmentDetailsBtn.addEventListener('click', saveAssignmentDetails);

        function renderSubtasks(subtasks) {
            D.detailsSubtasksList.innerHTML = '';
            if (subtasks.length === 0) {
                D.detailsSubtasksList.innerHTML = '<li class="empty-message" style="margin-top:0;">No subtasks added yet.</li>';
            }
            subtasks.forEach(sub => {
                const li = document.createElement('li');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = sub.completed;
                checkbox.addEventListener('change', () => toggleSubtask(currentEditingAssignmentId, sub.id));
                checkbox.setAttribute('aria-label', `Mark subtask "${sub.text}" as complete`);

                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.value = sub.text;
                textInput.placeholder = 'Subtask description';
                textInput.addEventListener('blur', (e) => updateSubtaskText(currentEditingAssignmentId, sub.id, e.target.value));
                textInput.setAttribute('aria-label', `Subtask description: ${sub.text}`);


                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '‚úñ';
                deleteBtn.title = 'Delete subtask';
                deleteBtn.setAttribute('aria-label', `Delete subtask ${sub.text}`);
                deleteBtn.addEventListener('click', () => deleteSubtask(currentEditingAssignmentId, sub.id));

                li.appendChild(checkbox);
                li.appendChild(textInput);
                li.appendChild(deleteBtn);
                D.detailsSubtasksList.appendChild(li);
            });
            D.newSubtaskText.value = '';
        }

        function addSubtask() {
            const text = D.newSubtaskText.value.trim();
            if (text === '') {
                showToast('Subtask description cannot be empty.', 'error');
                return;
            }
            const assignment = assignments.find(a => a.id === currentEditingAssignmentId);
            if (assignment) {
                assignment.subtasks.push({ id: Date.now(), text: text, completed: false });
                saveAssignments();
                renderSubtasks(assignment.subtasks);
                showToast('Subtask added.', 'success', 1500);
            }
        }
        D.addSubtaskBtn.addEventListener('click', addSubtask);
        D.newSubtaskText.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addSubtask();
                e.preventDefault();
            }
        });


        function toggleSubtask(assignId, subId) {
            const assignment = assignments.find(a => a.id === assignId);
            if (assignment) {
                const subtask = assignment.subtasks.find(s => s.id === subId);
                if (subtask) {
                    subtask.completed = !subtask.completed;
                    saveAssignments();
                    showToast('Subtask updated.', 'info', 1000);
                }
            }
        }

        function updateSubtaskText(assignId, subId, newText) {
            const assignment = assignments.find(a => a.id === assignId);
            if (assignment) {
                const subtask = assignment.subtasks.find(s => s.id === subId);
                if (subtask) {
                    subtask.text = newText.trim();
                    saveAssignments();
                    showToast('Subtask text updated.', 'info', 1000);
                }
            }
        }

        function deleteSubtask(assignId, subId) {
            const assignment = assignments.find(a => a.id === assignId);
            if (!assignment) return;
            let confirmProceed = true;
            if (appSettings.confirmDelete) confirmProceed = confirm('Delete this subtask?');

            if (!confirmProceed) return;

            assignment.subtasks = assignment.subtasks.filter(s => s.id !== subId);
            saveAssignments();
            renderSubtasks(assignment.subtasks);
            showToast('Subtask deleted.', 'success');
        }


        function renderAssignmentsList() {
            D.assignmentListView.innerHTML = '';

            const searchTerm = D.searchInput.value.toLowerCase();
            const sortBy = D.sortBySelect.value;
            const filterStatus = D.filterStatusSelect.value;
            const filterPriority = D.filterPrioritySelect.value;
            const filterType = D.filterTypeSelect.value;
            const hideCompleted = D.hideCompletedCheckbox.checked;

            let filteredAssignments = assignments.filter(a => !a.archived);

            if (searchTerm) {
                filteredAssignments = filteredAssignments.filter(a =>
                    a.text.toLowerCase().includes(searchTerm) ||
                    (a.notes && a.notes.toLowerCase().includes(searchTerm)) ||
                    (a.class && a.class.toLowerCase().includes(searchTerm))
                );
            }

            if (filterStatus !== 'all') {
                filteredAssignments = filteredAssignments.filter(a => a.status === filterStatus);
            }

            if (filterPriority !== 'all') {
                filteredAssignments = filteredAssignments.filter(a => a.priority === filterPriority);
            }

            if (filterType !== 'all') {
                filteredAssignments = filteredAssignments.filter(a => a.type === filterType);
            }

            if (hideCompleted) {
                filteredAssignments = filteredAssignments.filter(a => !a.completed);
            }

            const groupedAssignments = filteredAssignments.reduce((acc, assignment) => {
                const className = assignment.class || UNCAT_CLASS_NAME;
                if (!acc[className]) acc[className] = [];
                acc[className].push(assignment);
                return acc;
            }, {});

            const allActiveClasses = classes.filter(c => !c.archived);
            const sortedClassNames = [...new Set([
                ...allActiveClasses.map(c => c.name),
                ...Object.keys(groupedAssignments)
            ])].filter(name => {
                const classObj = classes.find(c => c.name === name);
                const hasAssignments = (groupedAssignments[name] && groupedAssignments[name].length > 0);
                
                return (!classObj || !classObj.archived) && (hasAssignments || (name === UNCAT_CLASS_NAME && appSettings.showUncategorized));

            }).sort((nameA, nameB) => {
                 const classA = classes.find(c => c.name === nameA);
                 const classB = classes.find(c => c.name === nameB);
                 if (classA && classA.id === 'uncategorized') return 1;
                 if (classB && classB.id === 'uncategorized') return -1;
                 
                 const orderA = classA ? classA.order : Infinity;
                 const orderB = classB ? classB.order : Infinity;
                 return orderA - orderB || nameA.localeCompare(nameB);
             });


            if (filteredAssignments.length === 0 && sortedClassNames.length === 0) {
                 D.assignmentListView.innerHTML = '<p class="empty-message">No tasks matching your current filters and search! Try adjusting them. üêµ</p>';
                 return;
            }


            sortedClassNames.forEach(className => {
                const classGroupDiv = document.createElement('div');
                classGroupDiv.className = 'class-group';
                classGroupDiv.dataset.className = className;

                const classObj = classes.find(c => c.name === className);
                const bgColor = classObj ? classObj.color : '#a8d8ea';
                const textColorVar = getTextColorForBackground(bgColor);

                const classHeader = document.createElement('h3');
                classHeader.textContent = className;
                classHeader.style.backgroundColor = bgColor;
                classHeader.style.color = `var(${textColorVar})`;
                classHeader.draggable = (className !== UNCAT_CLASS_NAME);
                classHeader.addEventListener('dragstart', handleClassDragStart);
                classHeader.addEventListener('dragend', handleClassDragEnd);
                classHeader.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; handleClassDragOver(e); });
                classHeader.addEventListener('dragleave', handleClassDragLeave);
                classHeader.addEventListener('drop', handleClassDrop);


                classGroupDiv.appendChild(classHeader);

                const assignmentListUl = document.createElement('ul');
                assignmentListUl.className = 'assignment-list';
                if (sortBy === 'custom') {
                    assignmentListUl.addEventListener('dragover', handleAssignmentDragOver);
                    assignmentListUl.addEventListener('dragleave', handleAssignmentDragLeave);
                    assignmentListUl.addEventListener('drop', handleAssignmentDrop);
                } else {
                     assignmentListUl.removeEventListener('dragover', handleAssignmentDragOver);
                     assignmentListUl.removeEventListener('dragleave', handleAssignmentDragLeave);
                     assignmentListUl.removeEventListener('drop', handleAssignmentDrop);
                }


                const assignmentsInGroup = groupedAssignments[className] || [];

                assignmentsInGroup.sort((a, b) => {
                    if (sortBy === 'custom') {
                        if (a.order !== null && b.order !== null) {
                            return a.order - b.order;
                        }
                        if (a.order !== null) return -1;
                        if (b.order !== null) return 1;
                        return sortAssignmentsByPriorityDueDate(a,b) || sortAssignmentsByText(a,b);
                    } else if (sortBy === 'dueDate') {
                        return sortAssignmentsByDueDate(a, b);
                    } else if (sortBy === 'priority') {
                        return (PRIORITIES[b.priority] || 0) - (PRIORITIES[a.priority] || 0);
                    } else if (sortBy === 'text') {
                        return a.text.localeCompare(b.text);
                    } else if (sortBy === 'status') {
                         return a.status.localeCompare(b.status);
                    } else if (sortBy === 'type') {
                        return a.type.localeCompare(b.type);
                    } else if (sortBy === 'priorityDueDate') {
                        return sortAssignmentsByPriorityDueDate(a, b);
                    }
                    return 0;
                });


                if (assignmentsInGroup.length > 0) {
                    assignmentsInGroup.forEach(assignment => {
                        const listItem = document.createElement('li');
                        listItem.className = 'assignment-item';
                        listItem.dataset.assignmentId = assignment.id;
                        listItem.dataset.currentClass = assignment.class;
                        listItem.draggable = (sortBy === 'custom');
                        if (assignment.completed) listItem.classList.add('completed');

                        if (sortBy === 'custom') {
                            listItem.addEventListener('dragstart', handleAssignmentDragStart);
                            listItem.addEventListener('dragend', handleAssignmentDragEnd);
                        }


                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = assignment.completed;
                        checkbox.addEventListener('change', () => toggleComplete(assignment.id));
                        checkbox.setAttribute('aria-label', `Mark task "${assignment.text}" as complete`);


                        const detailsDiv = document.createElement('div');
                        detailsDiv.className = 'assignment-details';
                        detailsDiv.role = 'button';
                        detailsDiv.tabIndex = 0;
                        detailsDiv.setAttribute('aria-label', `View details for task ${assignment.text}`);
                        detailsDiv.addEventListener('click', () => openAssignmentDetails(assignment.id));
                        detailsDiv.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                openAssignmentDetails(assignment.id);
                            }
                        });


                        const textSpan = document.createElement('span');
                        textSpan.className = 'assignment-text';
                        textSpan.textContent = assignment.text;
                        detailsDiv.appendChild(textSpan);

                        const subInfoDiv = document.createElement('div');
                        subInfoDiv.className = 'assignment-sub-info';

                        const dueDateSpan = document.createElement('span');
                        dueDateSpan.className = 'assignment-due-date';
                        dueDateSpan.innerHTML = formatDate(assignment.dueDate);
                        subInfoDiv.appendChild(dueDateSpan);

                        const prioritySpan = document.createElement('span');
                        prioritySpan.className = 'assignment-priority';
                        prioritySpan.textContent = assignment.priority;
                        prioritySpan.dataset.priority = assignment.priority;
                        subInfoDiv.appendChild(prioritySpan);

                        const statusSpan = document.createElement('span');
                        statusSpan.className = 'assignment-status';
                        statusSpan.textContent = assignment.status;
                        statusSpan.dataset.status = assignment.status;
                        subInfoDiv.appendChild(statusSpan);

                        const typeSpan = document.createElement('span');
                        typeSpan.className = 'assignment-type';
                        typeSpan.textContent = assignment.type;
                        typeSpan.dataset.type = assignment.type;
                        subInfoDiv.appendChild(typeSpan);

                        detailsDiv.appendChild(subInfoDiv);

                        const actionsContainer = document.createElement('div');
                        actionsContainer.className = 'actions-container';

                        const editBtn = document.createElement('button');
                        editBtn.className = 'task-action-btn edit-btn';
                        editBtn.innerHTML = '‚úèÔ∏è';
                        editBtn.title = 'Edit task';
                        editBtn.setAttribute('aria-label', `Edit task ${assignment.text}`);
                        editBtn.addEventListener('click', (e) => { e.stopPropagation(); openAssignmentDetails(assignment.id); });
                        actionsContainer.appendChild(editBtn);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'task-action-btn delete-btn';
                        deleteBtn.innerHTML = 'Ôóë';
                        deleteBtn.title = 'Delete assignment';
                        deleteBtn.setAttribute('aria-label', `Delete task ${assignment.text}`);
                        deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteAssignment(assignment.id); });
                        actionsContainer.appendChild(deleteBtn);


                        listItem.appendChild(checkbox);
                        listItem.appendChild(detailsDiv);
                        listItem.appendChild(actionsContainer);
                        assignmentListUl.appendChild(listItem);
                    });
                } else if (className === UNCAT_CLASS_NAME && appSettings.showUncategorized) {
                    const messageLi = document.createElement('li');
                    messageLi.classList.add('empty-message');
                    messageLi.style.cssText = 'font-style: italic; color: var(--completed-color); text-align: center; border: none; margin: 10px;';
                    messageLi.textContent = 'No tasks in this category.';
                    assignmentListUl.appendChild(messageLi);
                }

                if (groupedAssignments[className] && groupedAssignments[className].length > 0 || (className === UNCAT_CLASS_NAME && appSettings.showUncategorized)) {
                    classGroupDiv.appendChild(assignmentListUl);
                    D.assignmentListView.appendChild(classGroupDiv);
                }
            });
        }

        function sortAssignmentsByDueDate(a, b) {
            const dateA = a.dueDate ? new Date(a.dueDate + 'T00:00:00') : null;
            const dateB = b.dueDate ? new Date(b.dueDate + 'T00:00:00') : null;

            if (dateA === null && dateB === null) return 0;
            if (dateA === null) return 1;
            if (dateB === null) return -1;
            return dateA - dateB;
        }

        function sortAssignmentsByText(a, b) {
             return a.text.localeCompare(b.text);
        }

        function sortAssignmentsByPriorityDueDate(a, b) {
            const priorityDiff = (PRIORITIES[b.priority] || 0) - (PRIORITIES[a.priority] || 0);
            if (priorityDiff !== 0) {
                return priorityDiff;
            }

            const dateComparison = sortAssignmentsByDueDate(a, b);
            if (dateComparison !== 0) {
                return dateComparison;
            }

            return sortAssignmentsByText(a, b);
        }

        function renderCalendar() {
            D.calendarGrid.innerHTML = '';
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            D.calendarMonthYear.textContent = `${MONTH_NAMES[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const assignmentsByDate = assignments.filter(a => !a.archived).reduce((acc, assign) => {
                if (assign.dueDate) {
                    const normalizedDate = new Date(assign.dueDate + 'T00:00:00');
                    if (!isNaN(normalizedDate.getTime())) {
                        const dateKey = normalizedDate.toISOString().slice(0, 10);
                        if (!acc[dateKey]) acc[dateKey] = [];
                        acc[dateKey].push(assign);
                    }
                }
                return acc;
            }, {});


            for (let i = 0; i < startDayOfWeek; i++) {
                const padCell = document.createElement('div');
                padCell.classList.add('calendar-day', 'other-month');
                D.calendarGrid.appendChild(padCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day');
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.dataset.date = dateKey;

                const dateNum = document.createElement('div');
                dateNum.classList.add('date-number');
                dateNum.textContent = day;
                dayCell.appendChild(dateNum);

                const currentDayCheck = new Date(year, month, day);
                currentDayCheck.setHours(0,0,0,0);
                if (currentDayCheck.getTime() === today.getTime()) {
                    dayCell.classList.add('today');
                }

                if (assignmentsByDate[dateKey]) {
                    const dailyAssignments = assignmentsByDate[dateKey];
                    dailyAssignments.sort((a,b) => (PRIORITIES[b.priority] || 0) - (PRIORITIES[a.priority] || 0));
                    const assignmentsList = document.createElement('ul');
                    assignmentsList.classList.add('calendar-assignments');
                    dailyAssignments.forEach(assign => {
                        const li = document.createElement('li');
                        const classObj = classes.find(c => c.name === assign.class);
                        li.textContent = assign.text;
                        li.style.borderLeftColor = classObj ? classObj.color : '#ccc';
                        li.title = `${assign.class}: ${assign.text} (Priority: ${assign.priority}, Status: ${assign.status}, Type: ${assign.type})`;
                        li.dataset.assignmentId = assign.id;
                        if (assign.completed) li.classList.add('completed');
                        li.addEventListener('click', () => openAssignmentDetails(assign.id));
                        assignmentsList.appendChild(li);
                    });
                    dayCell.appendChild(assignmentsList);
                }
                D.calendarGrid.appendChild(dayCell);
            }

            const totalCells = startDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                const padCell = document.createElement('div');
                padCell.classList.add('calendar-day', 'other-month');
                D.calendarGrid.appendChild(padCell);
            }
        }


        function renderArchivedView() {
            D.archivedList.innerHTML = '';
            const archivedItems = [
                ...classes.filter(c => c.archived),
                ...assignments.filter(a => a.archived)
            ].sort((a, b) => {
                 const dateA = a.archiveDate ? new Date(a.archiveDate) : new Date(0);
                 const dateB = b.archiveDate ? new Date(b.archiveDate) : new Date(0);
                 if (dateB.getTime() !== dateA.getTime()) return dateB.getTime() - dateA.getTime();

                 if (a.hasOwnProperty('name') && !b.hasOwnProperty('name')) return -1;
                 if (!a.hasOwnProperty('name') && b.hasOwnProperty('name')) return 1;

                 const nameA = (a.name || a.text || '').toLowerCase();
                 const nameB = (b.name || b.text || '').toLowerCase();
                 return nameA.localeCompare(nameB);
            });

            if (archivedItems.length === 0) {
                D.archivedList.innerHTML = '<p class="empty-message">No archived classes or assignments.</p>';
                return;
            }

            const ul = document.createElement('ul');
            ul.classList.add('class-list');

            archivedItems.forEach(item => {
                const li = document.createElement('li');
                const infoSpan = document.createElement('span');
                infoSpan.className = 'class-info';
                infoSpan.style.cursor = 'default';

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'class-actions';

                let iconHtml = '';
                if (item.hasOwnProperty('name')) {
                    const swatch = document.createElement('span');
                    swatch.className = 'color-swatch';
                    swatch.style.backgroundColor = item.color;
                    infoSpan.appendChild(swatch);
                    infoSpan.append(`[Class] ${item.name}`);
                    iconHtml = '<heroicons-ui/tag class="icon"/>';
                    const unarchiveBtn = document.createElement('button');
                    unarchiveBtn.className = 'class-action-btn archive-class-btn';
                    unarchiveBtn.innerHTML = 'üì¶';
                    unarchiveBtn.title = `Unarchive class "${item.name}"`;
                    unarchiveBtn.setAttribute('aria-label', `Unarchive class ${item.name}`);
                    unarchiveBtn.onclick = () => archiveClass(item.id, false);
                    actionsDiv.appendChild(unarchiveBtn);
                } else if (item.hasOwnProperty('text')) {
                    infoSpan.append(`[Task] ${item.text} (${item.class}, Due: ${formatDate(item.dueDate).replace(/<\/?span.*?>/g, '')})`);
                    iconHtml = '<heroicons-ui/check-list class="icon"/>';
                    const unarchiveBtn = document.createElement('button');
                    unarchiveBtn.className = 'task-action-btn edit-btn';
                    unarchiveBtn.innerHTML = 'üì§';
                    unarchiveBtn.title = `Unarchive task "${item.text}"`;
                    unarchiveBtn.setAttribute('aria-label', `Unarchive task ${item.text}`);
                    unarchiveBtn.onclick = () => archiveAssignment(item.id, false);
                    actionsDiv.appendChild(unarchiveBtn);
                }
                const iconContainer = document.createElement('span');
                iconContainer.classList.add('mr-1', 'flex', 'items-center', 'justify-center');
                iconContainer.innerHTML = iconHtml;
                li.appendChild(iconContainer);
                li.appendChild(infoSpan);
                li.appendChild(actionsDiv);
                ul.appendChild(li);
            });
            D.archivedList.appendChild(ul);
        }

         function getDragAfterElement(container, y, selector) {
            const draggableElements = [...container.querySelectorAll(`${selector}:not(.dragging)`)];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
         }

         function clearAllDragHighlights() {
            document.querySelectorAll('.class-group, .assignment-item').forEach(el => {
                el.classList.remove('drag-over-class', 'drag-over-item', 'drag-over-item-end', 'dragging-class-group');
            });
             document.querySelectorAll('.class-group h3').forEach(el => el.classList.remove('drag-over-header'));
         }


         function handleClassDragStart(e) {
             draggedItem = e.target.closest('.class-group');
             if (!draggedItem) return;
             if (draggedItem.dataset.className === UNCAT_CLASS_NAME) {
                 e.preventDefault();
                 return;
             }
             e.dataTransfer.setData('text/plain', `class:${draggedItem.dataset.className}`);
             e.dataTransfer.effectAllowed = 'move';
             setTimeout(() => draggedItem.classList.add('dragging', 'dragging-class-group'), 0);
         }

         function handleClassDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            clearAllDragHighlights();

            const draggedData = e.dataTransfer.getData('text/plain');
            if (!draggedData || !draggedData.startsWith('class:')) {
                return;
            }
             const draggedClassName = draggedData.substring(6);
             if (draggedClassName === UNCAT_CLASS_NAME) return;


             const container = D.assignmentListView;
             const allClassGroups = [...container.querySelectorAll('.class-group')];
             let afterElement = getDragAfterElement(container, e.clientY, '.class-group');

             if (afterElement && afterElement !== draggedItem) {
                if (afterElement.dataset.className === UNCAT_CLASS_NAME) {
                    const rect = afterElement.getBoundingClientRect();
                    if (e.clientY > rect.top + rect.height / 2) {
                        return;
                    }
                }
                afterElement.classList.add('drag-over-class');
             } else if (!afterElement && allClassGroups.length > 0 && draggedItem && allClassGroups.slice(-1)[0] !== draggedItem) {
                 const lastClassGroup = allClassGroups.slice(-1)[0];
                 if (lastClassGroup.dataset.className === UNCAT_CLASS_NAME) {
                    return;
                 }
                 const lastRect = lastClassGroup.getBoundingClientRect();
                 if (e.clientY > (lastRect.top + lastRect.height / 2)) {
                      lastClassGroup.classList.add('drag-over-class');
                 }
            }
         }
        function handleClassDragLeave(e) {
            const newTarget = document.elementFromPoint(e.clientX, e.clientY);
            if (!newTarget || (!newTarget.closest('.main-content') && !newTarget.closest('.modal-overlay'))) {
                 clearAllDragHighlights();
                 draggedItem = null;
            }
        }


         function handleClassDrop(e) {
            e.preventDefault();
            clearAllDragHighlights();

            const data = e.dataTransfer.getData('text/plain');
            if (!data.startsWith('class:')) { return; }
            const draggedClassName = data.substring(6);
            if (draggedClassName === UNCAT_CLASS_NAME) return;

            const container = D.assignmentListView;
            let afterElement = getDragAfterElement(container, e.clientY, '.class-group');
            let targetClassName = null;

            if (afterElement) {
                if (afterElement.dataset.className === UNCAT_CLASS_NAME) {
                    const rect = afterElement.getBoundingClientRect();
                    if (e.clientY < rect.top + rect.height / 2) {
                       targetClassName = afterElement.dataset.className;
                    } else {
                       return;
                    }
                } else {
                    targetClassName = afterElement.dataset.className;
                }
            } else {
                const allClassGroups = [...container.querySelectorAll('.class-group')];
                if (allClassGroups.length > 0) {
                    const lastClassGroup = allClassGroups.slice(-1)[0];
                    if (lastClassGroup.dataset.className === UNCAT_CLASS_NAME) {
                        return;
                    }
                }
                targetClassName = null;
            }


            if (draggedClassName) {
                 updateClassOrder(draggedClassName, targetClassName);
            }
             draggedItem = null;
         }

         function updateClassOrder(draggedName, targetName) {
            const draggedIndex = classes.findIndex(c => c.name === draggedName);
             if (draggedIndex === -1) return;

             const draggedClass = classes.splice(draggedIndex, 1)[0];

             if (targetName === null) {
                 const uncategorizedIndex = classes.findIndex(c => c.id === 'uncategorized');
                 if (uncategorizedIndex !== -1) {
                     classes.splice(uncategorizedIndex, 0, draggedClass);
                 } else {
                     classes.push(draggedClass);
                 }
             } else {
                 const targetIndex = classes.findIndex(c => c.name === targetName);
                 if (targetIndex !== -1) {
                     classes.splice(targetIndex, 0, draggedClass);
                 } else {
                      classes.push(draggedClass);
                 }
             }
             normalizeClassOrder();
             saveClasses();
             showToast(`Class "${draggedName}" reordered.`, 'info', 1500);
             navigate(currentView);
         }

         function handleClassDragEnd(e) {
            clearAllDragHighlights();
             if (draggedItem) draggedItem.classList.remove('dragging', 'dragging-class-group');
             draggedItem = null;
         }


         function handleAssignmentDragStart(e) {
             if (D.sortBySelect.value !== 'custom') {
                 e.preventDefault();
                 return;
             }

             draggedItem = e.target.closest('.assignment-item');
             if(!draggedItem) return;
             e.dataTransfer.setData('text/plain', `assignment:${draggedItem.dataset.assignmentId}`);
             e.dataTransfer.effectAllowed = 'move';
              setTimeout(() => draggedItem.classList.add('dragging'), 0);
         }

         function handleAssignmentDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            clearAllDragHighlights();

            const currentTargetElement = e.target.closest('.assignment-item') || e.target.closest('.assignment-list') || e.target.closest('.class-group h3');
            if (!currentTargetElement) return;

            let targetList = currentTargetElement.closest('.assignment-list');
            let targetHeader = currentTargetElement.closest('.class-group h3');

            if (targetList) {
                const afterElement = getDragAfterElement(targetList, e.clientY, '.assignment-item');

                const assignmentsInCurrentList = [...targetList.querySelectorAll('.assignment-item')];
                const lastAssignmentItem = assignmentsInCurrentList.slice(-1)[0];

                if (afterElement && afterElement !== draggedItem) {
                    afterElement.classList.add('drag-over-item');
                } else if (lastAssignmentItem && lastAssignmentItem !== draggedItem) {
                    const rect = lastAssignmentItem.getBoundingClientRect();
                    if (e.clientY > rect.top + rect.height / 2) {
                         lastAssignmentItem.classList.add('drag-over-item-end');
                    } else {
                         const firstAssignmentItem = assignmentsInCurrentList[0];
                         if (firstAssignmentItem && firstAssignmentItem !== draggedItem) {
                             firstAssignmentItem.classList.add('drag-over-item');
                         }
                    }
                } else {
                    targetList.closest('.class-group').classList.add('drag-over-class');
                }
            } else if (targetHeader) {
                targetHeader.classList.add('drag-over-header');
                const associatedList = targetHeader.nextElementSibling;
                if (associatedList && associatedList.children.length === 0) {
                    targetHeader.closest('.class-group').classList.add('drag-over-class');
                }
            }
        }


        function handleAssignmentDragLeave(e) {
            const newTarget = document.elementFromPoint(e.clientX, e.clientY);

            if (!newTarget || (!newTarget.closest('.class-group') && !newTarget.closest('.modal-overlay') && !newTarget.closest('.main-content'))) {
                clearAllDragHighlights();
            } else {
                const groupElement = e.target.closest('.class-group');
                if (groupElement) {
                    const hoveredItem = newTarget.closest('.assignment-item');
                    const hoveredHeader = newTarget.closest('.class-group h3');
                    if (!hoveredItem && !hoveredHeader) {
                        groupElement.classList.add('drag-over-class');
                    } else {
                        groupElement.classList.remove('drag-over-class');
                        if (hoveredItem) { hoveredItem.classList.remove('drag-over-item', 'drag-over-item-end'); }
                        if (hoveredHeader) { hoveredHeader.classList.remove('drag-over-header'); }
                    }
                }
            }
        }

        function handleAssignmentDrop(e) {
            e.preventDefault();
            clearAllDragHighlights();

            const draggedData = e.dataTransfer.getData('text/plain');
            if (!draggedData || !draggedData.startsWith('assignment:')) {
                return;
            }
            const draggedId = parseInt(draggedData.substring(11));

            const sourceAssignment = assignments.find(a => a.id === draggedId);
            if (!sourceAssignment) return;

            let targetClassName = null;
            let targetAssignmentId = null;

            const targetList = e.target.closest('.assignment-list');
            const targetHeader = e.target.closest('.class-group h3');
            const targetGroupDiv = targetList ? targetList.closest('.class-group') : (targetHeader ? targetHeader.closest('.class-group') : null);

            if (!targetGroupDiv) {
                showToast('Invalid drop target for assignment. Must be within a class list or on a class header.', 'error');
                return;
            }
            targetClassName = targetGroupDiv.dataset.className;

            if (targetList) {
                const afterElement = getDragAfterElement(targetList, e.clientY, '.assignment-item');
                targetAssignmentId = afterElement ? parseInt(afterElement.dataset.assignmentId) : null;
            } else if (targetHeader) {
                targetAssignmentId = null;
            }

            updateAssignmentOrder(draggedId, targetAssignmentId, targetClassName);
            draggedItem = null;
        }

        function updateAssignmentOrder(draggedId, targetId, targetClassName) {
            const draggedAssignment = assignments.find(a => a.id === draggedId);
            if (!draggedAssignment) return;

            assignments = assignments.filter(a => a.id !== draggedId);

            let currentClassAssignments = assignments.filter(a => (a.class || UNCAT_CLASS_NAME) === (draggedAssignment.class || UNCAT_CLASS_NAME));
            let targetClassAssignments = assignments.filter(a => (a.class || UNCAT_CLASS_NAME) === targetClassName);

            if ((draggedAssignment.class || UNCAT_CLASS_NAME) !== targetClassName) {
                draggedAssignment.class = targetClassName;

                if (targetId === null) {
                    targetClassAssignments.unshift(draggedAssignment);
                } else {
                    const targetIndex = targetClassAssignments.findIndex(a => a.id === targetId);
                    if (targetIndex !== -1) {
                        targetClassAssignments.splice(targetIndex, 0, draggedAssignment);
                    } else {
                        targetClassAssignments.push(draggedAssignment);
                    }
                }

                currentClassAssignments.forEach((a, idx) => a.order = idx);
                targetClassAssignments.forEach((a, idx) => a.order = idx);

                assignments = assignments.filter(a =>
                    ((a.class || UNCAT_CLASS_NAME) !== (draggedAssignment.class || UNCAT_CLASS_NAME) || a.id === draggedId) &&
                    ((a.class || UNCAT_CLASS_NAME) !== targetClassName || a.id === draggedId)
                ).concat(currentClassAssignments, targetClassAssignments.filter(a => a.id !== draggedId)).sort((a,b) => {
                    const classA = classes.find(c => c.name === (a.class || UNCAT_CLASS_NAME));
                    const classB = classes.find(c => c.name === (b.class || UNCAT_CLASS_NAME));
                    return (classA ? classA.order : Infinity) - (classB ? classB.order : Infinity);
                });


            } else {
                if (targetId === null) {
                    targetClassAssignments.unshift(draggedAssignment);
                } else {
                    const targetIndex = targetClassAssignments.findIndex(a => a.id === targetId);
                    if (targetIndex !== -1) {
                        targetClassAssignments.splice(targetIndex, 0, draggedAssignment);
                    } else {
                        targetClassAssignments.push(draggedAssignment);
                    }
                }
                targetClassAssignments.forEach((a, idx) => a.order = idx);
                assignments = assignments.filter(a => (a.class || UNCAT_CLASS_NAME) !== targetClassName).concat(targetClassAssignments);
            }

            saveAssignments();
            showToast(`Task "${draggedAssignment.text}" moved.`, 'info', 1500);
            navigate(currentView);
        }


        function handleAssignmentDragEnd(e) {
            clearAllDragHighlights();
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        }


        let currentActiveNav = D.navList;
        function setActiveNav(newActiveNav) {
            if (currentActiveNav) {
                currentActiveNav.classList.remove('active');
            }
            newActiveNav.classList.add('active');
            currentActiveNav = newActiveNav;
        }

        function navigate(viewName, plannerSubTab = 'plan', settingsSubTab = 'appearance') {
            currentView = viewName;
            currentPlannerTab = plannerSubTab;
            currentSettingsTab = settingsSubTab;

            D.classesView.style.display = 'none';
            D.quickAddContainer.style.display = 'none';
            D.addAssignmentFormContainer.style.display = 'none';
            D.filterSortBar.style.display = 'none';
            D.assignmentListView.style.display = 'none';
            D.calendarView.style.display = 'none';
            D.academicPlannerView.style.display = 'none';
            D.archivedView.style.display = 'none';
            D.settingsView.style.display = 'none';

            D.viewListBtn.classList.remove('active');
            D.viewCalendarBtn.classList.remove('active');

            let navToActivate = null;
            if (viewName === 'list') navToActivate = D.navList;
            else if (viewName === 'calendar') navToActivate = D.navCalendar;
            else if (viewName === 'classes') navToActivate = D.navClasses;
            else if (viewName === 'planner') navToActivate = D.navPlanner;
            else if (viewName === 'archived') navToActivate = D.navArchived;
            else if (viewName === 'settings') navToActivate = D.navSettings;
            setActiveNav(navToActivate);

            if (viewName === 'list') {
                D.assignmentListView.style.display = 'block';
                D.viewListBtn.classList.add('active');
                D.quickAddContainer.style.display = 'flex';
                D.addAssignmentFormContainer.style.display = 'block';
                D.filterSortBar.style.display = 'flex';
                renderAssignmentsList();
            } else if (viewName === 'calendar') {
                D.calendarView.style.display = 'block';
                D.viewCalendarBtn.classList.add('active');
                renderCalendar();
            } else if (viewName === 'classes') {
                D.classesView.style.display = 'block';
                renderClassList();
                populateClassDropdown(D.assignmentClassSelect);
                populateClassDropdown(D.detailsAssignmentClassSelect, true, false);
            } else if (viewName === 'planner') {
                D.academicPlannerView.style.display = 'block';
                setActivePlannerTab(plannerSubTab);
            } else if (viewName === 'archived') {
                D.archivedView.style.display = 'block';
                renderArchivedView();
            } else if (viewName === 'settings') {
                D.settingsView.style.display = 'block';
                setActiveSettingsTab(settingsSubTab);
                calculateStats();
            }
        }

        function calculateStats() {
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            const activeAssignments = assignments.filter(a => !a.archived);

            let total = activeAssignments.length;
            let completed = activeAssignments.filter(a => a.completed).length;
            let pending = activeAssignments.filter(a => !a.completed).length;
            let overdue = activeAssignments.filter(a => !a.completed && a.dueDate && new Date(a.dueDate + 'T00:00:00') < now).length;

            D.totalAssignmentsSpan.textContent = total;
            D.completedAssignmentsSpan.textContent = completed;
            D.pendingAssignmentsSpan.textContent = pending;
            D.overdueAssignmentsSpan.textContent = overdue;

            const classCounts = activeAssignments.reduce((acc, assignment) => {
                acc[assignment.class] = (acc[assignment.class] || 0) + 1;
                return acc;
            }, {});

            D.frequentClassesList.innerHTML = '';
            const sortedClassCounts = Object.entries(classCounts).sort(([, countA], [, countB]) => countB - countA);

            if (sortedClassCounts.length === 0) {
                 D.frequentClassesList.innerHTML = '<li>No classes with active assignments.</li>';
            } else {
                 sortedClassCounts.slice(0, 5).forEach(([className, count]) => {
                    const li = document.createElement('li');
                    li.textContent = `${className}: ${count}`;
                    D.frequentClassesList.appendChild(li);
                });
            }
        }

        function loadPlannerCourses() {
            plannerCourses = AppStorage.load(PLANNER_COURSES_STORAGE_KEY) || [];
            plannerCourses.forEach(course => {
                course.grades = course.grades || { q1: null, q2: null, q3: null, q4: null, midterm: null, final: null, semesterAvg: null };
                course.finalGradeOverride = course.finalGradeOverride || false;
                course.status = course.status || 'Planned';
            });
            savePlannerCourses();
        }

        function savePlannerCourses() {
            AppStorage.save(PLANNER_COURSES_STORAGE_KEY, plannerCourses);
        }

        function addPlannerCourse() {
            const name = D.newCourseNameInput.value.trim();
            const year = D.newCourseYearSelect.value;
            const semester = D.newCourseSemesterSelect.value;
            const level = D.newCourseLevelSelect.value;
            const credits = parseFloat(D.newCourseCreditsSelect.value);
            const subject = D.newCourseSubjectInput.value.trim();

            if (!name || !year || !semester || !level || isNaN(credits) || !subject) {
                showToast('Please fill all course fields.', 'error');
                return;
            }
             if (plannerCourses.some(c => c.name.toLowerCase() === name.toLowerCase() && c.year === year && c.semester === semester)) {
                showToast(`Course "${name}" for ${semester} ${year} already exists.`, 'error');
                return;
            }

            const newCourse = {
                id: Date.now(),
                name, year, semester, level, credits, subject,
                grades: { q1: null, q2: null, q3: null, q4: null, midterm: null, final: null, semesterAvg: null },
                finalGradeOverride: false,
                status: 'Planned'
            };
            plannerCourses.push(newCourse);
            savePlannerCourses();
            renderAcademicPlannerContent();
            D.newCourseNameInput.value = '';
            D.newCourseYearSelect.value = '';
            D.newCourseSemesterSelect.value = '';
            D.newCourseLevelSelect.value = 'Standard';
            D.newCourseCreditsSelect.value = '1.0';
            D.newCourseSubjectInput.value = '';
            showToast('Course added to plan!', 'success');
        }

        function deletePlannerCourse(id) {
            let confirmProceed = true;
            if (appSettings.confirmDelete) confirmProceed = confirm('Are you sure you want to delete this course from your plan? This action cannot be undone.');

            if (!confirmProceed) return;

            plannerCourses = plannerCourses.filter(c => c.id !== id);
            savePlannerCourses();
            renderAcademicPlannerContent();
            showToast('Course deleted from plan.', 'success');
        }

        let currentEditingPlannerCourseId = null;
        function openCourseGradesModal(id) {
            currentEditingPlannerCourseId = id;
            const course = plannerCourses.find(c => c.id === id);
            if (!course) {
                showToast('Course not found.', 'error');
                return;
            }
            D.currentCourseNameSpan.textContent = course.name;
            D.currentCourseIdInput.value = course.id;
            D.plannerCourseStatusSelect.value = course.status;

            currentGradeFormat = 'percent';
            D.gradeFormatPercent.checked = true;
            D.gradeFormatLetter.checked = false;

            renderGradeInputs(course.grades, currentGradeFormat);

            D.manualSemesterAverageInput.value = typeof course.grades.semesterAvg === 'number' ? course.grades.semesterAvg : '';
            D.gradeOverrideToggle.checked = course.finalGradeOverride;
            
            updateCalculatedAverageDisplay();

            D.manualSemesterAverageInput.removeEventListener('input', updateCalculatedAverageDisplay);
            D.manualSemesterAverageInput.addEventListener('input', updateCalculatedAverageDisplay);
            D.gradeOverrideToggle.removeEventListener('change', updateCalculatedAverageDisplay);
            D.gradeOverrideToggle.addEventListener('change', updateCalculatedAverageDisplay);
            
            updateGradeComponentWeightsDisplay();
            
            openModal(D.plannerCourseGradesModal);
        }
        
        function renderGradeInputs(gradesData, format) {
            let html = '';
            const components = ['q1', 'q2', 'q3', 'q4', 'midterm', 'final'];
            
            components.forEach(comp => {
                const labelText = comp.replace(/(\b\w)/g, s => s.toUpperCase()).replace('q','Q');

                let inputHtml = '';
                if (format === 'percent') {
                    const value = typeof gradesData[comp] === 'number' ? gradesData[comp] : '';
                    inputHtml = `<input type="number" id="grade-${comp}-input" class="grade-input" min="0" max="100" step="0.1" value="${value}" aria-label="${labelText} grade percentage">`;
                } else {
                    const currentPercent = typeof gradesData[comp] === 'number' ? gradesData[comp] : null;
                    const currentValueLetter = getLetterFromPercentage(currentPercent);
                    
                    inputHtml = `
                        <select id="grade-${comp}-input" class="grade-input" aria-label="${labelText} grade letter">
                            <option value="">--</option>
                            ${Object.keys(FCPS_GRADE_MAP).map(grade => `<option value="${grade}" ${currentValueLetter === grade ? 'selected' : ''}>${grade}</option>`).join('')}
                        </select>
                    `;
                }

                html += `
                    <div class="grade-component">
                        <label for="grade-${comp}-input">${labelText} Grade:</label>
                        ${inputHtml}
                    </div>
                `;
            });
            D.gradeInputsContainer.innerHTML = html;

            D.gradeQ1Input = document.getElementById('grade-q1-input');
            D.gradeQ2Input = document.getElementById('grade-q2-input');
            D.gradeQ3Input = document.getElementById('grade-q3-input');
            D.gradeQ4Input = document.getElementById('grade-q4-input');
            D.gradeMidtermInput = document.getElementById('grade-midterm-input');
            D.gradeFinalExamInput = document.getElementById('grade-final-exam-input');

            document.querySelectorAll('#grade-inputs-container .grade-input').forEach(input => {
                input.removeEventListener('input', updateCalculatedAverageDisplay);
                input.addEventListener('input', updateCalculatedAverageDisplay);
            });
        }


        function convertLetterToPercent(letter) {
            const gradeInfo = FCPS_GRADE_MAP[letter];
            return gradeInfo ? (gradeInfo.range[0] + gradeInfo.range[1]) / 2 : null;
        }

        function updateGradeComponentWeightsDisplay() {
            const weights = appSettings.defaultGradeWeights;
            D.displayWeightQ1.textContent = weights.q1;
            D.displayWeightQ2.textContent = weights.q2;
            D.displayWeightQ3.textContent = weights.q3;
            D.displayWeightQ4.textContent = weights.q4;
            D.displayWeightMidterm.textContent = weights.midterm;
            D.displayWeightFinal.textContent = weights.final;
        }

        function calculateCourseSemesterAverage(courseId) {
            const course = plannerCourses.find(c => c.id === courseId);
            if (!course) return null;

            const q1Raw = D.gradeQ1Input?.value;
            const q2Raw = D.gradeQ2Input?.value;
            const q3Raw = D.gradeQ3Input?.value;
            const q4Raw = D.gradeQ4Input?.value;
            const midtermRaw = D.gradeMidtermInput?.value;
            const finalRaw = D.gradeFinalExamInput?.value;

            let q1, q2, q3, q4, midterm, final;

            const convertToPercentage = (rawVal) => {
                if (rawVal === '') return null;
                if (currentGradeFormat === 'percent') {
                    const val = parseFloat(rawVal);
                    return isNaN(val) ? null : val;
                } else {
                    return convertLetterToPercent(rawVal);
                }
            };

            q1 = convertToPercentage(q1Raw);
            q2 = convertToPercentage(q2Raw);
            q3 = convertToPercentage(q3Raw);
            q4 = convertToPercentage(q4Raw);
            midterm = convertToPercentage(midtermRaw);
            final = convertToPercentage(finalRaw);

            const weights = appSettings.defaultGradeWeights;
            let totalWeightedSum = 0;
            let actualTotalWeight = 0;

            const components = [
                { value: q1, weight: weights.q1 },
                { value: q2, weight: weights.q2 },
                { value: q3, weight: weights.q3 },
                { value: q4, weight: weights.q4 },
                { value: midterm, weight: weights.midterm },
                { value: final, weight: weights.final }
            ];

            components.forEach(comp => {
                if (typeof comp.value === 'number' && !isNaN(comp.value) && comp.value >= 0 && comp.value <= 100 && comp.weight > 0) {
                    totalWeightedSum += comp.value * (comp.weight / 100);
                    actualTotalWeight += comp.weight / 100;
                }
            });
            
            if (actualTotalWeight === 0) {
                return null;
            } else {
                return totalWeightedSum / actualTotalWeight;
            }
        }


        function updateCalculatedAverageDisplay() {
            const course = plannerCourses.find(c => c.id === currentEditingPlannerCourseId);
            if (!course) return;

            const manualAvg = parseFloat(D.manualSemesterAverageInput.value) || null;
            const overrideEnabled = D.gradeOverrideToggle.checked;

            if (overrideEnabled && typeof manualAvg === 'number' && !isNaN(manualAvg)) {
                D.calculatedAverageDisplay.textContent = `Calculated Grade: ${manualAvg.toFixed(2)}% (Manual Override)`;
                return;
            }

            const avg = calculateCourseSemesterAverage(course.id);
            if (typeof avg === 'number' && !isNaN(avg)) {
                 D.calculatedAverageDisplay.textContent = `Calculated Grade: ${avg.toFixed(2)}%`;
            } else {
                 D.calculatedAverageDisplay.textContent = 'Calculated Grade: N/A';
            }
        }

        function saveCourseGrades() {
            const course = plannerCourses.find(c => c.id === currentEditingPlannerCourseId);
            if (!course) return;

            const getInputValue = (element) => {
                if (!element) return null;
                if (element.tagName === 'SELECT') {
                    return element.value === '' ? null : element.value;
                } else {
                    const val = parseFloat(element.value);
                    return isNaN(val) ? null : val;
                }
            };

            course.grades.q1 = getInputValue(D.gradeQ1Input);
            course.grades.q2 = getInputValue(D.gradeQ2Input);
            course.grades.q3 = getInputValue(D.gradeQ3Input);
            course.grades.q4 = getInputValue(D.gradeQ4Input);
            course.grades.midterm = getInputValue(D.gradeMidtermInput);
            course.grades.final = getInputValue(D.gradeFinalExamInput);
            
            course.finalGradeOverride = D.gradeOverrideToggle.checked;
            if (course.finalGradeOverride) {
                 const manualAvg = parseFloat(D.manualSemesterAverageInput.value);
                 course.grades.semesterAvg = isNaN(manualAvg) ? null : manualAvg;
                 if (course.grades.semesterAvg === null) {
                    showToast('Manual override is enabled but no valid number provided. Please enter a numerical average (0-100).', 'error');
                    return;
                 }
            } else {
                 course.grades.semesterAvg = calculateCourseSemesterAverage(course.id);
            }

            course.status = D.plannerCourseStatusSelect.value;

            savePlannerCourses();
            closeModal(D.plannerCourseGradesModal);
            showToast('Grades & course status saved!', 'success');
            renderAcademicPlannerContent();
        }
        D.savePlannerGradesBtn.addEventListener('click', saveCourseGrades);

        function getLetterFromPercentage(percentage) {
            if (percentage === null || isNaN(percentage)) return 'N/A';
            for (const gradeLetter in FCPS_GRADE_MAP) {
                const gradeInfo = FCPS_GRADE_MAP[gradeLetter];
                if (percentage >= gradeInfo.range[0] && (percentage < gradeInfo.range[1] || (gradeLetter === 'A' && percentage === 100))) {
                    return gradeLetter;
                }
            }
            return 'F';
        }

        function getGPAPoints(letterGrade, level) {
            let baseGpa;
            if (appSettings.gpaScale === 'fcps') {
                baseGpa = FCPS_GRADE_MAP[letterGrade]?.gpa;
            } else {
                baseGpa = appSettings.customGpaPoints[letterGrade];
            }
            
            if (baseGpa === undefined || isNaN(baseGpa)) return 0;
            
            if (appSettings.gpaScale === 'fcps') {
                return baseGpa + (FCPS_WEIGHTED_MULTIPLIER[level] || 0);
            } else {
                return baseGpa;
            }
        }

        function calculateGPA() {
            let totalWeightedPoints = 0;
            let totalUnweightedPoints = 0;
            let totalCredits = 0;

            plannerCourses.filter(c => typeof c.grades.semesterAvg === 'number' && !isNaN(c.grades.semesterAvg)).forEach(course => {
                const semesterAvg = course.grades.semesterAvg;
                const credits = course.credits;
                const level = course.level;

                const letterGrade = getLetterFromPercentage(semesterAvg);
                if (letterGrade === 'N/A' || (appSettings.gpaScale === 'custom' && appSettings.customGpaPoints[letterGrade] === undefined)) return;

                if (appSettings.gpaScale === 'fcps') {
                    const unweightedGpaPoints = FCPS_GRADE_MAP[letterGrade]?.gpa;
                    const weightedGpaPoints = getGPAPoints(letterGrade, level);

                    if (typeof unweightedGpaPoints === 'number') {
                        totalUnweightedPoints += unweightedGpaPoints * credits;
                        totalWeightedPoints += weightedGpaPoints * credits;
                        totalCredits += credits;
                    }
                } else {
                    const customGpaPoints = appSettings.customGpaPoints[letterGrade];
                    if (typeof customGpaPoints === 'number') {
                         totalUnweightedPoints += customGpaPoints * credits;
                         totalWeightedPoints += customGpaPoints * credits;
                         totalCredits += credits;
                    }
                }
            });

            if (totalCredits === 0) {
                return { unweighted: '0.00', weighted: '0.00', totalCredits: '0.00' };
            }

            const calculatedUnweighted = (totalUnweightedPoints / totalCredits).toFixed(2);
            const calculatedWeighted = (totalWeightedPoints / totalCredits).toFixed(2);

            return {
                unweighted: calculatedUnweighted,
                weighted: appSettings.gpaScale === 'fcps' ? calculatedWeighted : calculatedUnweighted,
                totalCredits: totalCredits.toFixed(2)
            };
        }


        function renderGPA() {
            const gpaResults = calculateGPA();

            D.overallGpaDisplay.textContent = currentGPAType === 'weighted' ? gpaResults.weighted : gpaResults.unweighted;
            D.totalCreditsDisplay.textContent = gpaResults.totalCredits;

            if (appSettings.gpaScale === 'custom') {
                 D.gpaTypeWeightedBtn.textContent = 'Unweighted (No Weight)';
                 if (currentGPAType === 'weighted') {
                     setActiveGPAType('unweighted');
                     return;
                 }
            } else {
                 D.gpaTypeWeightedBtn.textContent = 'Weighted (FCPS)';
            }

            D.gpaByYearSemesterDisplay.innerHTML = '';
            const coursesByYear = plannerCourses.reduce((acc, course) => {
                if (!acc[course.year]) acc[course.year] = {};
                if (!acc[course.year][course.semester]) acc[course.year][course.semester] = [];
                acc[course.year][course.semester].push(course);
                return acc;
            }, {});

            const sortedYears = Object.keys(coursesByYear).sort((a,b) => {
                const yearOrder = { '9th Grade': 0, '10th Grade': 1, '11th Grade': 2, '12th Grade': 3 };
                return (yearOrder[a] || Infinity) - (yearOrder[b] || Infinity);
            });

            if (Object.keys(coursesByYear).length === 0 || plannerCourses.filter(c => typeof c.grades.semesterAvg === 'number').length === 0) {
                 D.gpaByYearSemesterDisplay.innerHTML = '<p class="empty-message">Add courses and grades to see your GPA here!</p>';
                 return;
            }


            sortedYears.forEach(year => {
                const yearDiv = document.createElement('div');
                yearDiv.className = 'year-section';

                let yearTotalWeightedPoints = 0;
                let yearTotalUnweightedPoints = 0;
                let yearTotalCredits = 0;

                const yearSemesterOrder = { 'Fall': 0, 'Spring': 1, 'Full-Year': 2 };
                const sortedSemesters = Object.keys(coursesByYear[year]).sort((a,b) => yearSemesterOrder[a] - yearSemesterOrder[b]);

                if (sortedSemesters.length === 0) return;

                const semesterFragments = document.createDocumentFragment();

                sortedSemesters.forEach(semester => {
                    const semesterDiv = document.createElement('div');
                    semesterDiv.className = 'semester-section';

                    let semesterPoints = 0;
                    let semesterCredits = 0;
                    let semesterUnweightedPoints = 0;

                    const semesterCourses = coursesByYear[year][semester];
                    semesterCourses.forEach(course => {
                        if (typeof course.grades.semesterAvg === 'number' && !isNaN(course.grades.semesterAvg)) {
                            const letter = getLetterFromPercentage(course.grades.semesterAvg);
                            if (letter !== 'N/A' && (appSettings.gpaScale !== 'custom' || appSettings.customGpaPoints[letter] !== undefined)) {
                                if (appSettings.gpaScale === 'fcps') {
                                    semesterUnweightedPoints += FCPS_GRADE_MAP[letter].gpa * course.credits;
                                    semesterPoints += getGPAPoints(letter, course.level) * course.credits;
                                } else {
                                    semesterUnweightedPoints += appSettings.customGpaPoints[letter] * course.credits;
                                    semesterPoints += appSettings.customGpaPoints[letter] * course.credits;
                                }
                                semesterCredits += course.credits;
                            }
                        }
                    });

                    let semesterGpa;
                    if (semesterCredits === 0) {
                         semesterGpa = 'N/A';
                    } else if (appSettings.gpaScale === 'fcps') {
                        semesterGpa = currentGPAType === 'weighted' ? (semesterPoints / semesterCredits).toFixed(2) : (semesterUnweightedPoints / semesterCredits).toFixed(2);
                    } else {
                        semesterGpa = (semesterUnweightedPoints / semesterCredits).toFixed(2);
                    }

                    semesterDiv.innerHTML = `<h4>${semester} <span class="semester-gpa">GPA: ${semesterGpa} (${semesterCredits.toFixed(2)} Cr)</span></h4>`;

                    yearTotalWeightedPoints += semesterPoints;
                    yearTotalUnweightedPoints += semesterUnweightedPoints;
                    yearTotalCredits += semesterCredits;

                    semesterFragments.appendChild(semesterDiv);
                });

                let yearGpa;
                if (yearTotalCredits === 0) {
                    yearGpa = 'N/A';
                } else if (appSettings.gpaScale === 'fcps') {
                    yearGpa = currentGPAType === 'weighted' ? (yearTotalWeightedPoints / yearTotalCredits).toFixed(2) : (yearTotalUnweightedPoints / yearTotalCredits).toFixed(2);
                } else {
                    yearGpa = (yearTotalUnweightedPoints / yearTotalCredits).toFixed(2);
                }

                yearDiv.innerHTML = `<h3>${year} <span class="year-gpa">Year GPA: ${yearGpa} (${yearTotalCredits.toFixed(2)} Cr)</span></h3>`;
                yearDiv.appendChild(semesterFragments);
                D.gpaByYearSemesterDisplay.appendChild(yearDiv);
            });
        }

        function calculateFinalNeeded() {
            D.finalPredictorResult.style.display = 'none';
            const currentAvg = parseFloat(D.currentAverageInput.value);
            const finalWeight = parseFloat(D.finalWeightPercentageInput.value);
            const targetGrade = parseFloat(D.targetFinalGradeInput.value);

            if (isNaN(currentAvg) || isNaN(finalWeight) || isNaN(targetGrade)) {
                showToast('Please enter valid numbers for all fields.', 'error');
                return;
            }
            if (currentAvg < 0 || currentAvg > 100 || finalWeight < 0 || finalWeight > 100 || targetGrade < 0 || targetGrade > 100) {
                showToast('Percentages should be between 0 and 100.', 'error');
                return;
            }

            const currentContribution = currentAvg * (100 - finalWeight) / 100;
            const remainingNeeded = targetGrade - currentContribution;

            if (finalWeight === 0) {
                if (currentAvg >= targetGrade) {
                    D.finalPredictorResult.querySelector('span').textContent = `N/A (Target already met/exceeded)`;
                } else {
                    D.finalPredictorResult.querySelector('span').textContent = `Impossible (Final has 0% weight)`;
                }
            } else {
                const finalScoreNeeded = remainingNeeded / (finalWeight / 100);
                D.finalPredictorResult.querySelector('span').textContent = `${Math.max(0, Math.min(100, finalScoreNeeded)).toFixed(2)}%`;
            }
            D.finalPredictorResult.style.display = 'block';
        }


        function renderAcademicPlannerContent() {
            D.plannerContentPlan.style.display = 'none';
            D.plannerContentGpa.style.display = 'none';
            D.plannerContentPredictor.style.display = 'none';

            if (currentPlannerTab === 'plan') {
                D.plannerContentPlan.style.display = 'block';
                D.coursePlannerDisplay.innerHTML = '';

                const years = ['9th Grade', '10th Grade', '11th Grade', '12th Grade'];
                const semesters = ['Fall', 'Spring', 'Full-Year'];

                const groupedCourses = plannerCourses.reduce((acc, course) => {
                    if (!acc[course.year]) acc[course.year] = {};
                    if (!acc[course.year][course.semester]) acc[course.year][course.semester] = [];
                    acc[course.year][course.semester].push(course);
                    return acc;
                }, {});

                if (plannerCourses.length === 0) {
                     D.coursePlannerDisplay.innerHTML = '<p class="empty-message">No courses planned yet. Add one above! üéì</p>';
                     return;
                }

                let coursesRendered = false;

                years.forEach(yearName => {
                    const coursesInYearRaw = groupedCourses[yearName] || {};
                    const yearSemesters = Object.keys(coursesInYearRaw).sort((a,b) => semesters.indexOf(a) - semesters.indexOf(b));

                    if (yearSemesters.length > 0) {
                        const yearDiv = document.createElement('div');
                        yearDiv.className = 'year-section';
                        yearDiv.innerHTML = `<h3>${yearName}</h3>`;

                        const semesterFragment = document.createDocumentFragment();

                        yearSemesters.forEach(semesterName => {
                            const coursesInSemester = coursesInYearRaw[semesterName].sort((a,b) => a.name.localeCompare(b.name));
                            if (coursesInSemester.length > 0) {
                                coursesRendered = true;
                                const semesterDiv = document.createElement('div');
                                semesterDiv.className = 'semester-section';
                                semesterDiv.innerHTML = `<h4>${semesterName}</h4>`;
                                const courseListUl = document.createElement('ul');
                                courseListUl.className = 'planner-course-list';

                                coursesInSemester.forEach(course => {
                                    const li = document.createElement('li');
                                    li.className = 'planner-course-item';
                                    li.dataset.courseId = course.id;
                                    li.addEventListener('click', () => openCourseGradesModal(course.id));

                                    const courseInfoDiv = document.createElement('div');
                                    courseInfoDiv.className = 'course-info';
                                    courseInfoDiv.innerHTML = `
                                        <div class="course-name">${course.name}</div>
                                        <div class="course-details">
                                            <span class="course-level">${course.level}</span>
                                            <span>${course.credits} Credits</span>
                                            <span>${course.subject}</span>
                                        </div>
                                    `;

                                    const statusSpan = document.createElement('span');
                                    statusSpan.className = 'course-status';
                                    statusSpan.textContent = course.status;
                                    statusSpan.dataset.status = course.status;
                                    courseInfoDiv.querySelector('.course-details').appendChild(statusSpan);


                                    const gradeDisplay = document.createElement('span');
                                    gradeDisplay.className = 'course-grade';
                                    if (typeof course.grades.semesterAvg === 'number') {
                                        const finalLetterGrade = getLetterFromPercentage(course.grades.semesterAvg);
                                        gradeDisplay.textContent = `${finalLetterGrade} (${course.grades.semesterAvg.toFixed(1)}%)`;
                                    } else {
                                        gradeDisplay.textContent = 'N/A';
                                    }
                                    courseInfoDiv.appendChild(gradeDisplay);


                                    const actionsDiv = document.createElement('div');
                                    actionsDiv.className = 'course-actions';
                                    const deleteBtn = document.createElement('button');
                                    deleteBtn.innerHTML = 'üóëÔ∏è';
                                    deleteBtn.title = 'Delete Course';
                                    deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deletePlannerCourse(course.id); });
                                    actionsDiv.appendChild(deleteBtn);

                                    li.appendChild(courseInfoDiv);
                                    li.appendChild(actionsDiv);
                                    courseListUl.appendChild(li);
                                });
                                semesterDiv.appendChild(courseListUl);
                                semesterFragment.appendChild(semesterDiv);
                            }
                        });
                        if (semesterFragment.hasChildNodes()) {
                            yearDiv.appendChild(semesterFragment);
                            D.coursePlannerDisplay.appendChild(yearDiv);
                        }
                    }
                });

                if (!coursesRendered) {
                    D.coursePlannerDisplay.innerHTML = '<p class="empty-message">No courses planned yet. Add one above! üéì</p>';
                }


            } else if (currentPlannerTab === 'gpa') {
                D.plannerContentGpa.style.display = 'block';
                renderGPA();
            } else if (currentPlannerTab === 'predictor') {
                D.plannerContentPredictor.style.display = 'block';
                D.finalPredictorResult.style.display = 'none';
            }
        }

        function setActivePlannerTab(tabName) {
            D.plannerTabPlan.classList.remove('active');
            D.plannerTabGpa.classList.remove('active');
            D.plannerTabPredictor.classList.remove('active');

            D.plannerTabPlan.setAttribute('aria-selected', 'false');
            D.plannerTabGpa.setAttribute('aria-selected', 'false');
            D.plannerTabPredictor.setAttribute('aria-selected', 'false');

            if (tabName === 'plan') {
                D.plannerTabPlan.classList.add('active');
                D.plannerTabPlan.setAttribute('aria-selected', 'true');
            } else if (tabName === 'gpa') {
                D.plannerTabGpa.classList.add('active');
                D.plannerTabGpa.setAttribute('aria-selected', 'true');
            } else if (tabName === 'predictor') {
                D.plannerTabPredictor.classList.add('active');
                D.plannerTabPredictor.setAttribute('aria-selected', 'true');
            }
            currentPlannerTab = tabName;
            renderAcademicPlannerContent();
        }

        function setActiveGPAType(type) {
            D.gpaTypeUnweightedBtn.classList.remove('active');
            D.gpaTypeWeightedBtn.classList.remove('active');

            D.gpaTypeUnweightedBtn.setAttribute('aria-selected', 'false');
            D.gpaTypeWeightedBtn.setAttribute('aria-selected', 'false');

            if (type === 'unweighted') {
                D.gpaTypeUnweightedBtn.classList.add('active');
                D.gpaTypeUnweightedBtn.setAttribute('aria-selected', 'true');
            } else {
                D.gpaTypeWeightedBtn.classList.add('active');
                D.gpaTypeWeightedBtn.setAttribute('aria-selected', 'true');
            }
            currentGPAType = type;
            renderGPA();
        }

        function createInitialData() {
            if (!AppStorage.load(CLASSES_STORAGE_KEY) || (AppStorage.load(CLASSES_STORAGE_KEY).length === 0)) {
                showLoadingOverlay();

                classes.push(
                    { id: Date.now(), name: "Math", color: "#61a8dc", order: 0, archived: false, description: "Calculus I", instructor: "Prof. Al Gorithm", schedule: "MWF 10-11 AM", location: "Online" },
                    { id: Date.now() + 1, name: "History", color: "#a5d862", order: 1, archived: false, description: "World History", instructor: "Ms. Chronicles", schedule: "TTh 2-3:30 PM", location: "Room 301" },
                    { id: Date.now() + 2, name: "Science", color: "#d177d1", order: 2, archived: false, description: "Biology I", instructor: "Dr. Gene Splice", schedule: "M 1-3 PM Lab", location: "Lab C" }
                );
                normalizeClassOrder();
                const now = new Date();
                const tomorrow = new Date(now); tomorrow.setDate(now.getDate() + 1);
                const nextWeek = new Date(now); nextWeek.setDate(now.getDate() + 7);
                const lastWeek = new Date(now); lastWeek.setDate(now.getDate() - 7);

                assignments.push(
                    { id: Date.now() + 10, text: "Read Chapter 5", class: "History", dueDate: tomorrow.toISOString().slice(0, 10), completed: false, order: null, priority: "Medium", status: "To Do", type: "Homework", notes: "Focus on section 5.2", subtasks: [] },
                    { id: Date.now() + 11, text: "Math Quiz", class: "Math", dueDate: tomorrow.toISOString().slice(0, 10), completed: false, order: null, priority: "High", status: "To Do", type: "Test", notes: "Review functions and limits from chapters 1-3", subtasks: [{id: 1, text: "Reread notes", completed: false}, {id:2, text: "Do practice problems", completed: false}, {id:3, text: "Review last week's solutions", completed: false}] },
                    { id: Date.now() + 12, text: "Lab Report 1", class: "Science", dueDate: nextWeek.toISOString().slice(0, 10), completed: false, order: null, priority: "Medium", status: "In Progress", type: "Project", notes: "Collect data for experiment, due next Monday", subtasks: [] },
                    { id: Date.now() + 13, text: "Final Essay", class: "History", dueDate: null, completed: false, order: null, priority: "Low", status: "To Do", type: "Project", notes: "Start research on historical figures", subtasks: [] },
                    { id: Date.now() + 14, text: "Completed Homework", class: "Math", dueDate: lastWeek.toISOString().slice(0, 10), completed: true, order: null, priority: "Low", status: "Completed", type: "Homework", notes: "Already submitted.", subtasks: [] }
                );

                const currentYear = new Date().getFullYear();
                plannerCourses.push(
                     { id: Date.now() + 20, name: "AP English Language", year: "11th Grade", semester: "Full-Year", level: "AP", credits: 1.0, subject: "English", grades: { q1: 95, q2: 92, q3: 93, q4: 90, midterm: 91, final: 94, semesterAvg: 92.5 }, finalGradeOverride: false, status: 'Completed' },
                     { id: Date.now() + 21, name: "Honors Chemistry", year: "11th Grade", semester: "Full-Year", level: "Honors", credits: 1.0, subject: "Science", grades: { q1: 88, q2: 90, q3: 87, q4: 89, midterm: 85, final: null, semesterAvg: null }, finalGradeOverride: false, status: 'In Progress' },
                     { id: Date.now() + 22, name: "Precalculus", year: "10th Grade", semester: "Full-Year", level: "Standard", credits: 1.0, subject: "Math", grades: { q1: 78, q2: 81, q3: 79, q4: 75, midterm: 77, final: 75, semesterAvg: 77.5 }, finalGradeOverride: false, status: 'Completed' },
                     { id: Date.now() + 23, name: "World History II", year: "10th Grade", semester: "Spring", level: "Standard", credits: 0.5, subject: "Social Studies", grades: { q1: null, q2: null, q3: null, q4: null, midterm: null, final: null, semesterAvg: 85.5 }, finalGradeOverride: true, status: 'Completed' },
                );

                saveClasses();
                saveAssignments();
                savePlannerCourses();
                AppStorage.save(THEME_STORAGE_KEY, document.body.classList.contains('dark') ? 'dark' : 'light');
                AppStorage.save(BACKGROUND_STORAGE_KEY, DEFAULT_BG_URL);

                setTimeout(() => {
                    hideLoadingOverlay();
                    showToast('Welcome! Some demo data has been loaded. Feel free to explore and customize!', 'info', 5000);
                }, 1000);
            }
        }

        function loadSettings() {
            const savedSettings = AppStorage.load(SETTINGS_STORAGE_KEY);
            appSettings = { ...DEFAULT_SETTINGS, ...savedSettings };
            
            if (savedSettings && savedSettings.customColors) {
                 appSettings.customColors = { ...DEFAULT_SETTINGS.customColors, ...savedSettings.customColors };
            }
             if (savedSettings && savedSettings.customGpaPoints) {
                 appSettings.customGpaPoints = { ...DEFAULT_SETTINGS.customGpaPoints, ...savedSettings.customGpaPoints };
             }
             if (savedSettings && savedSettings.defaultGradeWeights) {
                 appSettings.defaultGradeWeights = { ...DEFAULT_SETTINGS.defaultGradeWeights, ...savedSettings.defaultGradeWeights };
             }

            applySettings();
        }

        function saveSettings() {
            AppStorage.save(SETTINGS_STORAGE_KEY, appSettings);
            applySettings();
            showToast('Settings saved!', 'success');
        }

        function applySettings() {
            document.documentElement.style.setProperty('--custom-accent-color', appSettings.customColors.accent);
            document.documentElement.style.setProperty('--custom-primary-bg', appSettings.customColors.primaryBg);
            document.documentElement.style.setProperty('--custom-secondary-bg', appSettings.customColors.secondaryBg);
            document.documentElement.style.setProperty('--custom-text-color', appSettings.customColors.textColor);

            document.documentElement.style.setProperty('--custom-font-family', appSettings.fontFamily);

            document.body.classList.remove('compact', 'normal', 'spacious');
            document.body.classList.add(appSettings.layoutDensity);

            if (D.settingAccentColor) D.settingAccentColor.value = appSettings.customColors.accent;
            if (D.settingPrimaryBg) D.settingPrimaryBg.value = appSettings.customColors.primaryBg;
            if (D.settingSecondaryBg) D.settingSecondaryBg.value = appSettings.customColors.secondaryBg;
            if (D.settingTextColor) D.settingTextColor.value = appSettings.customColors.textColor;

            if (D.themePresetSelect) {
                const isCustomColorMatch = Object.keys(THEME_PRESETS).find(key => {
                    const preset = THEME_PRESETS[key];
                    return preset.accent === appSettings.customColors.accent &&
                           preset.primaryBg === appSettings.customColors.primaryBg &&
                           preset.secondaryBg === appSettings.customColors.secondaryBg &&
                           preset.textColor === appSettings.customColors.textColor;
                });
                D.themePresetSelect.value = isCustomColorMatch || 'default';
            }


            if (D.settingFontFamily) D.settingFontFamily.value = appSettings.fontFamily;
            if (D.densityCompact) D.densityCompact.checked = appSettings.layoutDensity === 'compact';
            if (D.densityNormal) D.densityNormal.checked = appSettings.layoutDensity === 'normal';
            if (D.densitySpacious) D.densitySpacious.checked = appSettings.layoutDensity === 'spacious';
            if (D.settingDefaultView) D.settingDefaultView.value = appSettings.defaultView;
            if (D.settingEnableToasts) D.settingEnableToasts.checked = appSettings.enableToasts;
            if (D.settingConfirmDelete) D.settingConfirmDelete.checked = appSettings.confirmDelete;
            if (D.settingDateFormat) D.settingDateFormat.value = appSettings.dateFormat;
            if (D.settingShowUncategorized) D.settingShowUncategorized.checked = appSettings.showUncategorized;
            
            if (D.gpaScaleFcps) D.gpaScaleFcps.checked = appSettings.gpaScale === 'fcps';
            if (D.gpaScaleCustom) D.gpaScaleCustom.checked = appSettings.gpaScale === 'custom';
            toggleCustomGpaEditor(appSettings.gpaScale === 'custom');

            for (const grade in appSettings.customGpaPoints) {
                const inputIdKey = grade.replace('+', 'p').replace('-', 'm');
                const inputElement = document.getElementById(`custom-gpa-${inputIdKey}`);
                if (inputElement) inputElement.value = appSettings.customGpaPoints[grade];
            }

            for (const component in appSettings.defaultGradeWeights) {
                 const inputId = `default-weight-${component}`;
                 const inputElement = document.getElementById(inputId);
                 if (inputElement) inputElement.value = appSettings.defaultGradeWeights[component];
            }

            if (currentView === 'list') renderAssignmentsList();
            if (currentView === 'calendar') renderCalendar();
            if (currentView === 'planner') renderAcademicPlannerContent();
            if (currentView === 'classes') renderClassList();
        }

        function toggleCustomGpaEditor(show) {
            if (D.customGpaScaleEditor) {
                D.customGpaScaleEditor.style.display = show ? 'block' : 'none';
            }
        }

        function setActiveSettingsTab(tabName) {
            D.settingsTabAppearance.classList.remove('active');
            D.settingsTabBehavior.classList.remove('active');
            D.settingsTabGrading.classList.remove('active');
            D.settingsTabData.classList.remove('active');

            D.settingsTabAppearance.setAttribute('aria-selected', 'false');
            D.settingsTabBehavior.setAttribute('aria-selected', 'false');
            D.settingsTabGrading.setAttribute('aria-selected', 'false');
            D.settingsTabData.setAttribute('aria-selected', 'false');

            D.settingsContentAppearance.style.display = 'none';
            D.settingsContentBehavior.style.display = 'none';
            D.settingsContentGrading.style.display = 'none';
            D.settingsContentData.style.display = 'none';

            if (tabName === 'appearance') {
                D.settingsTabAppearance.classList.add('active');
                D.settingsTabAppearance.setAttribute('aria-selected', 'true');
                D.settingsContentAppearance.style.display = 'block';
            } else if (tabName === 'behavior') {
                D.settingsTabBehavior.classList.add('active');
                D.settingsTabBehavior.setAttribute('aria-selected', 'true');
                D.settingsContentBehavior.style.display = 'block';
            } else if (tabName === 'grading') {
                D.settingsTabGrading.classList.add('active');
                D.settingsTabGrading.setAttribute('aria-selected', 'true');
                D.settingsContentGrading.style.display = 'block';
            } else if (tabName === 'data') {
                D.settingsTabData.classList.add('active');
                D.settingsTabData.setAttribute('aria-selected', 'true');
                D.settingsContentData.style.display = 'block';
            }
            currentSettingsTab = tabName;
        }

        D.exportDataBtn.addEventListener('click', () => {
            showLoadingOverlay();
            setTimeout(() => {
                try {
                    const data = {
                        classes: classes,
                        assignments: assignments,
                        plannerCourses: plannerCourses,
                        settings: appSettings,
                        background: AppStorage.load(BACKGROUND_STORAGE_KEY),
                        theme: AppStorage.load(THEME_STORAGE_KEY),
                    };
                    const dataStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `monkey_tracker_data_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('Data exported successfully!', 'success');
                } catch (e) {
                    console.error('Error during data export:', e);
                    showToast('Failed to export data.', 'error');
                } finally {
                    hideLoadingOverlay();
                }
            }, 100);
        });

        D.importDataFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            if (file.type !== 'application/json') {
                showToast('Please select a JSON file.', 'error');
                return;
            }

            let confirmProceed = true;
            if (appSettings.confirmDelete) confirmProceed = confirm('Importing data will overwrite ALL your current data. Are you sure?');

            if (!confirmProceed) {
                D.importDataFile.value = '';
                return;
            }

            showLoadingOverlay();
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);

                    if (importedData.classes && Array.isArray(importedData.classes)) {
                        classes = importedData.classes.map(c => ({
                             id: c.id || Date.now() + Math.random(),
                             name: c.name || 'Unnamed Class',
                             color: c.color || DEFAULT_CLASS_COLOR,
                             order: c.order,
                             archived: c.archived || false,
                             description: c.description || '',
                             instructor: c.instructor || '',
                             schedule: c.schedule || '',
                             location: c.location || ''
                         }));
                        normalizeClassOrder();
                        saveClasses();
                    } else {
                        showToast('Invalid classes data in file. Classes not imported.', 'error');
                    }

                    if (importedData.assignments && Array.isArray(importedData.assignments)) {
                        assignments = importedData.assignments.map(a => ({
                            id: a.id || Date.now() + Math.random(),
                            text: a.text || 'Untitled Task',
                            class: a.class || UNCAT_CLASS_NAME,
                            dueDate: a.dueDate || null,
                            completed: a.completed || false,
                            archived: a.archived || false,
                            order: a.order === undefined ? null : a.order,
                            priority: a.priority || 'Medium',
                            status: a.status || 'To Do',
                            type: a.type || 'Homework',
                            notes: a.notes || '',
                            subtasks: a.subtasks || []
                        }));
                        saveAssignments();
                    } else {
                        showToast('Invalid assignments data in file. Assignments not imported.', 'error');
                    }

                    if (importedData.plannerCourses && Array.isArray(importedData.plannerCourses)) {
                        plannerCourses = importedData.plannerCourses.map(course => ({
                             id: course.id || Date.now() + Math.random(),
                             name: course.name,
                             year: course.year,
                             semester: course.semester,
                             level: course.level,
                             credits: course.credits,
                             subject: course.subject,
                             grades: course.grades || { q1: null, q2: null, q3: null, q4: null, midterm: null, final: null, semesterAvg: null },
                             finalGradeOverride: course.finalGradeOverride || false,
                             status: course.status || 'Planned'
                        }));
                        savePlannerCourses();
                    } else {
                         showToast('Invalid planner courses data in file. Planner data not imported.', 'error');
                    }

                    if (importedData.settings) {
                        appSettings = { ...DEFAULT_SETTINGS, ...importedData.settings };
                        if (importedData.settings.customColors) appSettings.customColors = { ...DEFAULT_SETTINGS.customColors, ...importedData.settings.customColors };
                        if (importedData.settings.customGpaPoints) appSettings.customGpaPoints = { ...DEFAULT_SETTINGS.customGpaPoints, ...importedData.settings.customGpaPoints };
                        if (importedData.settings.defaultGradeWeights) appSettings.defaultGradeWeights = { ...DEFAULT_SETTINGS.defaultGradeWeights, ...importedData.settings.defaultGradeWeights };
                        saveSettings();
                    }

                    if (importedData.background) {
                        document.body.style.backgroundImage = `url(${importedData.background})`;
                        document.body.classList.add('has-background');
                        AppStorage.save(BACKGROUND_STORAGE_KEY, importedData.background);
                    } else {
                         document.body.style.backgroundImage = `url(${DEFAULT_BG_URL})`;
                         document.body.classList.add('has-background');
                         AppStorage.save(BACKGROUND_STORAGE_KEY, DEFAULT_BG_URL);
                    }

                    if (importedData.theme) {
                         document.body.classList.toggle('dark', importedData.theme === 'dark');
                         AppStorage.save(THEME_STORAGE_KEY, importedData.theme);
                    } else {
                         document.body.classList.toggle('dark', window.matchMedia('(prefers-color-scheme: dark)').matches);
                         AppStorage.save(THEME_STORAGE_KEY, document.body.classList.contains('dark') ? 'dark' : 'light');
                    }

                    showToast('Data imported successfully!', 'success');
                    navigate(currentView, currentPlannerTab);
                } catch (e) {
                    console.error('Error parsing imported data:', e);
                    showToast('Failed to parse imported data. Please ensure it\'s valid JSON.', 'error');
                } finally {
                    hideLoadingOverlay();
                }
            };
            reader.readAsText(file);
            D.importDataFile.value = '';
        });

        D.addClassBtn.addEventListener('click', addNewClass);
        D.newClassNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewClass(); });

        D.quickAddBtn.addEventListener('click', () => {
             const quickText = D.quickAddTextInput.value.trim();
             if (quickText === '') {
                 showToast('Please enter a description for the quick task.', 'error');
                 D.quickAddTextInput.focus();
                 return;
             }
             let uncategorizedClass = classes.find(c => c.id === 'uncategorized');
             if (!uncategorizedClass || uncategorizedClass.archived) {
                if (uncategorizedClass) {
                    uncategorizedClass.archived = false;
                    saveClasses();
                } else {
                    classes.push({ id: 'uncategorized', name: UNCAT_CLASS_NAME, color: '#cccccc', order: classes.length, archived: false, description: 'Tasks that are not assigned to a specific class.', instructor: '', schedule: '', location: '' });
                    normalizeClassOrder();
                    saveClasses();
                }
             }
             addAssignment(quickText, UNCAT_CLASS_NAME, '', 'Medium', 'To Do', 'Homework');
        });
        D.quickAddTextInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') D.quickAddBtn.click(); });


        D.addAssignmentBtn.addEventListener('click', () => addAssignment(D.assignmentTextInput.value, D.assignmentClassSelect.value, D.assignmentDueDateInput.value, D.assignmentPrioritySelect.value, D.assignmentStatusSelect.value, D.assignmentTypeSelect.value));
        [D.assignmentTextInput, D.assignmentDueDateInput].forEach(input => {
             input.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                     if (D.assignmentTextInput.value.trim() !== '' && D.assignmentClassSelect.value !== '') {
                         D.addAssignmentBtn.click();
                     } else if (D.assignmentTextInput.value.trim() === '') {
                         showToast('Need description for task.', 'error');
                         D.assignmentTextInput.focus();
                     } else {
                         showToast('Need class for task.', 'error');
                         D.assignmentClassSelect.focus();
                     }
                 }
             });
        });

        flatpickr(D.assignmentDueDateInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });
        flatpickr(D.detailsAssignmentDueDate, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        D.viewListBtn.addEventListener('click', () => navigate('list'));
        D.viewCalendarBtn.addEventListener('click', () => navigate('calendar'));

        D.prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
        D.nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });

        D.themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            AppStorage.save(THEME_STORAGE_KEY, document.body.classList.contains('dark') ? 'dark' : 'light');
        });

        D.navList.addEventListener('click', () => navigate('list'));
        D.navCalendar.addEventListener('click', () => navigate('calendar'));
        D.navClasses.addEventListener('click', () => navigate('classes'));
        D.navPlanner.addEventListener('click', () => navigate('planner', 'plan'));
        D.navArchived.addEventListener('click', () => navigate('archived'));
        D.navSettings.addEventListener('click', () => navigate('settings', null, 'appearance'));

        D.searchInput.addEventListener('input', () => renderAssignmentsList());
        D.sortBySelect.addEventListener('change', () => renderAssignmentsList());
        D.filterStatusSelect.addEventListener('change', () => renderAssignmentsList());
        D.filterPrioritySelect.addEventListener('change', () => renderAssignmentsList());
        D.filterTypeSelect.addEventListener('change', () => renderAssignmentsList());
        D.hideCompletedCheckbox.addEventListener('change', () => renderAssignmentsList());

        D.plannerTabPlan.addEventListener('click', () => setActivePlannerTab('plan'));
        D.plannerTabGpa.addEventListener('click', () => setActivePlannerTab('gpa'));
        D.plannerTabPredictor.addEventListener('click', () => setActivePlannerTab('predictor'));

        D.addPlannerCourseBtn.addEventListener('click', addPlannerCourse);
        D.newCourseNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addPlannerCourse(); });
        D.newCourseSubjectInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addPlannerCourse(); });

        D.gpaTypeUnweightedBtn.addEventListener('click', () => setActiveGPAType('unweighted'));
        D.gpaTypeWeightedBtn.addEventListener('click', () => setActiveGPAType('weighted'));

        D.calculateFinalBtn.addEventListener('click', calculateFinalNeeded);
        D.currentAverageInput.addEventListener('input', () => {D.finalPredictorResult.style.display = 'none';});
        D.finalWeightPercentageInput.addEventListener('input', () => {D.finalPredictorResult.style.display = 'none';});
        D.targetFinalGradeInput.addEventListener('input', () => {D.finalPredictorResult.style.display = 'none';});

        D.gradeFormatPercent.addEventListener('change', (e) => {
            if (e.target.checked) {
                currentGradeFormat = 'percent';
                const currentCourse = plannerCourses.find(c => c.id === currentEditingPlannerCourseId);
                renderGradeInputs(currentCourse.grades, 'percent');
                updateCalculatedAverageDisplay();
            }
        });
        D.gradeFormatLetter.addEventListener('change', (e) => {
            if (e.target.checked) {
                currentGradeFormat = 'letter';
                const currentCourse = plannerCourses.find(c => c.id === currentEditingPlannerCourseId);
                renderGradeInputs(currentCourse.grades, 'letter');
                updateCalculatedAverageDisplay();
            }
        });

        D.settingsTabAppearance.addEventListener('click', () => setActiveSettingsTab('appearance'));
        D.settingsTabBehavior.addEventListener('click', () => setActiveSettingsTab('behavior'));
        D.settingsTabGrading.addEventListener('click', () => setActiveSettingsTab('grading'));
        D.settingsTabData.addEventListener('click', () => setActiveSettingsTab('data'));

        D.settingAccentColor.addEventListener('input', (e) => { appSettings.customColors.accent = e.target.value; saveSettings(); });
        D.settingPrimaryBg.addEventListener('input', (e) => { appSettings.customColors.primaryBg = e.target.value; saveSettings(); });
        D.settingSecondaryBg.addEventListener('input', (e) => { appSettings.customColors.secondaryBg = e.target.value; saveSettings(); });
        D.settingTextColor.addEventListener('input', (e) => { appSettings.customColors.textColor = e.target.value; saveSettings(); });
        D.resetColorsBtn.addEventListener('click', () => { 
            let confirmProceed = true;
            if (appSettings.confirmDelete) confirmProceed = confirm('Are you sure you want to reset all custom colors to default?');
            if (confirmProceed) {
                appSettings.customColors = { ...DEFAULT_SETTINGS.customColors }; 
                saveSettings();
            }
        });
        D.themePresetSelect.addEventListener('change', (e) => {
             const presetName = e.target.value;
             if (THEME_PRESETS[presetName]) {
                 appSettings.customColors = { ...THEME_PRESETS[presetName] };
                 saveSettings();
             }
        });

        D.settingFontFamily.addEventListener('change', (e) => { appSettings.fontFamily = e.target.value; saveSettings(); });
        document.querySelectorAll('input[name="layout-density"]').forEach(radio => {
            radio.addEventListener('change', (e) => { appSettings.layoutDensity = e.target.value; saveSettings(); });
        });
        D.settingDefaultView.addEventListener('change', (e) => { appSettings.defaultView = e.target.value; saveSettings(); });
        D.settingEnableToasts.addEventListener('change', (e) => { appSettings.enableToasts = e.target.checked; saveSettings(); });
        D.settingConfirmDelete.addEventListener('change', (e) => { appSettings.confirmDelete = e.target.checked; saveSettings(); });
        D.settingDateFormat.addEventListener('change', (e) => { appSettings.dateFormat = e.target.value; saveSettings(); navigate(currentView); });
        D.settingShowUncategorized.addEventListener('change', (e) => { appSettings.showUncategorized = e.target.checked; saveSettings(); navigate(currentView); });


        D.gpaScaleFcps.addEventListener('change', (e) => {
             appSettings.gpaScale = 'fcps'; 
             toggleCustomGpaEditor(false); 
             saveSettings();
             renderAcademicPlannerContent();
         });
        D.gpaScaleCustom.addEventListener('change', (e) => {
             appSettings.gpaScale = 'custom'; 
             toggleCustomGpaEditor(true); 
             saveSettings();
             renderAcademicPlannerContent();
         });

        for (const grade of Object.keys(DEFAULT_SETTINGS.customGpaPoints)) {
             const inputIdKey = grade.replace('+', 'p').replace('-', 'm');
             const inputElement = document.getElementById(`custom-gpa-${inputIdKey}`);
             if (inputElement) {
                 inputElement.addEventListener('input', (e) => {
                     let value = parseFloat(e.target.value);
                     if (isNaN(value) || value < 0) value = 0;
                     if (value > 4.0) value = 4.0;
                     appSettings.customGpaPoints[grade] = value;
                     saveSettings();
                 });
             }
         }

        for (const component of Object.keys(DEFAULT_SETTINGS.defaultGradeWeights)) {
             const inputId = `default-weight-${component}`;
             const inputElement = document.getElementById(inputId);
             if (inputElement) {
                 inputElement.addEventListener('input', (e) => {
                     let value = parseInt(e.target.value);
                     if (isNaN(value) || value < 0) value = 0;
                     if (value > 100) value = 100;
                     appSettings.defaultGradeWeights[component] = value;
                     saveSettings();
                 });
             }
        }
        D.autoAllocateWeightsBtn.addEventListener('click', () => {
             const componentNames = ['q1','q2','q3','q4','midterm','final'];
             let activeComponents = 0;
             let sumOfCurrentWeights = 0;

             // Find currently active components and sum up their current valid weights.
             // Any blank or non-numeric (or <= 0) are considered inactive/to-be-zeroed for distribution.
             const tempWeights = {};
             componentNames.forEach(c => {
                 const inputEl = document.getElementById(`default-weight-${c}`);
                 const inputVal = parseInt(inputEl.value);

                 if (!isNaN(inputVal) && inputVal > 0) {
                     activeComponents++;
                     sumOfCurrentWeights += inputVal;
                     tempWeights[c] = inputVal; // Keep current valid weight
                 } else {
                     tempWeights[c] = 0; // Mark for zeroing if not active
                 }
             });

             if (activeComponents === 0) {
                 showToast('No valid grade components defined for auto-allocation! Ensure values are non-negative and positive.', 'error');
                 return;
             }
            
            const totalRemainingToDistribute = 100;
            const weightPerComponent = Math.floor(totalRemainingToDistribute / activeComponents);
            let distributedSum = 0;

            componentNames.forEach(c => {
                const inputEl = document.getElementById(`default-weight-${c}`);
                if (tempWeights[c] > 0) { // If it was an active component
                    appSettings.defaultGradeWeights[c] = weightPerComponent;
                    distributedSum += weightPerComponent;
                } else { // Inactive components are explicitly set to 0
                    appSettings.defaultGradeWeights[c] = 0;
                }
            });

            // Adjust any remainder from floor division
            if (distributedSum !== totalRemainingToDistribute && activeComponents > 0) {
                // Add remainder to the first active component
                const firstActiveComponent = componentNames.find(c => tempWeights[c] > 0);
                if (firstActiveComponent) {
                    appSettings.defaultGradeWeights[firstActiveComponent] += (totalRemainingToDistribute - distributedSum);
                }
            }

             saveSettings();
             renderAcademicPlannerContent(); // Re-render content inside GPA calc to reflect weights
             showToast('Weights auto-allocated evenly!', 'info');
         });

        D.resetWeightsBtn.addEventListener('click', () => {
            let confirmProceed = true;
            if (appSettings.confirmDelete) confirmProceed = confirm('Reset default grade component weights to application defaults?');
            if (confirmProceed) {
                appSettings.defaultGradeWeights = { ...DEFAULT_SETTINGS.defaultGradeWeights };
                saveSettings();
                renderAcademicPlannerContent();
            }
        });

        D.bgUploadInput.addEventListener('change', (e) => {
             const file = e.target.files[0];
             if (file) {
                 const reader = new FileReader();
                 reader.onload = (event) => {
                     const bgUrl = event.target.result;
                     document.body.style.backgroundImage = `url(${bgUrl})`;
                     document.body.classList.add('has-background');
                     AppStorage.save(BACKGROUND_STORAGE_KEY, bgUrl);
                     showToast('Custom background uploaded!', 'success');
                 };
                 reader.readAsDataURL(file);
             }
         });
         D.removeBgBtn.addEventListener('click', () => {
            let confirmProceed = true;
            if (appSettings.confirmDelete) confirmProceed = confirm('Remove current background image?');
            if (!confirmProceed) return;

             document.body.style.backgroundImage = `url(${DEFAULT_BG_URL})`;
             document.body.classList.add('has-background');
             AppStorage.save(BACKGROUND_STORAGE_KEY, DEFAULT_BG_URL);
             showToast('Background reset to default.', 'info');
         });


        document.addEventListener('DOMContentLoaded', () => {
            // Check saved theme or system preference for initial theme
            const savedTheme = AppStorage.load(THEME_STORAGE_KEY);
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark');
            }

            loadSettings(); // Load custom app settings FIRST
            
            // Load and apply background image
            const savedBackground = AppStorage.load(BACKGROUND_STORAGE_KEY);
            if (savedBackground) {
                document.body.style.backgroundImage = `url(${savedBackground})`;
                document.body.classList.add('has-background');
            } else {
               document.body.style.backgroundImage = `url(${DEFAULT_BG_URL})`;
               document.body.classList.add('has-background');
               AppStorage.save(BACKGROUND_STORAGE_KEY, DEFAULT_BG_URL); // Save default image to storage if not present
            }

            // Load application data (classes, assignments, planner courses)
            loadClasses();
            loadAssignments();
            loadPlannerCourses();
            // Create initial data if no data exists
            createInitialData();

            // Navigate to default view based on settings
            navigate(appSettings.defaultView);

            // Global drag & drop event listeners for reordering classes
            document.body.addEventListener('dragover', handleClassDragOver);
            document.body.addEventListener('drop', handleClassDrop);
            document.body.addEventListener('dragleave', handleClassDragLeave); // Ensure comprehensive leave logic
        });
    </script>

</body>
</html>